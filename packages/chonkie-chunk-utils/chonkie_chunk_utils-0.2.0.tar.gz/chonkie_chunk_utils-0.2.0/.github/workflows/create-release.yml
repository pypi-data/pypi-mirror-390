name: Create GitHub Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.2.0)'
        required: true
        type: string
      title:
        description: 'Release title (optional, defaults to "Release v{version}")'
        required: false
        type: string
      notes:
        description: 'Release notes (optional, auto-generated if not provided)'
        required: false
        type: string

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for git log analysis

      - name: Setup GitHub CLI
        uses: actions4gh/setup-gh@v1

      - name: Get version from input or pyproject.toml
        id: get-version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=$(grep -E '^version\s*=' pyproject.toml | sed -E 's/version\s*=\s*["'\'']([^"'\'']+)["'\'']/\1/')
          fi
          
          # Remove 'v' prefix if present
          VERSION="${VERSION#v}"
          
          # Validate semantic version format
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Version must follow semantic versioning (X.Y.Z)"
            echo "Received: $VERSION"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Prepare release title
        id: prepare-title
        run: |
          if [ -n "${{ github.event.inputs.title }}" ]; then
            TITLE="${{ github.event.inputs.title }}"
          else
            TITLE="Release v${{ steps.get-version.outputs.version }}"
          fi
          echo "title=$TITLE" >> $GITHUB_OUTPUT

      - name: Prepare release notes
        id: prepare-notes
        run: |
          if [ -n "${{ github.event.inputs.notes }}" ]; then
            NOTES="${{ github.event.inputs.notes }}"
          else
            # Get previous version from git tags
            PREV_TAG=$(git tag --sort=-v:refname | head -n 1 || echo "")
            PREV_VERSION=$(echo "$PREV_TAG" | sed 's/^v//' || echo "")
            CURRENT_VERSION="${{ steps.get-version.outputs.version }}"
            
            # Build release notes header
            NOTES="## Release v$CURRENT_VERSION"$'\n\n'
            
            # Get commits since previous tag
            if [ -n "$PREV_TAG" ] && git rev-parse "$PREV_TAG" >/dev/null 2>&1; then
              COMMIT_RANGE="$PREV_TAG..HEAD"
              COMMIT_COUNT=$(git rev-list --count "$COMMIT_RANGE" 2>/dev/null || echo "0")
            else
              # If no previous tag, use last 20 commits
              COMMIT_RANGE="HEAD~20..HEAD"
              COMMIT_COUNT=$(git rev-list --count HEAD 2>/dev/null || echo "0")
            fi
            
            if [ "$COMMIT_COUNT" -gt "0" ]; then
              # Categorize commits by type (Conventional Commits)
              FEATURES=$(git log --no-merges --pretty=format:"- %s" "$COMMIT_RANGE" 2>/dev/null | grep -i "^-\s*feat:" | sed 's/^-\s*feat:\s*/- /' | head -20 || echo "")
              FIXES=$(git log --no-merges --pretty=format:"- %s" "$COMMIT_RANGE" 2>/dev/null | grep -i "^-\s*fix:" | sed 's/^-\s*fix:\s*/- /' | head -20 || echo "")
              REFACTORS=$(git log --no-merges --pretty=format:"- %s" "$COMMIT_RANGE" 2>/dev/null | grep -iE "^-\s*(refactor|perf):" | sed -E 's/^-\s*(refactor|perf):\s*/- /' | head -20 || echo "")
              DOCS=$(git log --no-merges --pretty=format:"- %s" "$COMMIT_RANGE" 2>/dev/null | grep -iE "^-\s*(docs|docs):" | sed -E 's/^-\s*(docs|docs):\s*/- /' | head -10 || echo "")
              OTHERS=$(git log --no-merges --pretty=format:"- %s" "$COMMIT_RANGE" 2>/dev/null | grep -vE "^-\s*(feat|fix|refactor|perf|docs|style|test|build|ci|chore):" | head -10 || echo "")
              
              # Build changelog sections
              if [ -n "$PREV_VERSION" ] && [ "$PREV_VERSION" != "unknown" ]; then
                NOTES+="Full Changelog: [\`v$PREV_VERSION\`...\`v$CURRENT_VERSION\`](https://github.com/${{ github.repository }}/compare/v$PREV_VERSION...v$CURRENT_VERSION)"$'\n\n'
              fi
              
              NOTES+="### What's Changed"$'\n\n'
              
              if [ -n "$FEATURES" ]; then
                NOTES+="#### ‚ú® Features"$'\n'
                echo "$FEATURES" | while IFS= read -r line; do
                  NOTES+="$line"$'\n'
                done
                NOTES+=$'\n'
              fi
              
              if [ -n "$FIXES" ]; then
                NOTES+="#### üêõ Bug Fixes"$'\n'
                echo "$FIXES" | while IFS= read -r line; do
                  NOTES+="$line"$'\n'
                done
                NOTES+=$'\n'
              fi
              
              if [ -n "$REFACTORS" ]; then
                NOTES+="#### üîß Refactoring & Performance"$'\n'
                echo "$REFACTORS" | while IFS= read -r line; do
                  NOTES+="$line"$'\n'
                done
                NOTES+=$'\n'
              fi
              
              if [ -n "$DOCS" ]; then
                NOTES+="#### üìö Documentation"$'\n'
                echo "$DOCS" | while IFS= read -r line; do
                  NOTES+="$line"$'\n'
                done
                NOTES+=$'\n'
              fi
              
              if [ -n "$OTHERS" ]; then
                NOTES+="#### üìù Other Changes"$'\n'
                echo "$OTHERS" | while IFS= read -r line; do
                  NOTES+="$line"$'\n'
                done
                NOTES+=$'\n'
              fi
            else
              NOTES+="No commits found for this release."$'\n\n'
            fi
            
            NOTES+="### Installation"$'\n'
            NOTES+='```bash'$'\n'
            NOTES+="pip install chonkie-chunk-utils==$CURRENT_VERSION"$'\n'
            NOTES+='```'$'\n'
            NOTES+=$'\n'
            NOTES+="**Full Changelog**: https://github.com/${{ github.repository }}/compare/v$PREV_VERSION...v$CURRENT_VERSION"
          fi
          # Use delimiter to preserve multi-line content
          {
            echo 'notes<<DELIMITER'
            echo "$NOTES"
            echo 'DELIMITER'
          } >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "v${{ steps.get-version.outputs.version }}" \
            --title "${{ steps.prepare-title.outputs.title }}" \
            --notes "${{ steps.prepare-notes.outputs.notes }}"

