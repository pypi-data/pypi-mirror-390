Metadata-Version: 2.4
Name: never-jscore
Version: 2.1.0
Classifier: Development Status :: 4 - Beta
Classifier: Intended Audience :: Developers
Classifier: License :: OSI Approved :: MIT License
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.8
Classifier: Programming Language :: Python :: 3.9
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Classifier: Programming Language :: Python :: 3.12
Classifier: Programming Language :: Python :: Implementation :: CPython
Classifier: Programming Language :: Rust
Classifier: Topic :: Software Development :: Libraries :: Python Modules
Classifier: Topic :: Software Development :: Interpreters
Classifier: Typing :: Typed
Summary: High-performance Python JavaScript execution engine based on Deno Core (V8) with full Promise/async support - py_mini_racer style API
Keywords: javascript,execjs,deno,v8,js,python,rust,promise,async,py_mini_racer
License: MIT
Requires-Python: >=3.8
Description-Content-Type: text/markdown; charset=UTF-8; variant=GFM
Project-URL: Homepage, https://github.com/neverl805/never-jscore
Project-URL: Repository, https://github.com/neverl805/never-jscore
Project-URL: Documentation, https://github.com/neverl805/never-jscore#readme
Project-URL: Bug Tracker, https://github.com/neverl805/never-jscore/issues

# never_jscore ä¸­æ–‡æ–‡æ¡£

åŸºäº Deno Core (V8) çš„é«˜æ€§èƒ½ Python JavaScript æ‰§è¡Œå¼•æ“ï¼Œ**ä¸“ä¸º JS é€†å‘å·¥ç¨‹ä¼˜åŒ–**ã€‚
åŠªåŠ›æˆä¸ºPyExecJSä¸Šä½æ›¿ä»£å“

## é¡¹ç›®ç‰¹ç‚¹

- âš¡ **æè‡´æ€§èƒ½**:
  - ä½¿ç”¨ Rust + Deno Core (V8 å¼•æ“)
  - å®ä¾‹åŒ– Context å¤ç”¨ä¼˜åŒ–
  - **æ¯” PyExecJS å¿« 100-300å€**
  - **ä¸ PyMiniRacer æ€§èƒ½ç›¸å½“ï¼Œéƒ¨åˆ†åœºæ™¯æ›´å¿«**
- ğŸ”„ **Promise/async æ”¯æŒ**:
  - å®Œæ•´æ”¯æŒ Promise å’Œ async/await
  - è‡ªåŠ¨ç­‰å¾…å¼‚æ­¥ç»“æœ
  - **å”¯ä¸€é«˜æ€§èƒ½ Promise æ–¹æ¡ˆ**ï¼ˆPyMiniRacer ä¸æ”¯æŒï¼‰
- ğŸŒ **å†…ç½® Web API æ‰©å±•** (v2.0+):
  - âœ… **Crypto APIs**: Base64 (btoa/atob)ã€MD5ã€SHA1/256/512ã€HMACã€Hex ç¼–è§£ç 
  - âœ… **URL ç¼–ç **: encodeURIComponentã€decodeURIComponentã€encodeURIã€decodeURI
  - âœ… **å®šæ—¶å™¨**: setTimeoutã€setIntervalï¼ˆç«‹å³æ‰§è¡Œç‰ˆæœ¬ï¼Œç”¨äº API æ£€æµ‹ï¼‰
  - âœ… **Web Workers**: Worker APIï¼ˆå•çº¿ç¨‹æ¨¡æ‹Ÿç‰ˆæœ¬ï¼Œç”¨äºå…¼å®¹æ£€æµ‹ï¼‰
  - âœ… **éšæœºæ•°**: crypto.randomUUID()ã€crypto.getRandomValues()
  - ğŸ¯ ä¸“ä¸º JS é€†å‘è®¾è®¡ï¼Œæ— éœ€é¢å¤– polyfill
- ğŸ“¦ **ä¸Šä¸‹æ–‡éš”ç¦»**: æ¯ä¸ª Context ç‹¬ç«‹çš„ V8 æ‰§è¡Œç¯å¢ƒï¼Œäº’ä¸å¹²æ‰°
- ğŸ¯ **py_mini_racer å…¼å®¹**: API è®¾è®¡ç±»ä¼¼ py_mini_racerï¼Œå®ä¾‹åŒ–ä½¿ç”¨
- ğŸ§¹ **è‡ªåŠ¨å†…å­˜ç®¡ç†**: åŸºäº Rust çš„è‡ªåŠ¨åƒåœ¾å›æ”¶ï¼Œæ— å†…å­˜æ³„æ¼
- ğŸ›¡ï¸ **ç±»å‹å®‰å…¨**: æä¾›å®Œæ•´çš„ç±»å‹æç¤ºï¼ˆ.pyi æ–‡ä»¶ï¼‰


## ç‰¹æ€§å¯¹æ¯”è¡¨

| ç‰¹æ€§ | never_jscore | PyExecJS | PyMiniRacer | js2py | dukpy |
|------|-----------|----------|-------------|-------|-------|
| å¼•æ“ | V8  | Node/V8ç­‰ | V8 | çº¯Python | Duktape |
| Promise | âœ… å®Œæ•´ | âŒ | âš ï¸ æœ‰é™ | âŒ | âŒ |
| async/await | âœ… | âŒ | âš ï¸ | âŒ | âŒ |
| æ€§èƒ½ | âš¡âš¡âš¡âš¡âš¡ | âš¡âš¡ | âš¡âš¡âš¡âš¡âš¡ | âš¡ | âš¡âš¡âš¡ |
| å®‰è£…éš¾åº¦ | ç®€å• | éœ€Node.js | ç®€å• | ç®€å• | ç®€å• |
| ä¸Šä¸‹æ–‡å¤ç”¨ | âœ… | âœ… | âœ… | âœ… | âœ… |
| ç±»å‹è½¬æ¢ | è‡ªåŠ¨ | è‡ªåŠ¨ | è‡ªåŠ¨ | è‡ªåŠ¨ | è‡ªåŠ¨ |
| ES6+ | âœ… å®Œæ•´ | âœ… | âœ… | âš ï¸ éƒ¨åˆ† | âš ï¸ éƒ¨åˆ† |

---

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆ PyMiniRacer åœ¨æŸäº›æµ‹è¯•ä¸­æ›´å¿«ï¼Ÿ
A: PyMiniRacer æ˜¯ V8 çš„ç›´æ¥ç»‘å®šï¼Œå¼€é”€æœ€å°ã€‚never_jscore ä½¿ç”¨ rustå¼€å‘ä»¥åŠDeno Coreï¼Œæœ‰è½»é‡çº§åŒ…è£…å±‚ï¼Œä½†æä¾›äº†æ›´å¤šåŠŸèƒ½ï¼ˆå¦‚ Promise æ”¯æŒï¼‰ã€‚

### Q: ä»€ä¹ˆæ—¶å€™é€‰æ‹© never_jscoreï¼Ÿ
A: å½“ä½ éœ€è¦:
- Promise/async æ”¯æŒï¼ˆç°ä»£ JS åº“ï¼‰
- é«˜æ€§èƒ½ + Rust ç¨³å®šæ€§
- æ‰¹é‡å‡½æ•°è°ƒç”¨
- JS é€†å‘å·¥ç¨‹

### Q: PyExecJS ä¸ºä»€ä¹ˆè¿™ä¹ˆæ…¢ï¼Ÿ
A: PyExecJS é€šè¿‡è¿›ç¨‹è°ƒç”¨å¤–éƒ¨ JS è¿è¡Œæ—¶ï¼Œæ¯æ¬¡éƒ½æœ‰è¿›ç¨‹é€šä¿¡å¼€é”€ã€‚



## å¯ç”¨æµ‹è¯•æ–‡ä»¶
- [benchmark.py](examples/benchmark.py)
- [test_async_simple.py](test_async_simple.py)
- [test_extensions.py](test_extensions.py)
- [test_new_apis.py](test_new_apis.py)
- [use_polyfill.py](examples/use_polyfill.py)




## æ€§èƒ½å¯¹æ¯”
![img.png](img.png)

| æµ‹è¯•é¡¹ç›®                         | never_jscore   | PyMiniRacer | PyExecJS |
|------------------------------|----------------|------------|----------|
| ç®€å•è®¡ç®—                         | 0.007ms        | 0.005ms    | 2.3ms    |
| å­—ç¬¦ä¸²æ“ä½œ                        | **0.004ms** ğŸ† | 0.008ms    | 2.3ms    |
| æ•°ç»„æ“ä½œ                         | **0.004ms** ğŸ† | 0.006ms    | 2.3ms    |
| å¤æ‚ç®—æ³•å‚æ•°ç”Ÿæˆ<br/>(1000æ¬¡å¾ªç¯ )<br/>[benchmark.py](examples/benchmark.py) | **0.0111s** ğŸ† | 0.0383s    | 69.4735s |
| Promise                      | **âœ… 0.003ms**  | âŒ ä¸æ”¯æŒ      | âŒ ä¸æ”¯æŒ    |


## å®‰è£…
```bash
pip install never-jscore
```

### ä»æºç å®‰è£…

```bash
pip install maturin
maturin develop --release
```

## å¿«é€Ÿå¼€å§‹

### 0. åˆ›å»º Contextï¼ˆå¯ç”¨æ‰©å±•ï¼‰

```python
import never_jscore

# å¯ç”¨ Web API æ‰©å±•ï¼ˆé»˜è®¤ï¼Œæ¨èç”¨äº JS é€†å‘ï¼‰
ctx = never_jscore.Context(enable_extensions=True)

# æˆ–ç¦ç”¨æ‰©å±•ï¼ˆçº¯å‡€ V8 ç¯å¢ƒï¼‰
ctx = never_jscore.Context(enable_extensions=False)
```

### 1. åŸºæœ¬ç”¨æ³•ï¼ˆå®ä¾‹åŒ– Contextï¼‰

```python
import never_jscore

# åˆ›å»º JavaScript æ‰§è¡Œä¸Šä¸‹æ–‡
ctx = never_jscore.Context()

# ä¸€æ¬¡æ€§æ±‚å€¼
result = ctx.evaluate("1 + 2 + 3")
print(result)  # 6

# å­—ç¬¦ä¸²æ“ä½œ
result = ctx.evaluate("'Hello'.toUpperCase()")
print(result)  # HELLO

# æ•°ç»„æ“ä½œ
result = ctx.evaluate("[1, 2, 3].map(x => x * 2)")
print(result)  # [2, 4, 6]
```

### 2. ç¼–è¯‘å’Œè°ƒç”¨

```python
import never_jscore

# åˆ›å»ºä¸Šä¸‹æ–‡
ctx = never_jscore.Context()

# ç¼–è¯‘ JavaScript ä»£ç 
ctx.compile("""
    function add(a, b) {
        return a + b;
    }

    function greet(name) {
        return "Hello, " + name + "!";
    }
""")

# è°ƒç”¨å‡½æ•°
print(ctx.call("add", [5, 3]))        # 8
print(ctx.call("greet", ["World"]))   # Hello, World!
```

### 3. å¼‚æ­¥æ”¯æŒï¼ˆPromise/async/awaitï¼‰

```python
import never_jscore

ctx = never_jscore.Context()

# async å‡½æ•°
ctx.compile("""
    async function fetchData(id) {
        // æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
        return await Promise.resolve({id: id, name: "User" + id});
    }
""")

# Promise è‡ªåŠ¨ç­‰å¾…
result = ctx.evaluate("Promise.resolve(42)")
print(result)  # 42

result = ctx.call("fetchData", [123])
print(result)  # {'id': 123, 'name': 'User123'}

# Promise é“¾
result = ctx.evaluate("""
    Promise.resolve(10)
        .then(x => x * 2)
        .then(x => x + 5)
""")
print(result)  # 25

# Promise.all å¹¶å‘
result = ctx.evaluate("""
    Promise.all([
        Promise.resolve(1),
        Promise.resolve(2),
        Promise.resolve(3)
    ])
""")
print(result)  # [1, 2, 3]
```

### 4. ä¸Šä¸‹æ–‡çŠ¶æ€ç®¡ç†

```python
import never_jscore

ctx = never_jscore.Context()
ctx.compile("""
    var counter = 0;

    function increment() {
        return ++counter;
    }

    function getCounter() {
        return counter;
    }
""")

print(ctx.call("increment", []))  # 1
print(ctx.call("increment", []))  # 2
print(ctx.call("getCounter", []))  # 2
```

### 5. å¤æ‚å¯¹è±¡å¤„ç†

```python
import never_jscore

ctx = never_jscore.Context()
ctx.compile("""
    function processUser(name, age, tags) {
        return {
            name: name,
            age: age,
            isAdult: age >= 18,
            tags: tags,
            summary: name + ' (' + age + 'å²)'
        };
    }
""")

result = ctx.call("processUser", ["å¼ ä¸‰", 25, ["Python", "JavaScript"]])
print(result)
# {
#     'name': 'å¼ ä¸‰',
#     'age': 25,
#     'isAdult': True,
#     'tags': ['Python', 'JavaScript'],
#     'summary': 'å¼ ä¸‰ (25å²)'
# }
```

### 6. æ€§èƒ½ç›‘æ§

```python
import never_jscore

ctx = never_jscore.Context()
ctx.compile("function compute(n) { return n * n; }")

# æ‰§è¡Œå¤šæ¬¡
for i in range(100):
    ctx.call("compute", [i])

# æŸ¥çœ‹ç»Ÿè®¡
stats = ctx.get_stats()
print(f"æ‰§è¡Œæ¬¡æ•°: {stats[0]}")  # 100

# è¯·æ±‚åƒåœ¾å›æ”¶ï¼ˆå¯é€‰ï¼‰
ctx.gc()

# é‡ç½®ç»Ÿè®¡
ctx.reset_stats()
```

## API å‚è€ƒ

### Context ç±»

#### `never_jscore.Context(enable_extensions: bool = True)`

åˆ›å»ºä¸€ä¸ªæ–°çš„ JavaScript æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚

**å‚æ•°**:
- `enable_extensions` (å¯é€‰): æ˜¯å¦å¯ç”¨å†…ç½® Web API æ‰©å±•ï¼ˆé»˜è®¤ Trueï¼‰
  - `True`: å¯ç”¨ Cryptoã€URL ç¼–ç ã€setTimeoutã€Worker ç­‰æ‰©å±•
  - `False`: çº¯å‡€ V8 ç¯å¢ƒï¼Œåªæœ‰ ECMAScript æ ‡å‡† API

**è¿”å›**: Context å¯¹è±¡

**ç¤ºä¾‹**:
```python
# å¯ç”¨æ‰©å±•ï¼ˆé»˜è®¤ï¼Œæ¨èç”¨äº JS é€†å‘ï¼‰
ctx = never_jscore.Context()
ctx = never_jscore.Context(enable_extensions=True)

# ç¦ç”¨æ‰©å±•ï¼ˆçº¯å‡€ V8ï¼‰
ctx = never_jscore.Context(enable_extensions=False)
```

#### `compile(code: str) -> None`

ç¼–è¯‘ JavaScript ä»£ç å¹¶åŠ å…¥å…¨å±€ä½œç”¨åŸŸã€‚

**å‚æ•°**:
- `code`: JavaScript ä»£ç å­—ç¬¦ä¸²

**ç¤ºä¾‹**:
```python
ctx.compile('''
    function add(a, b) { return a + b; }
''')
```

#### `eval(code: str, return_value: bool = False, auto_await: bool = True) -> Any`

æ‰§è¡Œä»£ç å¹¶å°†å…¶åŠ å…¥å…¨å±€ä½œç”¨åŸŸã€‚

**å‚æ•°**:
- `code`: JavaScript ä»£ç å­—ç¬¦ä¸²
- `return_value`: æ˜¯å¦è¿”å›æœ€åè¡¨è¾¾å¼çš„å€¼ï¼ˆé»˜è®¤ Falseï¼‰
- `auto_await`: æ˜¯å¦è‡ªåŠ¨ç­‰å¾… Promiseï¼ˆé»˜è®¤ Trueï¼‰

**è¿”å›**: å¦‚æœ return_value=Trueï¼Œè¿”å›æ‰§è¡Œç»“æœï¼›å¦åˆ™è¿”å› None

**ç¤ºä¾‹**:
```python
ctx.eval("var x = 10;")  # æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸ
result = ctx.eval("x * 2", return_value=True)  # è¿”å› 20
```

#### `evaluate(code: str, auto_await: bool = True) -> Any`

æ‰§è¡Œä»£ç å¹¶è¿”å›ç»“æœï¼ˆä¸å½±å“å…¨å±€ä½œç”¨åŸŸï¼‰ã€‚

**å‚æ•°**:
- `code`: JavaScript ä»£ç å­—ç¬¦ä¸²
- `auto_await`: æ˜¯å¦è‡ªåŠ¨ç­‰å¾… Promiseï¼ˆé»˜è®¤ Trueï¼‰

**è¿”å›**: è¡¨è¾¾å¼çš„å€¼

**ç¤ºä¾‹**:
```python
result = ctx.evaluate("1 + 2 + 3")  # 6
result = ctx.evaluate("Promise.resolve(42)")  # 42
```

#### `call(name: str, args: list, auto_await: bool = True) -> Any`

è°ƒç”¨ JavaScript å‡½æ•°ã€‚

**å‚æ•°**:
- `name`: å‡½æ•°åç§°
- `args`: å‚æ•°åˆ—è¡¨
- `auto_await`: æ˜¯å¦è‡ªåŠ¨ç­‰å¾… Promiseï¼ˆé»˜è®¤ Trueï¼‰

**è¿”å›**: å‡½æ•°è¿”å›å€¼

**ç¤ºä¾‹**:
```python
result = ctx.call("add", [1, 2])
result = ctx.call("asyncFunc", [arg], auto_await=True)
```

#### `gc() -> None`

è¯·æ±‚ V8 åƒåœ¾å›æ”¶ã€‚

**æ³¨æ„**: è¿™åªæ˜¯æç¤ºï¼ŒV8 ä¼šæ ¹æ®è‡ªå·±çš„ç­–ç•¥å†³å®šæ˜¯å¦æ‰§è¡Œã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æ— éœ€æ‰‹åŠ¨è°ƒç”¨ã€‚

#### `get_stats() -> tuple[int]`

è·å–æ‰§è¡Œç»Ÿè®¡ä¿¡æ¯ã€‚

**è¿”å›**: `(exec_count,)` æ‰§è¡Œæ¬¡æ•°å…ƒç»„

#### `reset_stats() -> None`

é‡ç½®ç»Ÿè®¡ä¿¡æ¯ã€‚

## ç±»å‹è½¬æ¢

Python å’Œ JavaScript ä¹‹é—´çš„ç±»å‹è‡ªåŠ¨è½¬æ¢ï¼š

| Python ç±»å‹ | JavaScript ç±»å‹ | è¯´æ˜ |
|------------|----------------|------|
| None       | null           | ç©ºå€¼ |
| bool       | boolean        | å¸ƒå°”å€¼ |
| int        | number         | æ•´æ•° |
| float      | number         | æµ®ç‚¹æ•° |
| str        | string         | å­—ç¬¦ä¸² |
| list       | Array          | æ•°ç»„ |
| dict       | Object         | å¯¹è±¡ |

**ç¤ºä¾‹**:
```python
# Python -> JavaScript
ctx.call("func", [None, True, 42, 3.14, "hello", [1, 2], {"key": "value"}])

# JavaScript -> Python
result = ctx.evaluate("{name: 'John', age: 30}")  # dict
result = ctx.evaluate("[1, 2, 3]")  # list
result = ctx.evaluate("null")  # None
```

## ä½¿ç”¨é™åˆ¶

### âš ï¸ å¤š Context é™åˆ¶ï¼ˆé‡è¦ï¼ï¼‰

ç”±äº V8 å¼•æ“çš„ thread-local storage é™åˆ¶å’Œå†…å­˜ç®¡ç†æœºåˆ¶ï¼Œ**å¤šä¸ª Context å¿…é¡»éµå¾ªç‰¹å®šçš„ä½¿ç”¨æ¨¡å¼**ã€‚

#### é™åˆ¶ 1: ä¸èƒ½äº¤å‰ä½¿ç”¨

**ä¸€æ—¦åˆ›å»ºäº†ç¬¬äºŒä¸ª Contextï¼Œå°±ä¸èƒ½å†ä½¿ç”¨ç¬¬ä¸€ä¸ª Contextï¼**

```python
# âŒ é”™è¯¯ç”¨æ³•ï¼šäº¤å‰ä½¿ç”¨ä¼šå´©æºƒ
ctx1 = never_jscore.Context()
ctx1.compile("function f1() { return 1; }")
result1 = ctx1.call("f1", [])  # OK

ctx2 = never_jscore.Context()
ctx2.compile("function f2() { return 2; }")
result2 = ctx2.call("f2", [])  # OK

result1 = ctx1.call("f1", [])  # âŒ å´©æºƒï¼ä¸èƒ½å›åˆ° ctx1
```

#### é™åˆ¶ 2: LIFO åˆ é™¤é¡ºåº

**å¤šä¸ª Context å¿…é¡»æŒ‰ LIFO é¡ºåºåˆ é™¤ï¼ˆååˆ›å»ºå…ˆåˆ é™¤ï¼‰**

```python
# âŒ é”™è¯¯ï¼šæŒ‰åˆ›å»ºé¡ºåºåˆ é™¤ä¼šå´©æºƒ
ctx1 = never_jscore.Context()
ctx2 = never_jscore.Context()
ctx3 = never_jscore.Context()

del ctx1  # âŒ å´©æºƒï¼
del ctx2
del ctx3

# âœ… æ­£ç¡®ï¼šLIFO é¡ºåºï¼ˆåè¿›å…ˆå‡ºï¼‰
ctx1 = never_jscore.Context()
ctx2 = never_jscore.Context()
ctx3 = never_jscore.Context()

# ä½¿ç”¨æœ€ååˆ›å»ºçš„ Context
result = ctx3.call("func", [])

# æŒ‰é€†åºåˆ é™¤
del ctx3  # âœ… æœ€ååˆ›å»ºï¼Œæœ€å…ˆåˆ é™¤
del ctx2  # âœ…
del ctx1  # âœ…

# âŒ é”™è¯¯ï¼šè®© Python è‡ªåŠ¨æ¸…ç†ï¼ˆé¡ºåºä¸ç¡®å®šï¼‰
# ç¨‹åºç»“æŸæ—¶ä¼šå´©æºƒ
```

#### æ¨èçš„ä½¿ç”¨æ¨¡å¼

**æ¨¡å¼ 1: å• Context æ¨¡å¼ï¼ˆæœ€æ¨èï¼‰**

å°†æ‰€æœ‰å‡½æ•°å®šä¹‰åœ¨ä¸€ä¸ª Context ä¸­ï¼š

```python
import never_jscore

ctx = never_jscore.Context()
ctx.compile("""
    function f1() { return 1; }
    function f2() { return 2; }
    function f3() { return 3; }
""")

# å¯ä»¥ä»»æ„è°ƒç”¨
ctx.call("f1", [])  # OK
ctx.call("f2", [])  # OK
ctx.call("f1", [])  # OK - å¯ä»¥é‡å¤è°ƒç”¨
```

**æ¨¡å¼ 2: é¡ºåºä½¿ç”¨ï¼ˆç”¨å®Œå³åˆ ï¼‰**

```python
import never_jscore

# ä½¿ç”¨ç¬¬ä¸€ä¸ª Context
ctx1 = never_jscore.Context()
ctx1.compile("function f1() { return 1; }")
result = ctx1.call("f1", [])
del ctx1  # ç”¨å®Œç«‹å³åˆ é™¤

# ä½¿ç”¨ç¬¬äºŒä¸ª Context
ctx2 = never_jscore.Context()
ctx2.compile("function f2() { return 2; }")
result = ctx2.call("f2", [])
del ctx2  # ç”¨å®Œç«‹å³åˆ é™¤
```

**æ¨¡å¼ 3: LIFO æ‰¹é‡æ¸…ç†ï¼ˆé«˜çº§ç”¨æ³•ï¼‰**

```python
import never_jscore

# åˆ›å»ºå¤šä¸ª Contextï¼ˆæ³¨æ„ï¼šåˆ›å»ºç¬¬äºŒä¸ªåä¸èƒ½å†ç”¨ç¬¬ä¸€ä¸ªï¼‰
ctx1 = never_jscore.Context()
ctx1.compile("function f1() { return 1; }")
r1 = ctx1.call("f1", [])  # åœ¨åˆ›å»º ctx2 ä¹‹å‰å®Œæˆæ‰€æœ‰æ“ä½œ

ctx2 = never_jscore.Context()
ctx2.compile("function f2() { return 2; }")
r2 = ctx2.call("f2", [])  # ctx1 å·²ä¸å¯ç”¨

ctx3 = never_jscore.Context()
ctx3.compile("function f3() { return 3; }")
r3 = ctx3.call("f3", [])  # ctx1, ctx2 å·²ä¸å¯ç”¨

# LIFO é¡ºåºåˆ é™¤ï¼ˆåè¿›å…ˆå‡ºï¼‰
del ctx3
del ctx2
del ctx1
```

## å†…ç½® Web API æ‰©å±•ï¼ˆv2.0+ï¼‰

never_jscore å†…ç½®äº†å¸¸ç”¨çš„ Web APIï¼Œ**æ— éœ€é¢å¤– polyfill**ï¼Œå¼€ç®±å³ç”¨ï¼

### Crypto APIsï¼ˆåŠ å¯†ç›¸å…³ï¼‰

```python
import never_jscore

ctx = never_jscore.Context(enable_extensions=True)

# Base64 ç¼–è§£ç 
result = ctx.evaluate("btoa('Hello World')")  # "SGVsbG8gV29ybGQ="
result = ctx.evaluate("atob('SGVsbG8gV29ybGQ=')")  # "Hello World"

# å“ˆå¸Œå‡½æ•°
result = ctx.evaluate("md5('test')")  # "098f6bcd4621d373cade4e832627b4f6"
result = ctx.evaluate("sha256('test')")  # "9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08"

# HMAC
result = ctx.evaluate("CryptoUtils.hmacSha256('key', 'message')")

# Hex ç¼–è§£ç 
result = ctx.evaluate("CryptoUtils.hexEncode('test')")  # "74657374"
result = ctx.evaluate("CryptoUtils.hexDecode('74657374')")  # "test"

# é“¾å¼ APIï¼ˆç±» Node.js cryptoï¼‰
result = ctx.evaluate("""
    CryptoUtils.createHash('sha256')
        .update('hello')
        .update(' world')
        .digest('hex')
""")
```

### URL ç¼–ç 

```python
# URL ç¼–ç ï¼ˆå…¼å®¹æµè§ˆå™¨ APIï¼‰
result = ctx.evaluate("encodeURIComponent('hello world')")  # "hello%20world"
result = ctx.evaluate("decodeURIComponent('hello%20world')")  # "hello world"
```

### éšæœºæ•°ç”Ÿæˆ

```python
# UUID ç”Ÿæˆ
uuid = ctx.evaluate("crypto.randomUUID()")  # "a3111236-1431-4d0d-807e-6c7b388d4433"

# éšæœºæ•°ç»„
result = ctx.evaluate("""
    const arr = new Uint8Array(16);
    crypto.getRandomValues(arr);
    Array.from(arr)
""")  # [123, 45, 67, ...]

# éšæœºæµ®ç‚¹æ•°
result = ctx.evaluate("Deno.core.ops.op_crypto_random()")  # 0.123456789
```

### å®šæ—¶å™¨ï¼ˆç«‹å³æ‰§è¡Œç‰ˆæœ¬ï¼‰

```python
# setTimeout/setIntervalï¼ˆç”¨äº API æ£€æµ‹ï¼Œç«‹å³æ‰§è¡Œï¼‰
result = ctx.evaluate("""
    let value = 0;
    setTimeout(() => { value = 42; }, 100);  // ç«‹å³æ‰§è¡Œ
    value  // éœ€è¦ç­‰å¾… Promise
""")
```

âš ï¸ **æ³¨æ„**ï¼šsetTimeout/setInterval æ˜¯**å‡çš„å¼‚æ­¥**ï¼ˆç«‹å³æ‰§è¡Œï¼‰ï¼Œä»…ç”¨äºé€šè¿‡ JS ä»£ç ä¸­çš„ API å­˜åœ¨æ€§æ£€æµ‹ã€‚

### Worker APIï¼ˆå•çº¿ç¨‹æ¨¡æ‹Ÿï¼‰

```python
# Worker APIï¼ˆç”¨äºå…¼å®¹æ£€æµ‹ï¼Œå•çº¿ç¨‹æ¨¡æ‹Ÿï¼‰
result = ctx.evaluate("""
    typeof Worker === 'function' &&
    typeof Worker.prototype.postMessage === 'function'
""")  # True
```

âš ï¸ **æ³¨æ„**ï¼šWorker æ˜¯**å•çº¿ç¨‹æ¨¡æ‹Ÿ**ï¼Œä¸ä¼šçœŸæ­£åˆ›å»ºå¤šçº¿ç¨‹ï¼Œä»…ç”¨äºé€šè¿‡ä»£ç æ£€æµ‹ã€‚

### ç¦ç”¨æ‰©å±•ï¼ˆçº¯å‡€ V8ï¼‰

å¦‚æœä¸éœ€è¦è¿™äº› APIï¼Œå¯ä»¥ç¦ç”¨æ‰©å±•ï¼š

```python
ctx = never_jscore.Context(enable_extensions=False)

# æ­¤æ—¶åªæœ‰ ECMAScript æ ‡å‡† API
result = ctx.evaluate("typeof btoa")  # "undefined"
result = ctx.evaluate("JSON.stringify({a: 1})")  # '{"a":1}' - æ ‡å‡† API å¯ç”¨
```

## é€‚ç”¨åœºæ™¯

### JavaScript é€†å‘åˆ†æï¼ˆæ¨èï¼‰

```python
import never_jscore

# åŠ è½½ç›®æ ‡ç½‘ç«™çš„åŠ å¯† JS
with open("target_crypto.js") as f:
    js_code = f.read()

ctx = never_jscore.Context(enable_extensions=True)  # å¯ç”¨å†…ç½® Web API
ctx.compile(js_code)

# ç›´æ¥è°ƒç”¨åŠ å¯†å‡½æ•°ï¼ˆæ— éœ€é¢å¤– polyfillï¼‰
encrypted = ctx.call("encrypt", [plain_text, key])

# å¦‚æœ JS ä»£ç ä½¿ç”¨äº† btoaã€md5ã€sha256 ç­‰ï¼Œéƒ½å¯ä»¥ç›´æ¥ä½¿ç”¨
result = ctx.evaluate("btoa(md5('test'))")
```

### çœŸå®åœºæ™¯ï¼šAPI ç­¾åç”Ÿæˆ

```python
import never_jscore

ctx = never_jscore.Context(enable_extensions=True)

# å…¸å‹çš„ç­¾åç®—æ³•ï¼ˆæ— éœ€ polyfillï¼Œç›´æ¥è¿è¡Œï¼‰
ctx.compile("""
    function generateSignature(params, secret) {
        // 1. å‚æ•°æ’åº
        const keys = Object.keys(params).sort();

        // 2. æ‹¼æ¥æŸ¥è¯¢å­—ç¬¦ä¸²
        const query = keys.map(k =>
            encodeURIComponent(k) + '=' + encodeURIComponent(params[k])
        ).join('&');

        // 3. æ·»åŠ å¯†é’¥å¹¶è®¡ç®— HMAC
        const message = query + '&key=' + secret;
        const signature = CryptoUtils.hmacSha256(secret, message);

        // 4. Base64 ç¼–ç 
        return btoa(signature);
    }
""")

# è°ƒç”¨ç­¾åå‡½æ•°
signature = ctx.call("generateSignature", [
    {"user": "test", "timestamp": "1234567890"},
    "my-secret-key"
])
print(f"Signature: {signature}")
```

### å¼‚æ­¥æ•°æ®å¤„ç†

```python
import never_jscore

ctx = never_jscore.Context()
ctx.compile("""
    async function processBatch(items) {
        const results = await Promise.all(
            items.map(async item => {
                // æ¨¡æ‹Ÿå¼‚æ­¥å¤„ç†
                return await Promise.resolve(item * 2);
            })
        );
        return results;
    }
""")

result = ctx.call("processBatch", [[1, 2, 3, 4, 5]])
print(result)  # [2, 4, 6, 8, 10]
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **é‡ç”¨ Context**: å¯¹äºéœ€è¦å¤šæ¬¡è°ƒç”¨çš„ä»£ç ï¼Œåˆ›å»ºä¸€ä¸ª Context å¹¶å¤ç”¨
2. **æ‰¹é‡å¤„ç†**: åœ¨ JavaScript ç«¯æ‰¹é‡å¤„ç†æ•°æ®ï¼Œå‡å°‘ Python-JS è°ƒç”¨æ¬¡æ•°
3. **å• Context æ¨¡å¼**: å°½å¯èƒ½å°†æ‰€æœ‰å‡½æ•°å®šä¹‰åœ¨ä¸€ä¸ª Context ä¸­
4. **åˆç†ä½¿ç”¨ auto_await**: å¯¹äºä¸éœ€è¦ç­‰å¾…çš„åŒæ­¥ä»£ç ï¼Œè®¾ç½® `auto_await=False` å¯ç•¥å¾®æå‡æ€§èƒ½
5. **é¿å…é¢‘ç¹åˆ›å»º Context**: åˆ›å»º Context æœ‰å¼€é”€ï¼Œåº”å°½é‡å¤ç”¨

## æ¨¡å—åŒ–æ¶æ„

é¡¹ç›®é‡‡ç”¨æ¸…æ™°çš„æ¨¡å—åŒ–è®¾è®¡ï¼š

```
src/
â”œâ”€â”€ lib.rs            # æ¨¡å—å…¥å£ï¼Œä»…å¯¼å‡º Context ç±»
â”œâ”€â”€ context.rs        # Context å®ç°ï¼ˆV8 isolate å°è£…ï¼‰
â”œâ”€â”€ runtime.rs        # V8/Tokio runtime ç®¡ç†
â”œâ”€â”€ ops.rs            # Deno Core ops å®šä¹‰
â”œâ”€â”€ convert.rs        # Python â†” JavaScript ç±»å‹è½¬æ¢
â”œâ”€â”€ storage.rs        # ç»“æœå­˜å‚¨
â”œâ”€â”€ crypto_ops.rs     # åŠ å¯†æ“ä½œæ‰©å±•ï¼ˆBase64ã€Hashã€HMACã€Randomï¼‰
â”œâ”€â”€ encoding_ops.rs   # URL ç¼–ç æ‰©å±•
â”œâ”€â”€ timer_ops.rs      # å®šæ—¶å™¨æ‰©å±•ï¼ˆsetTimeout/setIntervalï¼‰
â”œâ”€â”€ worker_ops.rs     # Worker API æ‰©å±•
â””â”€â”€ dddd_js/
    â””â”€â”€ js_polyfill.js  # JavaScript polyfill å±‚ï¼ˆè‡ªåŠ¨æ³¨å…¥ï¼‰
```

### æ‰©å±•ç³»ç»Ÿæ¶æ„

- **Rust å±‚**: ä½¿ç”¨ Deno Core çš„ `#[op2]` å®å®šä¹‰åº•å±‚æ“ä½œ
- **JavaScript å±‚**: åœ¨ `js_polyfill.js` ä¸­å°è£…ä¸ºæ ‡å‡† Web API
- **è‡ªåŠ¨æ³¨å…¥**: `enable_extensions=True` æ—¶è‡ªåŠ¨åŠ è½½æ‰€æœ‰æ‰©å±•

## æµ‹è¯•

```bash
# åŸºç¡€åŠŸèƒ½æµ‹è¯•
python test_async_simple.py

# Web API æ‰©å±•æµ‹è¯•
python test_extensions.py
python test_new_apis.py
```

## æŠ€æœ¯ç»†èŠ‚

- **V8 å¼•æ“**: ä½¿ç”¨ Deno Core æä¾›çš„ V8 bindings
- **Tokio Runtime**: å…¨å±€å•çº¿ç¨‹ runtimeï¼Œæ”¯æŒå¼‚æ­¥æ“ä½œ
- **ç±»å‹è½¬æ¢**: Python â†” JSON â†” JavaScript ä¸‰å±‚è½¬æ¢
- **å†…å­˜ç®¡ç†**: ä½¿ç”¨ `std::mem::forget()` é¿å… HandleScope é”™è¯¯ï¼Œæ¯ 100 æ¬¡æ‰§è¡Œæç¤º GC
- **æ‰©å±•ç³»ç»Ÿ**: åŸºäº Deno Core extension æœºåˆ¶ï¼Œæ¨¡å—åŒ–è®¾è®¡
- **ä¾èµ–åº“**:
  - `deno_core 0.365.0`: V8 è¿è¡Œæ—¶
  - `pyo3 0.27.1`: Python ç»‘å®š
  - `tokio 1.48`: å¼‚æ­¥è¿è¡Œæ—¶
  - `rand 0.8`: éšæœºæ•°ç”Ÿæˆ
  - `base64`, `md-5`, `sha1`, `sha2`, `hmac`: åŠ å¯†åº“

## è®¸å¯è¯

MIT License

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ç›¸å…³é¡¹ç›®

- [py_mini_racer](https://github.com/sqreen/PyMiniRacer) - Python MiniRacer å®ç°
- [PyExecJS](https://github.com/doloopwhile/PyExecJS) - åŸ Python ExecJS å®ç°
- [Deno](https://github.com/denoland/deno) - ç°ä»£ JavaScript/TypeScript è¿è¡Œæ—¶
- [PyO3](https://github.com/PyO3/pyo3) - Rust Python bindings

## æ›´æ–°æ—¥å¿—

### v2.0.0 (2025-01)

#### æ¶æ„é‡æ„
- ğŸ”„ **æ¶æ„é‡æ„**: æ”¹ä¸º py_mini_racer é£æ ¼çš„å®ä¾‹åŒ– API
- âœ… ä¿®å¤ HandleScope é”™è¯¯ï¼šä½¿ç”¨ `std::mem::forget()` ç®¡ç† v8::Global
- âœ… æ˜ç¡® LIFO æ¸…ç†é¡ºåºè¦æ±‚
- âœ… å®Œå–„å¤š Context ä½¿ç”¨é™åˆ¶è¯´æ˜
- âœ… æ–°å¢ `compile()` ä¾¿æ·æ–¹æ³•
- âœ… æ–°å¢ `evaluate()` ç‹¬ç«‹æ±‚å€¼æ–¹æ³•

#### Web API æ‰©å±•ï¼ˆå…¨æ–°ï¼‰
- âœ¨ **Crypto APIs**:
  - Base64: `btoa()`, `atob()`
  - å“ˆå¸Œ: `md5()`, `sha1()`, `sha256()`, `sha512()`
  - HMAC: `hmacMd5()`, `hmacSha1()`, `hmacSha256()`
  - Hex: `hexEncode()`, `hexDecode()`
  - é“¾å¼ API: `CryptoUtils.createHash()`, `CryptoUtils.createHmac()`
- âœ¨ **URL ç¼–ç **: `encodeURIComponent()`, `decodeURIComponent()`, `encodeURI()`, `decodeURI()`
- âœ¨ **å®šæ—¶å™¨**: `setTimeout()`, `setInterval()`, `clearTimeout()`, `clearInterval()` (ç«‹å³æ‰§è¡Œç‰ˆæœ¬)
- âœ¨ **Worker API**: `Worker` ç±»ï¼ˆå•çº¿ç¨‹æ¨¡æ‹Ÿç‰ˆæœ¬ï¼‰
- âœ¨ **éšæœºæ•°**: `crypto.randomUUID()`, `crypto.getRandomValues()`, éšæœºæ•° ops
- ğŸ¯ **æ‰©å±•æ§åˆ¶**: `Context(enable_extensions=True/False)` å¯é€‰å¯ç”¨/ç¦ç”¨
- ğŸ“¦ **è‡ªåŠ¨æ³¨å…¥**: æ— éœ€æ‰‹åŠ¨åŠ è½½ polyfillï¼Œå¼€ç®±å³ç”¨

#### æ€§èƒ½ä¼˜åŒ–
- âš¡ æ‰©å±•æ¨¡å—é‡‡ç”¨ Rust å®ç°ï¼Œæ€§èƒ½æ¥è¿‘åŸç”Ÿ
- âš¡ JavaScript polyfill å±‚ä»…åœ¨å¿…è¦æ—¶ä½¿ç”¨

### v0.1.0 (2024-12)

- âœ… åŸºäº Deno Core çš„ JavaScript æ‰§è¡Œ
- âœ… Promise/async/await å®Œæ•´æ”¯æŒ
- âœ… Python â†” JavaScript ç±»å‹è‡ªåŠ¨è½¬æ¢
- âœ… æ¨¡å—åŒ–ä»£ç æ¶æ„
- âœ… å®Œæ•´çš„ç±»å‹æç¤ºæ”¯æŒ
- âœ… æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡

