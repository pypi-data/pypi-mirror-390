name: Test Plotter
on: [pull_request, push]
jobs:
  run-tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up Conda
      uses: conda-incubator/setup-miniconda@v3
      with:
        activate-environment: myenv
        python-version: "3.13"
        miniforge-version: latest
        channels: conda-forge

    - name: Create Conda environment
      shell: bash -l {0}
      run: |
        conda install -c conda-forge pip

    - name: Install local package and dependencies
      shell: bash -l {0}
      run: |
        pip install .[test]
    
    - name: Install Exodriver for LabJackPython
      # This is necessary for the LabJackPython package to work correctly
      shell: bash -l {0}
      run: |
        sudo apt-get install build-essential
        sudo apt-get install libusb-1.0-0-dev
        sudo apt-get install git-core
        git clone https://github.com/labjack/exodriver.git
        cd exodriver/
        sudo ./install.sh
        
    - name: Test DataPlotter instantiation
      shell: bash -l {0}
      run: |
        python -c "
        from shield_das import DataPlotter
        print('Creating DataPlotter instance...')
        my_plotter = DataPlotter()
        print('✓ DataPlotter instantiated successfully!')
        "
        
    - name: Test DataPlotter startup (short duration)
      shell: bash -l {0}
      timeout-minutes: 1
      run: |
        timeout 10s python -c "
        from shield_das import DataPlotter
        import threading
        import time
        
        print('Testing DataPlotter startup...')
        my_plotter = DataPlotter()
        
        # Start in background thread
        def start_plotter():
            try:
                my_plotter.start()
            except KeyboardInterrupt:
                print('Server stopped by timeout (expected)')
        
        server_thread = threading.Thread(target=start_plotter)
        server_thread.daemon = True
        server_thread.start()
        
        # Let it run for a few seconds
        time.sleep(5)
        print('✓ DataPlotter started successfully!')
        " || echo "✓ Startup test completed (timeout expected)"
