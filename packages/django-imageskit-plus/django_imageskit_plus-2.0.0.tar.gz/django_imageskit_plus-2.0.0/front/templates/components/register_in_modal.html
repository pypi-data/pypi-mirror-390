<!-- Кнопка открытия модального окна регистрации -->
<button type="button" class="btn btn-outline-primary btn-lg mx-2" data-bs-toggle="modal" data-bs-target="#registrationModal">
    <i class="bi bi-person-plus me-2"></i>Зарегистрироваться
</button>

<!-- Модальное окно регистрации -->
<div class="modal fade" id="registrationModal" tabindex="-1" aria-labelledby="registrationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h2 class="modal-title mb-0 text-center" id="registrationModalLabel">Регистрация</h2>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="registerForm" method="post" enctype="multipart/form-data" novalidate>
                    {% csrf_token %}
                    
                    <div id="formErrors" class="alert alert-danger d-none">
                        <strong>Ошибка!</strong> Пожалуйста, исправьте следующие ошибки:
                        <ul id="errorList"></ul>
                    </div>

                    <!-- Личная информация -->
                    <div class="mb-4">
                        <h5 class="text-primary mb-3"><i class="bi bi-person-vcard me-2"></i>Личная информация</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="id_first_name" class="form-label">Имя*</label>
                                <input type="text" class="form-control" id="id_first_name" name="first_name" required>
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-md-6">
                                <label for="id_last_name" class="form-label">Фамилия*</label>
                                <input type="text" class="form-control" id="id_last_name" name="last_name" required>
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-md-6">
                                <label for="id_username" class="form-label">Логин*</label>
                                <input type="text" class="form-control" id="id_username" name="username" required>
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-md-6">
                                <label for="id_email" class="form-label">Email*</label>
                                <input type="email" class="form-control" id="id_email" name="email" required>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Контактные данные -->
                    <div class="mb-4">
                        <h5 class="text-primary mb-3"><i class="bi bi-telephone me-2"></i>Контактные данные</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="id_phone" class="form-label">Телефон</label>
                                <input type="tel" class="form-control" id="id_phone" name="phone" placeholder="+79991234567">
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-md-6">
                                <label for="id_birth_date" class="form-label">Дата рождения</label>
                                <input type="date" class="form-control" id="id_birth_date" name="birth_date">
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-md-6">
                                <label for="id_gender" class="form-label">Пол</label>
                                <select class="form-select" id="id_gender" name="gender">
                                    <option value="" selected>Не указан</option>
                                    <option value="male">Мужской</option>
                                    <option value="female">Женский</option>
                                    <option value="other">Другое</option>
                                </select>
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-md-6">
                                <label for="id_age" class="form-label">Возраст</label>
                                <input type="number" class="form-control" id="id_age" name="age" min="0" max="120">
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Адрес -->
                    <div class="mb-4">
                        <h5 class="text-primary mb-3"><i class="bi bi-geo-alt me-2"></i>Адрес</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="id_country" class="form-label">Страна</label>
                                <input type="text" class="form-control" id="id_country" name="country">
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-md-6">
                                <label for="id_city" class="form-label">Город</label>
                                <input type="text" class="form-control" id="id_city" name="city">
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-12">
                                <label for="id_address" class="form-label">Адрес</label>
                                <input type="text" class="form-control" id="id_address" name="address">
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Профессиональная информация -->
                    <div class="mb-4">
                        <h5 class="text-primary mb-3"><i class="bi bi-briefcase me-2"></i>Профессиональная информация</h5>
                        <div class="row g-3">
                            <div class="col-12">
                                <label for="id_occupation" class="form-label">Профессия</label>
                                <input type="text" class="form-control" id="id_occupation" name="occupation">
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Аватар и пароль -->
                    <div class="mb-4">
                        <h5 class="text-primary mb-3"><i class="bi bi-shield-lock me-2"></i>Безопасность</h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="id_avatar" class="form-label">Аватар</label>
                                <input type="file" class="form-control" id="id_avatar" name="avatar" accept="image/*">
                                <div class="form-text">JPG, PNG или GIF (макс. 5MB)</div>
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-md-6">
                                <label for="id_password1" class="form-label">Пароль*</label>
                                <input type="password" class="form-control" id="id_password1" name="password1" required>
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-md-6">
                                <label for="id_password2" class="form-label">Подтверждение пароля*</label>
                                <input type="password" class="form-control" id="id_password2" name="password2" required>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Кнопка отправки -->
                    <div class="d-grid mt-4">
                        <button class="btn btn-primary btn-lg py-3" type="submit">
                            <i class="bi bi-person-plus me-2"></i>Зарегистрироваться
                        </button>
                    </div>

                    <div class="mt-4 text-center">
                        <p class="mb-0">Уже есть аккаунт? 
                            <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#authModal" data-bs-dismiss="modal">
                                Войти
                            </a>
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const registerForm = document.getElementById('registerForm');
        const formErrors = document.getElementById('formErrors');
        const errorList = document.getElementById('errorList');
    
        registerForm.addEventListener('submit', function(e) {
            e.preventDefault();
            formErrors.classList.add('d-none');
            errorList.innerHTML = '';
            
            // Сбрасываем все ошибки полей
            registerForm.querySelectorAll('.is-invalid').forEach(input => {
                input.classList.remove('is-invalid');
            });
            
            const formData = new FormData(registerForm);
            
            fetch("{% url 'modal_register' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    // Не включаем Content-Type заголовок, чтобы браузер мог автоматически 
                    // установить правильный Content-Type с boundary для FormData с файлами
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                // Важно не устанавливать credentials: 'include', так как он будет добавлен автоматически
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = data.redirect;
                } else {
                    formErrors.classList.remove('d-none');
                    for (const field in data.errors) {
                        const input = registerForm.querySelector(`[name="${field}"]`);
                        if (input) {
                            input.classList.add('is-invalid');
                            const feedback = input.nextElementSibling;
                            if (feedback && feedback.classList.contains('invalid-feedback')) {
                                feedback.textContent = data.errors[field].join(' ');
                            }
                            
                            const errorMsg = document.createElement('li');
                            errorMsg.textContent = `${field}: ${data.errors[field].join(' ')}`;
                            errorList.appendChild(errorMsg);
                        } else if (field === '__all__') {
                            // Общие ошибки формы
                            const errorMsg = document.createElement('li');
                            errorMsg.textContent = data.errors[field].join(' ');
                            errorList.appendChild(errorMsg);
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                formErrors.classList.remove('d-none');
                const errorMsg = document.createElement('li');
                errorMsg.textContent = 'Произошла ошибка при отправке формы. Пожалуйста, попробуйте еще раз.';
                errorList.appendChild(errorMsg);
            });
        });

        // Валидация паролей
        const password1 = document.getElementById('id_password1');
        const password2 = document.getElementById('id_password2');
        
        if (password1 && password2) {
            password1.addEventListener('input', function() {
                if (password1.value.length < 8) {
                    password1.setCustomValidity('Пароль должен содержать минимум 8 символов');
                } else {
                    password1.setCustomValidity('');
                }
            });
            
            password2.addEventListener('input', function() {
                if (password1.value !== password2.value) {
                    password2.setCustomValidity('Пароли не совпадают');
                } else {
                    password2.setCustomValidity('');
                }
            });
        }

        // Маска для телефона
        const phoneInput = document.getElementById('id_phone');
        if (phoneInput) {
            phoneInput.addEventListener('input', function(e) {
                let value = this.value.replace(/\D/g, '');
                if (value.length > 0 && !value.startsWith('7')) {
                    value = '7' + value;
                }
                if (value.length > 0) {
                    value = '+' + value;
                }
                this.value = value;
            });
        }
    });
</script>