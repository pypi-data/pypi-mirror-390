import re
from datetime import datetime
from pathlib import Path
from typing import Any

import yaml

from charlie.schema import AgentSpec, CharlieConfig, Command, RulesSection
from charlie.utils import PlaceholderTransformer


def _format_command_reference(command: Command, command_prefix: str) -> str:
    lines = [
        f"### /{command_prefix}.{command.name}",
        "",
        f"**Description**: {command.description}",
        "",
        f"**Usage**: `/{command_prefix}.{command.name} <input>`",
        "",
        "**Scripts**:",
    ]

    if command.scripts:
        if command.scripts.sh:
            lines.append(f"- Bash: `{command.scripts.sh}`")
        if command.scripts.ps:
            lines.append(f"- PowerShell: `{command.scripts.ps}`")
    else:
        lines.append("- No scripts (prompt only)")

    lines.append("")

    return "\n".join(lines)


def _extract_manual_additions(existing_content: str) -> str:
    pattern = r"<!-- MANUAL ADDITIONS START -->(.*?)<!-- MANUAL ADDITIONS END -->"
    match = re.search(pattern, existing_content, re.DOTALL)

    if match:
        return match.group(1).strip()

    return ""


def _extract_frontmatter_fields(section: RulesSection) -> dict[str, Any]:
    section_dict = section.model_dump()

    core_fields = {"title", "content", "order", "filename"}
    frontmatter = {k: v for k, v in section_dict.items() if k not in core_fields and v is not None}

    return frontmatter


def _format_frontmatter(frontmatter: dict[str, Any]) -> str:
    if not frontmatter:
        return ""

    yaml_str = yaml.dump(frontmatter, default_flow_style=False, sort_keys=False)
    return f"---\n{yaml_str}---\n\n"


def _generate_merged_rules(
    config: CharlieConfig,
    agent_name: str,
    agent_spec: AgentSpec,
    output_dir: str,
    root_dir: str = ".",
) -> str:
    rules_path = Path(output_dir) / agent_spec.rules_file
    rules_path.parent.mkdir(parents=True, exist_ok=True)

    transformer = PlaceholderTransformer(agent_spec, root_dir)

    manual_additions = ""
    if rules_path.exists():
        existing_content = rules_path.read_text(encoding="utf-8")
        manual_additions = _extract_manual_additions(existing_content)

    frontmatter = {}
    if config.rules and config.rules.sections:
        sorted_sections = sorted(
            config.rules.sections, key=lambda s: (s.order if s.order is not None else 999, s.title)
        )
        if sorted_sections:
            frontmatter = _extract_frontmatter_fields(sorted_sections[0])

    title = config.rules.title if config.rules else "Development Guidelines"
    include_commands = config.rules.include_commands if config.rules else True
    preserve_manual = config.rules.preserve_manual if config.rules else True
    current_date = datetime.now().strftime("%Y-%m-%d")

    content_parts = []

    if frontmatter:
        content_parts.append(_format_frontmatter(frontmatter))

    lines = [
        f"# {title}",
        "",
        "Auto-generated by Charlie from configuration",
        f"Last updated: {current_date}",
        "",
    ]

    if config.rules and config.rules.sections:
        sorted_sections = sorted(
            config.rules.sections, key=lambda s: (s.order if s.order is not None else 999, s.title)
        )
        for section in sorted_sections:
            lines.append(f"## {section.title}")
            lines.append("")
            content = transformer.transform(section.content)
            lines.append(content)
            lines.append("")

    if include_commands and config.commands:
        lines.append("## Available Commands")
        lines.append("")
        if config.project and config.project.command_prefix:
            for command in config.commands:
                lines.append(f"- `/{config.project.command_prefix}.{command.name}` - {command.description}")
            lines.append("")

            lines.append("## Command Reference")
            lines.append("")
            for command in config.commands:
                lines.append(_format_command_reference(command, config.project.command_prefix))

    if preserve_manual:
        lines.append("<!-- MANUAL ADDITIONS START -->")
        if manual_additions:
            lines.append(manual_additions)
        else:
            lines.append("<!-- Add your custom rules here - they will be preserved on regeneration -->")
        lines.append("<!-- MANUAL ADDITIONS END -->")

    content_parts.append("\n".join(lines))
    content = "".join(content_parts)

    rules_path.write_text(content, encoding="utf-8")

    return str(rules_path)


def _generate_separate_rules(
    config: CharlieConfig,
    agent_name: str,
    agent_spec: AgentSpec,
    output_dir: str,
    root_dir: str = ".",
) -> list[str]:
    generated_files: list[str] = []

    if not config.rules or not config.rules.sections:
        return generated_files

    rules_dir = Path(output_dir) / agent_spec.rules_dir
    rules_dir.mkdir(parents=True, exist_ok=True)

    transformer = PlaceholderTransformer(agent_spec, root_dir)

    sorted_sections = sorted(config.rules.sections, key=lambda s: (s.order if s.order is not None else 999, s.title))

    for section in sorted_sections:
        # Use the original filename if available, otherwise generate from title
        if section.filename:
            # Preserve the base name but use the agent's rules extension
            base_name = Path(section.filename).stem
            filename = base_name + agent_spec.rules_extension
        else:
            filename = section.title.lower().replace(" ", "-").replace("/", "-") + agent_spec.rules_extension
        section_path = rules_dir / filename

        frontmatter = _extract_frontmatter_fields(section)

        content_parts = []

        if frontmatter:
            content_parts.append(_format_frontmatter(frontmatter))

        content_text = transformer.transform(section.content)
        lines = [
            f"# {section.title}",
            "",
            "Auto-generated by Charlie from configuration",
            f"Last updated: {datetime.now().strftime('%Y-%m-%d')}",
            "",
            content_text,
        ]

        content_parts.append("\n".join(lines))
        content = "".join(content_parts)

        section_path.write_text(content, encoding="utf-8")
        generated_files.append(str(section_path))

    return generated_files


def generate_rules_for_agents(
    config: CharlieConfig,
    agent_name: str,
    agent_spec: AgentSpec,
    output_dir: str,
    mode: str = "merged",
    root_dir: str = ".",
) -> list[str]:
    if mode == "separate" and config.rules and config.rules.sections:
        return _generate_separate_rules(config, agent_name, agent_spec, output_dir, root_dir)
    else:
        return [_generate_merged_rules(config, agent_name, agent_spec, output_dir, root_dir)]
