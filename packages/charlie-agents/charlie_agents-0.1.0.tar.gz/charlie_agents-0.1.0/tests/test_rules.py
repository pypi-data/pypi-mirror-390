"""Tests for rules file generator."""

from pathlib import Path

from charlie.agents.registry import get_agent_spec
from charlie.rules import (
    _extract_manual_additions,
    _format_command_reference,
    generate_rules_file,
    generate_rules_for_agents,
)
from charlie.schema import CharlieConfig, Command, CommandScripts, ProjectConfig, RulesConfig


def test_format_command_reference() -> None:
    """Test formatting a command as reference entry."""
    command = Command(
        name="init",
        description="Initialize feature",
        prompt="Test",
        scripts=CommandScripts(sh="init.sh", ps="init.ps1"),
    )

    result = _format_command_reference(command, "myapp")

    assert "### /myapp.init" in result
    assert "**Description**: Initialize feature" in result
    assert "**Usage**: `/myapp.init <input>`" in result
    assert "Bash: `init.sh`" in result
    assert "PowerShell: `init.ps1`" in result


def test_extract_manual_additions() -> None:
    """Test extracting manual additions from existing content."""
    content = """# Title

Some content

<!-- MANUAL ADDITIONS START -->
My custom rules here
More custom stuff
<!-- MANUAL ADDITIONS END -->

More content
"""

    result = _extract_manual_additions(content)
    assert "My custom rules here" in result
    assert "More custom stuff" in result


def test_extract_manual_additions_empty() -> None:
    """Test extracting from content without manual additions."""
    content = "# Title\n\nSome content"

    result = _extract_manual_additions(content)
    assert result == ""


def test_generate_rules_file(tmp_path) -> None:
    """Test generating a rules file."""
    config = CharlieConfig(
        version="1.0",
        project=ProjectConfig(name="test", command_prefix="test"),
        commands=[
            Command(
                name="init",
                description="Initialize",
                prompt="Test",
                scripts=CommandScripts(sh="init.sh"),
            )
        ],
    )

    agent_spec = get_agent_spec("windsurf")

    rules_paths = generate_rules_file(config, "windsurf", agent_spec, str(tmp_path))

    # Check file was created
    assert len(rules_paths) == 1
    rules_path = rules_paths[0]
    assert Path(rules_path).exists()

    # Check content
    content = Path(rules_path).read_text()
    assert "# Development Guidelines" in content
    assert "Auto-generated by Charlie" in content
    assert "## Available Commands" in content
    assert "/test.init" in content
    assert "MANUAL ADDITIONS START" in content


def test_generate_rules_file_preserves_manual_additions(tmp_path) -> None:
    """Test that rules file preserves manual additions on regeneration."""
    config = CharlieConfig(
        version="1.0",
        project=ProjectConfig(name="test", command_prefix="test"),
        commands=[
            Command(
                name="init",
                description="Initialize",
                prompt="Test",
                scripts=CommandScripts(sh="init.sh"),
            )
        ],
    )

    agent_spec = get_agent_spec("windsurf")

    # First generation
    rules_paths = generate_rules_file(config, "windsurf", agent_spec, str(tmp_path))
    rules_path = rules_paths[0]

    # Add manual content
    content = Path(rules_path).read_text()
    content = content.replace(
        "<!-- MANUAL ADDITIONS START -->",
        "<!-- MANUAL ADDITIONS START -->\nMy custom rule\nAnother custom rule",
    )
    Path(rules_path).write_text(content)

    # Regenerate
    rules_paths = generate_rules_file(config, "windsurf", agent_spec, str(tmp_path))
    rules_path = rules_paths[0]

    # Check manual additions are preserved
    new_content = Path(rules_path).read_text()
    assert "My custom rule" in new_content
    assert "Another custom rule" in new_content


def test_generate_rules_file_custom_title(tmp_path) -> None:
    """Test generating rules file with custom title."""
    config = CharlieConfig(
        version="1.0",
        project=ProjectConfig(name="test", command_prefix="test"),
        rules=RulesConfig(title="Custom Title"),
        commands=[
            Command(
                name="test",
                description="Test",
                prompt="Test",
                scripts=CommandScripts(sh="test.sh"),
            )
        ],
    )

    agent_spec = get_agent_spec("claude")
    rules_paths = generate_rules_file(config, "claude", agent_spec, str(tmp_path))
    rules_path = rules_paths[0]

    content = Path(rules_path).read_text()
    assert "# Custom Title" in content


def test_generate_rules_file_without_commands(tmp_path) -> None:
    """Test generating rules file without command list."""
    config = CharlieConfig(
        version="1.0",
        project=ProjectConfig(name="test", command_prefix="test"),
        rules=RulesConfig(include_commands=False),
        commands=[
            Command(
                name="test",
                description="Test",
                prompt="Test",
                scripts=CommandScripts(sh="test.sh"),
            )
        ],
    )

    agent_spec = get_agent_spec("claude")
    rules_paths = generate_rules_file(config, "claude", agent_spec, str(tmp_path))
    rules_path = rules_paths[0]

    content = Path(rules_path).read_text()
    assert "## Available Commands" not in content
    assert "/test.test" not in content


def test_generate_rules_file_without_preserve(tmp_path) -> None:
    """Test generating rules file without manual preservation."""
    config = CharlieConfig(
        version="1.0",
        project=ProjectConfig(name="test", command_prefix="test"),
        rules=RulesConfig(preserve_manual=False),
        commands=[
            Command(
                name="test",
                description="Test",
                prompt="Test",
                scripts=CommandScripts(sh="test.sh"),
            )
        ],
    )

    agent_spec = get_agent_spec("claude")
    rules_paths = generate_rules_file(config, "claude", agent_spec, str(tmp_path))
    rules_path = rules_paths[0]

    content = Path(rules_path).read_text()
    assert "MANUAL ADDITIONS START" not in content


def test_generate_rules_for_agents(tmp_path) -> None:
    """Test generating rules files for multiple agents."""
    config = CharlieConfig(
        version="1.0",
        project=ProjectConfig(name="test", command_prefix="test"),
        commands=[
            Command(
                name="test",
                description="Test",
                prompt="Test",
                scripts=CommandScripts(sh="test.sh"),
            )
        ],
    )

    agent_specs = {
        "claude": get_agent_spec("claude"),
        "windsurf": get_agent_spec("windsurf"),
    }

    results = generate_rules_for_agents(config, ["claude", "windsurf"], agent_specs, str(tmp_path))

    assert len(results) == 2
    assert "claude" in results
    assert "windsurf" in results

    # Check both files exist (results now returns lists of paths)
    assert len(results["claude"]) >= 1
    assert Path(results["claude"][0]).exists()
    assert len(results["windsurf"]) >= 1
    assert Path(results["windsurf"][0]).exists()


def test_generate_rules_for_agents_skips_missing_rules_file(tmp_path) -> None:
    """Test that agents without rules_file are skipped."""
    config = CharlieConfig(
        version="1.0",
        project=ProjectConfig(name="test", command_prefix="test"),
        commands=[
            Command(
                name="test",
                description="Test",
                prompt="Test",
                scripts=CommandScripts(sh="test.sh"),
            )
        ],
    )

    # Create a fake agent spec without rules_file
    agent_specs = {"fake": {"name": "Fake Agent", "command_dir": ".fake"}}

    results = generate_rules_for_agents(config, ["fake"], agent_specs, str(tmp_path))

    # Should not generate anything for agent without rules_file
    assert len(results) == 0


def test_rules_file_date_format(tmp_path) -> None:
    """Test that rules file includes properly formatted date."""
    config = CharlieConfig(
        version="1.0",
        project=ProjectConfig(name="test", command_prefix="test"),
        commands=[
            Command(
                name="test",
                description="Test",
                prompt="Test",
                scripts=CommandScripts(sh="test.sh"),
            )
        ],
    )

    agent_spec = get_agent_spec("claude")
    rules_paths = generate_rules_file(config, "claude", agent_spec, str(tmp_path))
    rules_path = rules_paths[0]

    content = Path(rules_path).read_text()
    # Check date format YYYY-MM-DD
    import re

    assert re.search(r"Last updated: \d{4}-\d{2}-\d{2}", content)


def test_generate_rules_merged_mode_with_sections(tmp_path) -> None:
    """Test generating rules in merged mode with custom sections."""
    from charlie.schema import RulesSection

    config = CharlieConfig(
        version="1.0",
        project=ProjectConfig(name="test", command_prefix="test"),
        commands=[
            Command(
                name="test",
                description="Test",
                prompt="Test",
                scripts=CommandScripts(sh="test.sh"),
            )
        ],
        rules=RulesConfig(
            sections=[
                RulesSection(
                    title="Code Style",
                    content="Use Black for formatting",
                    order=1,
                    alwaysApply=True,  # Cursor-specific
                    globs=["**/*.py"],  # Cursor-specific
                ),
                RulesSection(
                    title="Commit Messages",
                    content="Use conventional commits",
                    order=2,
                ),
            ]
        ),
    )

    agent_spec = get_agent_spec("cursor")
    rules_paths = generate_rules_file(config, "cursor", agent_spec, str(tmp_path), mode="merged")

    assert len(rules_paths) == 1
    content = Path(rules_paths[0]).read_text()

    # Check frontmatter (from first section)
    assert "alwaysApply: true" in content
    assert "globs:" in content
    assert "**/*.py" in content

    # Check both sections are present
    assert "## Code Style" in content
    assert "Use Black for formatting" in content
    assert "## Commit Messages" in content
    assert "Use conventional commits" in content


def test_generate_rules_separate_mode(tmp_path) -> None:
    """Test generating rules in separate mode (one file per section)."""
    from charlie.schema import RulesSection

    config = CharlieConfig(
        version="1.0",
        project=ProjectConfig(name="test", command_prefix="test"),
        commands=[
            Command(
                name="test",
                description="Test",
                prompt="Test",
                scripts=CommandScripts(sh="test.sh"),
            )
        ],
        rules=RulesConfig(
            sections=[
                RulesSection(
                    title="Code Style",
                    content="Use Black for formatting",
                    order=1,
                    alwaysApply=True,
                ),
                RulesSection(
                    title="Commit Messages",
                    content="Use conventional commits",
                    order=2,
                ),
            ]
        ),
    )

    agent_spec = get_agent_spec("cursor")
    rules_paths = generate_rules_file(config, "cursor", agent_spec, str(tmp_path), mode="separate")

    # Should generate 2 separate files
    assert len(rules_paths) == 2

    # Check first file (code-style.md)
    style_file = [p for p in rules_paths if "code-style" in p][0]
    style_content = Path(style_file).read_text()
    assert "# Code Style" in style_content
    assert "Use Black for formatting" in style_content
    assert "alwaysApply: true" in style_content

    # Check second file (commit-messages.md)
    commit_file = [p for p in rules_paths if "commit-messages" in p][0]
    commit_content = Path(commit_file).read_text()
    assert "# Commit Messages" in commit_content
    assert "Use conventional commits" in commit_content
