name: "Release: Build and Publish"

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags (v1.0.0, v1.0.1, etc.)
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Required for creating releases
  id-token: write  # Required for SBOM attestations
  attestations: write  # Required for SBOM attestations

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for changelog generation
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine cyclonedx-bom
      
      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/v}
          echo "version=$TAG" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "Tag version: v$TAG"
      
      - name: Install setuptools-scm to verify version
        run: |
          pip install setuptools-scm
          DETECTED_VERSION=$(python -m setuptools_scm)
          echo "Version detected by setuptools-scm: $DETECTED_VERSION"
          echo "Expected from tag: ${{ steps.version.outputs.version }}"
          if [ "$DETECTED_VERSION" != "${{ steps.version.outputs.version }}" ]; then
            echo "Warning: Version mismatch between tag and setuptools-scm"
            echo "This might be expected if you have local commits"
          fi
      
      - name: Build package
        run: |
          python -m build
          echo "Built packages:"
          ls -lh dist/
      
      - name: Generate SBOM
        run: |
          python -m venv sbom-venv
          sbom-venv/bin/pip install --upgrade pip
          sbom-venv/bin/pip install dist/phasor_point_cli-${{ steps.version.outputs.version }}-py3-none-any.whl
          # Generate SBOM from installed package in venv
          # Note: --pyproject flag removed as it's not supported by cyclonedx-py environment command
          # Metadata is captured from the installed package instead
          cyclonedx-py environment --of JSON -o dist/phasor-point-cli-${{ steps.version.outputs.version }}-sbom.json sbom-venv
          echo "Filtering out environment packages (pip)..."
          jq 'del(.components[]? | select(.name == "pip")) | .dependencies |= map(select(.ref | startswith("pip==") | not)) | .dependencies[]? |= (if .dependsOn then .dependsOn |= map(select(startswith("pip==") | not)) else . end)' dist/phasor-point-cli-${{ steps.version.outputs.version }}-sbom.json > dist/phasor-point-cli-${{ steps.version.outputs.version }}-sbom.json.tmp && mv dist/phasor-point-cli-${{ steps.version.outputs.version }}-sbom.json.tmp dist/phasor-point-cli-${{ steps.version.outputs.version }}-sbom.json
          rm -rf sbom-venv
          echo "Generated SBOM:"
          ls -lh dist/*.json
      
      - name: Verify package integrity
        run: |
          twine check dist/*.whl dist/*.tar.gz
      
      - name: Generate SBOM attestation for wheel
        uses: actions/attest-sbom@v2
        with:
          subject-path: dist/phasor_point_cli-${{ steps.version.outputs.version }}-py3-none-any.whl
          sbom-path: dist/phasor-point-cli-${{ steps.version.outputs.version }}-sbom.json
      
      - name: Generate SBOM attestation for source distribution
        uses: actions/attest-sbom@v2
        with:
          subject-path: dist/phasor_point_cli-${{ steps.version.outputs.version }}.tar.gz
          sbom-path: dist/phasor-point-cli-${{ steps.version.outputs.version }}-sbom.json
      
      - name: Generate release notes
        id: release_notes
        run: |
          echo "## What's Changed" > release_notes.md
          echo "" >> release_notes.md
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            echo "See the [CHANGELOG](https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${{ steps.version.outputs.tag }}) for detailed changes." >> release_notes.md
          else
            echo "Initial release." >> release_notes.md
          fi
          echo "" >> release_notes.md
          echo "## Installation" >> release_notes.md
          echo "" >> release_notes.md
          echo '```bash' >> release_notes.md
          echo "# Install from wheel" >> release_notes.md
          echo "pip install https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/phasor_point_cli-${{ steps.version.outputs.version }}-py3-none-any.whl" >> release_notes.md
          echo "" >> release_notes.md
          echo "# Or install from source" >> release_notes.md
          echo "pip install https://github.com/${{ github.repository }}/archive/${{ steps.version.outputs.tag }}.tar.gz" >> release_notes.md
          echo '```' >> release_notes.md
          echo "" >> release_notes.md
          echo "## Files" >> release_notes.md
          echo "" >> release_notes.md
          echo "- \`phasor_point_cli-${{ steps.version.outputs.version }}-py3-none-any.whl\` - Python wheel (recommended)" >> release_notes.md
          echo "- \`phasor_point_cli-${{ steps.version.outputs.version }}.tar.gz\` - Source distribution" >> release_notes.md
          echo "- \`phasor-point-cli-${{ steps.version.outputs.version }}-sbom.json\` - Software Bill of Materials (SBOM)" >> release_notes.md
          echo "" >> release_notes.md
          echo "## Security" >> release_notes.md
          echo "" >> release_notes.md
          echo "All artifacts include signed SBOM attestations for supply chain verification." >> release_notes.md
          echo "" >> release_notes.md
          echo "To verify an artifact:" >> release_notes.md
          echo '```bash' >> release_notes.md
          echo "gh attestation verify phasor_point_cli-${{ steps.version.outputs.version }}-py3-none-any.whl -R ${{ github.repository }}" >> release_notes.md
          echo '```' >> release_notes.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.whl
            dist/*.tar.gz
            dist/*-sbom.json
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Release summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Successfully released version ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release URL:** https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -lh dist/ >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY