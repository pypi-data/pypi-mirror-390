terraform {
  required_version = ">= 1.5.0"

  # Backend configuration is generated by setup.sh
  # Creates backend.tf with your S3 settings
  # Run: ./setup.sh to configure

  required_providers {
    github = {
      source  = "integrations/github"
      version = "~> 6.0"
    }
  }
}

provider "github" {
  owner = var.github_owner
  # Token should be set via GITHUB_TOKEN environment variable
}

# Repository reference
data "github_repository" "repo" {
  full_name = var.github_full_name != "" ? var.github_full_name : "${var.github_owner}/${var.github_repository}"
}

# Set default branch to main
resource "github_branch_default" "default" {
  repository = data.github_repository.repo.name
  branch     = "main"
}

# Branch protection for main (production)
resource "github_branch_protection" "main" {
  repository_id = data.github_repository.repo.node_id
  pattern       = "main"

  enforce_admins                  = false # Allow admins to bypass in emergencies
  require_signed_commits          = false
  required_linear_history         = false
  require_conversation_resolution = true

  # Require pull request reviews
  required_pull_request_reviews {
    dismiss_stale_reviews           = true
    require_code_owner_reviews      = true  # Require CODEOWNERS approval
    required_approving_review_count = 1
    restrict_dismissals             = false
  }

  # Require status checks to pass
  required_status_checks {
    strict = true # Require branches to be up to date before merging
    contexts = [
      "test (ubuntu-latest, 3.10)",
      "test (ubuntu-latest, 3.11)",
      "test (ubuntu-latest, 3.12)",
      "test (ubuntu-latest, 3.13)",
      "test (macos-latest, 3.10)",
      "test (macos-latest, 3.11)",
      "test (macos-latest, 3.12)",
      "test (macos-latest, 3.13)",
      "build",
      "docs",
    ]
  }

  # Restrict who can push to main
  restrict_pushes {
    blocks_creations = false
    push_allowances  = [] # Only via PR
  }

  allows_force_pushes = false
  allows_deletions    = false
}

# Repository settings
resource "github_repository" "settings" {
  name        = data.github_repository.repo.name
  description = "A clean, Pythonic wrapper for MLB Stats API with automatic schema-driven parameter validation"

  homepage_url = "https://pymlb-statsapi.readthedocs.io/"

  visibility = "public"

  has_issues      = true
  has_discussions = true
  has_projects    = true
  has_wiki        = false

  # Enable vulnerability alerts and automated security fixes
  vulnerability_alerts   = true
  delete_branch_on_merge = true

  # Allow squash merging (recommended for feature branches)
  allow_squash_merge = true
  allow_merge_commit = true
  allow_rebase_merge = true

  # Topics/tags for discoverability
  topics = [
    "mlb",
    "baseball",
    "stats",
    "api",
    "python",
    "sports",
    "statsapi",
    "python3",
    "schema-driven",
    "mlb-stats",
    "baseball-data",
    "sports-data",
  ]

  lifecycle {
    prevent_destroy = true
  }
}

# Issue labels for better organization
resource "github_issue_label" "bug" {
  repository  = data.github_repository.repo.name
  name        = "bug"
  color       = "d73a4a"
  description = "Something isn't working"
}

resource "github_issue_label" "enhancement" {
  repository  = data.github_repository.repo.name
  name        = "enhancement"
  color       = "a2eeef"
  description = "New feature or request"
}

resource "github_issue_label" "documentation" {
  repository  = data.github_repository.repo.name
  name        = "documentation"
  color       = "0075ca"
  description = "Improvements or additions to documentation"
}

resource "github_issue_label" "good_first_issue" {
  repository  = data.github_repository.repo.name
  name        = "good first issue"
  color       = "7057ff"
  description = "Good for newcomers"
}

resource "github_issue_label" "help_wanted" {
  repository  = data.github_repository.repo.name
  name        = "help wanted"
  color       = "008672"
  description = "Extra attention is needed"
}

resource "github_issue_label" "question" {
  repository  = data.github_repository.repo.name
  name        = "question"
  color       = "d876e3"
  description = "Further information is requested"
}

resource "github_issue_label" "wontfix" {
  repository  = data.github_repository.repo.name
  name        = "wontfix"
  color       = "ffffff"
  description = "This will not be worked on"
}

resource "github_issue_label" "duplicate" {
  repository  = data.github_repository.repo.name
  name        = "duplicate"
  color       = "cfd3d7"
  description = "This issue or pull request already exists"
}

resource "github_issue_label" "tests" {
  repository  = data.github_repository.repo.name
  name        = "tests"
  color       = "fbca04"
  description = "Related to testing"
}

resource "github_issue_label" "ci_cd" {
  repository  = data.github_repository.repo.name
  name        = "ci/cd"
  color       = "c5def5"
  description = "Related to continuous integration or deployment"
}

# CODEOWNERS file for automatic review requests
resource "github_repository_file" "codeowners" {
  repository          = data.github_repository.repo.name
  branch              = "main"
  file                = ".github/CODEOWNERS"
  commit_message      = "chore: manage CODEOWNERS via Terraform"
  commit_author       = "Nikolaus Schuetz"
  commit_email        = "nikolauspschuetz@gmail.com"
  overwrite_on_create = true

  content = <<-EOT
    # Code Owners for PyMLB StatsAPI
    #
    # These users/teams will be automatically requested for review when someone
    # opens a pull request that modifies files matching the patterns below.
    #
    # More info: https://docs.github.com/en/repositories/managing-your-repositorys-settings-and-features/customizing-your-repository/about-code-owners

    # Default owners for everything in the repo
    * @nikolauspschuetz

    # Core package code - requires review from maintainers
    /pymlb_statsapi/ @nikolauspschuetz

    # Tests - maintainers review
    /tests/ @nikolauspschuetz

    # Infrastructure and CI/CD - requires admin review
    /.github/ @nikolauspschuetz
    /scripts/ @nikolauspschuetz

    # Documentation
    /docs/ @nikolauspschuetz
    *.md @nikolauspschuetz

    # Configuration files - requires careful review
    pyproject.toml @nikolauspschuetz
    setup.py @nikolauspschuetz
    *.cfg @nikolauspschuetz
    *.ini @nikolauspschuetz
  EOT
}

# Outputs for documentation
output "repository" {
  value = {
    name           = data.github_repository.repo.name
    default_branch = github_branch_default.default.branch
    branches = {
      main = "protected, requires PR approval, all CI checks must pass"
    }
    codeowners_managed = "via Terraform"
  }
}
