syntax = "proto3";

package queue_service;

// 错误码枚举
enum ErrorCode {
  ERROR_UNKNOWN = 0;                    // 未知错误
  ERROR_INVALID_REQUEST = 1;            // 无效请求
  ERROR_INVALID_AGENT_ID = 2;           // 无效的 Agent ID
  ERROR_INVALID_TASK_ID = 3;            // 无效的任务 ID
  ERROR_INVALID_PAYLOAD = 4;            // 无效的任务负载（JSON 格式错误）
  ERROR_INVALID_TASK_TYPE = 5;          // 无效的任务类型
  ERROR_QUEUE_NOT_FOUND = 6;            // 队列不存在
  ERROR_TASK_NOT_FOUND = 7;             // 任务不存在
  ERROR_TASK_ALREADY_EXISTS = 8;        // 任务已存在
  ERROR_QUEUE_ALREADY_EXISTS = 9;       // 队列已存在
  ERROR_INTERNAL_ERROR = 10;            // 内部错误
  ERROR_REDIS_ERROR = 11;               // Redis 错误
  ERROR_TIMEOUT = 12;                   // 超时
  ERROR_RATE_LIMIT_EXCEEDED = 13;       // 超过速率限制
  ERROR_DUPLICATE_REQUEST = 14;         // 重复请求（幂等性检查）
  ERROR_INVALID_STATUS_TRANSITION = 15; // 无效的状态转换
  ERROR_PAYLOAD_TOO_LARGE = 16;         // 负载过大
}

// 任务状态
enum TaskStatus {
  PENDING = 0;      // 待处理
  PROCESSING = 1;   // 处理中
  COMPLETED = 2;    // 已完成
  FAILED = 3;       // 失败
}

// 任务类型
enum TaskType {
  UNKNOWN = 0;           // 未知类型
  DATA_PROCESSING = 1;   // 数据处理
  IMAGE_PROCESSING = 2;  // 图像处理
  TEXT_ANALYSIS = 3;     // 文本分析
  MODEL_INFERENCE = 4;   // 模型推理
  DATA_EXTRACTION = 5;   // 数据提取
  FILE_UPLOAD = 6;       // 文件上传
  FILE_DOWNLOAD = 7;     // 文件下载
  API_CALL = 8;          // API 调用
  DATABASE_QUERY = 9;    // 数据库查询
  CUSTOM = 99;           // 自定义类型（使用字符串 task_type 字段）
}

// 错误详情
message ErrorDetail {
  ErrorCode code = 1;           // 错误码
  string message = 2;           // 错误消息
  string field = 3;             // 出错的字段（如果有）
  map<string, string> metadata = 4; // 额外的错误元数据
}

// 请求元数据（可选，用于追踪和调试）
message RequestMetadata {
  string request_id = 1;        // 请求ID（客户端生成，用于幂等性和追踪）
  int64 timestamp = 2;          // 请求时间戳（Unix时间戳，毫秒）
  string client_id = 3;         // 客户端ID（可选）
  map<string, string> tags = 4; // 自定义标签（可选）
}

// 响应元数据
message ResponseMetadata {
  string request_id = 1;        // 对应的请求ID
  int64 timestamp = 2;          // 响应时间戳（Unix时间戳，毫秒）
  int32 processing_time_ms = 3; // 处理时间（毫秒）
  string server_version = 4;    // 服务器版本
}

// 任务对象
message Task {
  string task_id = 1;           // 任务ID
  string agent_id = 2;          // Agent ID
  TaskType type = 3;            // 任务类型（枚举）
  string task_type = 4;         // 任务类型（字符串，当 type = CUSTOM 时使用）
  string payload = 5;           // 任务负载（JSON字符串）
  TaskStatus status = 6;        // 任务状态
  int64 created_at = 7;         // 创建时间（Unix时间戳，秒）
  int64 updated_at = 8;         // 更新时间（Unix时间戳，秒）
  string result = 9;            // 任务结果（JSON字符串）
  string error_message = 10;    // 错误信息
  string client_request_id = 11; // 客户端请求ID（用于幂等性）
  int32 priority = 12;          // 任务优先级（0-9，数字越大优先级越高，默认5）
}

// 提交任务请求
message SubmitTaskRequest {
  string agent_id = 1;          // Agent ID（必填，长度1-128）
  TaskType type = 2;            // 任务类型（枚举，必填）
  string task_type = 3;         // 任务类型（字符串，当 type = CUSTOM 时必填，长度1-64）
  string payload = 4;           // 任务负载（JSON字符串，必填，最大1MB）
  string client_request_id = 5; // 客户端请求ID（可选，用于幂等性，长度1-128）
  int32 priority = 6;           // 任务优先级（可选，0-9，数字越大优先级越高，默认5）
  RequestMetadata metadata = 7; // 请求元数据（可选）
}

// 提交任务响应
message SubmitTaskResponse {
  bool success = 1;             // 是否成功
  string task_id = 2;           // 任务ID
  string message = 3;           // 消息
  ErrorDetail error = 4;        // 错误详情（如果失败）
  ResponseMetadata metadata = 5; // 响应元数据
}

// 获取任务请求
message GetTaskRequest {
  string agent_id = 1;          // Agent ID（必填）
  int32 timeout = 2;            // 超时时间（秒），0表示不等待，最大300秒
  RequestMetadata metadata = 3; // 请求元数据（可选）
}

// 获取任务响应
message GetTaskResponse {
  bool success = 1;             // 是否成功
  Task task = 2;                // 任务对象
  string message = 3;           // 消息
  ErrorDetail error = 4;        // 错误详情（如果失败）
  ResponseMetadata metadata = 5; // 响应元数据
}

// 更新任务状态请求
message UpdateTaskStatusRequest {
  string task_id = 1;           // 任务ID（必填）
  string agent_id = 2;          // Agent ID（必填）
  TaskStatus status = 3;        // 新状态（必填）
  string result = 4;            // 任务结果（可选，JSON字符串，最大1MB）
  string error_message = 5;     // 错误信息（可选，最大1024字符）
  RequestMetadata metadata = 6; // 请求元数据（可选）
}

// 更新任务状态响应
message UpdateTaskStatusResponse {
  bool success = 1;             // 是否成功
  string message = 2;           // 消息
  ErrorDetail error = 3;        // 错误详情（如果失败）
  ResponseMetadata metadata = 4; // 响应元数据
}

// 查询任务请求
message QueryTaskRequest {
  string task_id = 1;           // 任务ID（必填）
  string agent_id = 2;          // Agent ID（必填）
  RequestMetadata metadata = 3; // 请求元数据（可选）
}

// 查询任务响应
message QueryTaskResponse {
  bool success = 1;             // 是否成功
  Task task = 2;                // 任务对象
  string message = 3;           // 消息
  ErrorDetail error = 4;        // 错误详情（如果失败）
  ResponseMetadata metadata = 5; // 响应元数据
}

// 列出任务请求
message ListTasksRequest {
  string agent_id = 1;          // Agent ID（必填）
  TaskStatus status = 2;        // 任务状态（可选，0表示所有状态）
  int32 limit = 3;              // 限制数量（1-1000，默认100）
  int32 offset = 4;             // 偏移量（>=0，默认0）
  RequestMetadata metadata = 5; // 请求元数据（可选）
}

// 列出任务响应
message ListTasksResponse {
  bool success = 1;             // 是否成功
  repeated Task tasks = 2;      // 任务列表
  int32 total = 3;              // 总数
  string message = 4;           // 消息
  ErrorDetail error = 5;        // 错误详情（如果失败）
  ResponseMetadata metadata = 6; // 响应元数据
}

// 创建队列请求
message CreateQueueRequest {
  string agent_id = 1;          // Agent ID（必填，长度1-128）
  RequestMetadata metadata = 2; // 请求元数据（可选）
}

// 创建队列响应
message CreateQueueResponse {
  bool success = 1;             // 是否成功
  string agent_id = 2;          // Agent ID
  string message = 3;           // 消息
  bool already_exists = 4;      // 队列是否已存在（true=已存在，false=新创建）
  ErrorDetail error = 5;        // 错误详情（如果失败）
  ResponseMetadata metadata = 6; // 响应元数据
}

// 获取队列信息请求
message GetQueueInfoRequest {
  string agent_id = 1;          // Agent ID（必填）
  RequestMetadata metadata = 2; // 请求元数据（可选）
}

// 获取队列信息响应
message GetQueueInfoResponse {
  bool success = 1;             // 是否成功
  string agent_id = 2;          // Agent ID
  int32 pending_count = 3;      // 待处理任务数
  int32 processing_count = 4;   // 处理中任务数
  int32 completed_count = 5;    // 已完成任务数
  int32 failed_count = 6;       // 失败任务数
  int32 total_count = 7;        // 总任务数
  string message = 8;           // 消息
  ErrorDetail error = 9;        // 错误详情（如果失败）
  ResponseMetadata metadata = 10; // 响应元数据
}

// 删除任务请求
message DeleteTaskRequest {
  string task_id = 1;           // 任务ID（必填）
  string agent_id = 2;          // Agent ID（必填）
  RequestMetadata metadata = 3; // 请求元数据（可选）
}

// 删除任务响应
message DeleteTaskResponse {
  bool success = 1;             // 是否成功
  string message = 2;           // 消息
  ErrorDetail error = 3;        // 错误详情（如果失败）
  ResponseMetadata metadata = 4; // 响应元数据
}

// 批量删除任务请求
message BatchDeleteTasksRequest {
  string agent_id = 1;          // Agent ID（必填）
  repeated string task_ids = 2; // 任务ID列表（最多1000个）
  TaskStatus status = 3;        // 可选：按状态删除（0表示不限制状态）
  RequestMetadata metadata = 4; // 请求元数据（可选）
}

// 批量删除任务项结果
message BatchDeleteTaskResult {
  string task_id = 1;           // 任务ID
  bool success = 2;             // 是否成功
  ErrorDetail error = 3;        // 错误详情（如果失败）
}

// 批量删除任务响应
message BatchDeleteTasksResponse {
  bool success = 1;             // 是否全部成功
  int32 deleted_count = 2;      // 删除的任务数量
  int32 failed_count = 3;       // 失败的任务数量
  repeated BatchDeleteTaskResult results = 4; // 每个任务的删除结果
  string message = 5;           // 消息
  ErrorDetail error = 6;        // 整体错误详情（如果整体失败）
  ResponseMetadata metadata = 7; // 响应元数据
}

// 清空队列请求
message ClearQueueRequest {
  string agent_id = 1;          // Agent ID（必填）
  TaskStatus status = 2;        // 可选：按状态清空（0表示清空所有状态）
  bool confirm = 3;             // 确认标志（必须为true才能执行清空操作）
  RequestMetadata metadata = 4; // 请求元数据（可选）
}

// 清空队列响应
message ClearQueueResponse {
  bool success = 1;             // 是否成功
  int32 cleared_count = 2;      // 清空的任务数量
  string message = 3;           // 消息
  ErrorDetail error = 4;        // 错误详情（如果失败）
  ResponseMetadata metadata = 5; // 响应元数据
}

// 删除队列请求（完全删除队列，包括所有任务和队列本身）
message DeleteQueueRequest {
  string agent_id = 1;          // Agent ID（必填）
  bool confirm = 2;             // 确认标志（必须为true才能执行删除操作）
  RequestMetadata metadata = 3; // 请求元数据（可选）
}

// 删除队列响应
message DeleteQueueResponse {
  bool success = 1;             // 是否成功
  int32 deleted_count = 2;      // 删除的任务数量
  string message = 3;           // 消息
  ErrorDetail error = 4;        // 错误详情（如果失败）
  ResponseMetadata metadata = 5; // 响应元数据
}

// 获取某个状态的任务请求
message GetTasksByStatusRequest {
  string agent_id = 1;          // Agent ID（必填）
  TaskStatus status = 2;        // 任务状态（必填，不能为0）
  int32 limit = 3;              // 限制数量（1-1000，默认100）
  int32 offset = 4;             // 偏移量（>=0，默认0）
  RequestMetadata metadata = 5; // 请求元数据（可选）
}

// 获取某个状态的任务响应
message GetTasksByStatusResponse {
  bool success = 1;             // 是否成功
  repeated Task tasks = 2;      // 任务列表
  int32 total = 3;              // 总数
  TaskStatus status = 4;        // 查询的状态
  string message = 5;           // 消息
  ErrorDetail error = 6;        // 错误详情（如果失败）
  ResponseMetadata metadata = 7; // 响应元数据
}

// 批量提交任务请求
message BatchSubmitTasksRequest {
  string agent_id = 1;          // Agent ID（必填）
  repeated SubmitTaskItem tasks = 2; // 任务列表（最多1000个）
  RequestMetadata metadata = 3; // 请求元数据（可选）
}

// 批量提交任务项
message SubmitTaskItem {
  TaskType type = 1;            // 任务类型（枚举，必填）
  string task_type = 2;         // 任务类型（字符串，当 type = CUSTOM 时必填）
  string payload = 3;           // 任务负载（JSON字符串，必填，最大1MB）
  string task_id = 4;           // 可选：指定任务ID（不提供则自动生成）
  string client_request_id = 5; // 可选：客户端请求ID（用于幂等性）
  int32 priority = 6;           // 可选：任务优先级（0-9，数字越大优先级越高，默认5）
}

// 批量提交任务项结果
message BatchSubmitTaskResult {
  int32 index = 1;              // 任务在请求中的索引
  string task_id = 2;           // 任务ID（如果成功）
  bool success = 3;             // 是否成功
  ErrorDetail error = 4;        // 错误详情（如果失败）
}

// 批量提交任务响应
message BatchSubmitTasksResponse {
  bool success = 1;             // 是否全部成功
  repeated string task_ids = 2; // 提交成功的任务ID列表
  int32 success_count = 3;      // 成功数量
  int32 failed_count = 4;       // 失败数量
  repeated BatchSubmitTaskResult results = 5; // 每个任务的提交结果
  string message = 6;           // 消息
  ErrorDetail error = 7;        // 整体错误详情（如果整体失败）
  ResponseMetadata metadata = 8; // 响应元数据
}

// 取消任务请求
message CancelTaskRequest {
  string task_id = 1;           // 任务ID（必填）
  string agent_id = 2;          // Agent ID（必填）
  string reason = 3;            // 可选：取消原因（最大512字符）
  RequestMetadata metadata = 4; // 请求元数据（可选）
}

// 取消任务响应
message CancelTaskResponse {
  bool success = 1;             // 是否成功
  string message = 2;           // 消息
  ErrorDetail error = 3;        // 错误详情（如果失败）
  ResponseMetadata metadata = 4; // 响应元数据
}

// 重试任务请求
message RetryTaskRequest {
  string task_id = 1;           // 任务ID（必填）
  string agent_id = 2;          // Agent ID（必填）
  string client_request_id = 3; // 可选：新任务的客户端请求ID（用于幂等性）
  RequestMetadata metadata = 4; // 请求元数据（可选）
}

// 重试任务响应
message RetryTaskResponse {
  bool success = 1;             // 是否成功
  string new_task_id = 2;       // 新任务ID（如果创建了新任务）
  string message = 3;           // 消息
  ErrorDetail error = 4;        // 错误详情（如果失败）
  ResponseMetadata metadata = 5; // 响应元数据
}

// 检查队列是否存在请求
message QueueExistsRequest {
  string agent_id = 1;          // Agent ID（必填）
  RequestMetadata metadata = 2; // 请求元数据（可选）
}

// 检查队列是否存在响应
message QueueExistsResponse {
  bool exists = 1;              // 队列是否存在
  string message = 2;           // 消息
  ErrorDetail error = 3;        // 错误详情（如果失败）
  ResponseMetadata metadata = 4; // 响应元数据
}

// 获取任务统计信息请求
message GetTaskStatsRequest {
  string agent_id = 1;          // Agent ID（必填）
  TaskStatus status = 2;        // 可选：按状态统计（0表示所有状态）
  RequestMetadata metadata = 3; // 请求元数据（可选）
}

// 获取任务统计信息响应
message GetTaskStatsResponse {
  bool success = 1;             // 是否成功
  int32 total_count = 2;        // 总任务数
  int32 pending_count = 3;      // 待处理任务数
  int32 processing_count = 4;   // 处理中任务数
  int32 completed_count = 5;    // 已完成任务数
  int32 failed_count = 6;       // 失败任务数
  string message = 7;           // 消息
  ErrorDetail error = 8;        // 错误详情（如果失败）
  ResponseMetadata metadata = 9; // 响应元数据
}

// 健康检查请求
message HealthCheckRequest {
  string service = 1;           // 服务名称（可选，默认为 "queue_service"）
}

// 健康检查响应
message HealthCheckResponse {
  enum ServingStatus {
    UNKNOWN = 0;
    SERVING = 1;                // 服务正常
    NOT_SERVING = 2;            // 服务不可用
    SERVICE_UNKNOWN = 3;        // 服务未知
  }
  ServingStatus status = 1;     // 服务状态
  string version = 2;           // 服务版本
  int64 timestamp = 3;          // 检查时间戳（Unix时间戳，毫秒）
  map<string, string> details = 4; // 详细信息（如 Redis 连接状态等）
}

// ========== 实时报表相关消息 ==========

// 流式队列报表请求
message StreamQueueReportsRequest {
  repeated string agent_ids = 1; // Agent ID 列表（空列表表示监控所有 agent）
  int32 update_interval_seconds = 2; // 更新间隔（秒，默认5秒，最小1秒，最大60秒）
  bool include_task_details = 3; // 是否包含任务详情（默认false，只返回统计信息）
  RequestMetadata metadata = 4; // 请求元数据（可选）
}

// 单个 Agent 队列报表
message AgentQueueReport {
  string agent_id = 1;          // Agent ID
  int64 timestamp = 2;          // 报表时间戳（Unix时间戳，毫秒）
  bool queue_exists = 3;        // 队列是否存在
  
  // 任务统计
  int32 pending_count = 4;      // 待处理任务数
  int32 processing_count = 5;   // 处理中任务数
  int32 completed_count = 6;    // 已完成任务数
  int32 failed_count = 7;       // 失败任务数
  int32 total_count = 8;        // 总任务数
  
  // 完成情况统计
  int32 success_rate = 9;       // 成功率（百分比，0-100，基于已完成和失败的任务）
  int32 completion_rate = 10;   // 完成率（百分比，0-100，已完成/总数）
  
  // 可选：任务详情（当 include_task_details=true 时）
  repeated Task recent_tasks = 11; // 最近的任务列表（最多10个）
  
  // 队列健康状态
  enum QueueHealth {
    HEALTHY = 0;                // 健康（无失败任务或失败率低）
    WARNING = 1;                // 警告（有失败任务或队列积压）
    CRITICAL = 2;               // 严重（大量失败任务或严重积压）
    UNKNOWN = 3;                // 未知（队列不存在）
  }
  QueueHealth health = 12;      // 队列健康状态
  string health_message = 13;   // 健康状态说明
}

// 队列报表（包含多个 Agent 的信息）
message QueueReport {
  int64 timestamp = 1;          // 报表时间戳（Unix时间戳，毫秒）
  repeated AgentQueueReport agent_reports = 2; // Agent 报表列表
  int32 total_agents = 3;       // 总 Agent 数量
  int32 active_agents = 4;      // 活跃 Agent 数量（有任务的 Agent）
  
  // 全局统计
  int32 total_pending = 5;      // 全局待处理任务数
  int32 total_processing = 6;   // 全局处理中任务数
  int32 total_completed = 7;    // 全局已完成任务数
  int32 total_failed = 8;       // 全局失败任务数
  int32 total_tasks = 9;        // 全局总任务数
  
  // 全局完成情况
  int32 global_success_rate = 10; // 全局成功率（百分比）
  int32 global_completion_rate = 11; // 全局完成率（百分比）
  string message = 12;          // 消息（可选，用于错误信息等）
}

// 队列服务
service QueueService {
  // ========== 健康检查接口 ==========
  
  // 健康检查（用于监控和负载均衡）
  rpc HealthCheck(HealthCheckRequest) returns (HealthCheckResponse);
  
  // ========== 队列管理接口 ==========
  
  // 创建 agent 私有任务队列（根据 agentID 路由）
  rpc CreateQueue(CreateQueueRequest) returns (CreateQueueResponse);
  
  // 检查队列是否存在（根据 agentID 路由）
  rpc QueueExists(QueueExistsRequest) returns (QueueExistsResponse);
  
  // 获取队列信息（根据 agentID 路由）
  rpc GetQueueInfo(GetQueueInfoRequest) returns (GetQueueInfoResponse);
  
  // 清空队列（根据 agentID 路由，可选按状态清空）
  rpc ClearQueue(ClearQueueRequest) returns (ClearQueueResponse);
  
  // 删除队列（根据 agentID 路由，完全删除队列包括所有任务和队列本身）
  rpc DeleteQueue(DeleteQueueRequest) returns (DeleteQueueResponse);
  
  // ========== 任务操作接口 ==========
  
  // 提交任务到某个 agent 的私有化任务队列（根据 agentID 路由）
  // 支持幂等性：通过 client_request_id 实现
  rpc SubmitTask(SubmitTaskRequest) returns (SubmitTaskResponse);
  
  // 批量提交任务到某个 agent 的私有化任务队列（根据 agentID 路由）
  // 支持幂等性：每个任务可通过 client_request_id 实现
  rpc BatchSubmitTasks(BatchSubmitTasksRequest) returns (BatchSubmitTasksResponse);
  
  // 从某个 agent 的私有化任务队列获取任务（根据 agentID 路由，主动拉取）
  rpc GetTask(GetTaskRequest) returns (GetTaskResponse);
  
  // 查询任务（根据 agentID 和 taskID）
  rpc QueryTask(QueryTaskRequest) returns (QueryTaskResponse);
  
  // 更新任务状态（根据 agentID 和 taskID）
  rpc UpdateTaskStatus(UpdateTaskStatusRequest) returns (UpdateTaskStatusResponse);
  
  // 删除任务（根据 agentID 和 taskID）
  rpc DeleteTask(DeleteTaskRequest) returns (DeleteTaskResponse);
  
  // 批量删除任务（根据 agentID 和 taskID 列表）
  rpc BatchDeleteTasks(BatchDeleteTasksRequest) returns (BatchDeleteTasksResponse);
  
  // 取消任务（根据 agentID 和 taskID）
  rpc CancelTask(CancelTaskRequest) returns (CancelTaskResponse);
  
  // 重试任务（根据 agentID 和 taskID，将失败任务重新提交）
  // 支持幂等性：通过 client_request_id 实现
  rpc RetryTask(RetryTaskRequest) returns (RetryTaskResponse);
  
  // ========== 任务查询接口 ==========
  
  // 列出某个 agent 的私有化任务队列中的所有任务（根据 agentID 路由）
  rpc ListTasks(ListTasksRequest) returns (ListTasksResponse);
  
  // 获取某个状态的任务（根据 agentID 和状态路由）
  rpc GetTasksByStatus(GetTasksByStatusRequest) returns (GetTasksByStatusResponse);
  
  // 获取任务统计信息（根据 agentID 路由）
  rpc GetTaskStats(GetTaskStatsRequest) returns (GetTaskStatsResponse);
  
  // ========== 实时报表接口 ==========
  
  // 实时监控多个 agent 的队列信息（流式返回）
  rpc StreamQueueReports(StreamQueueReportsRequest) returns (stream QueueReport);
}

