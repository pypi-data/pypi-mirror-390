[tools]
ruff = "latest"
python = "3.14"
uv = "latest"
rust = { version = "1.91.0", profile = "default" }

[tasks.python_lint]
description = "Run Python linting with ruff"
run = [
  "ruff check --fix .",
  "ruff format .",
]

[tasks.rust_lint]
description = "Run Rust linting with clippy and rustfmt"
run = [
  "cargo fmt",
  "cargo clippy --fix --allow-dirty --allow-staged --all-targets --all-features -- -D warnings",
]

[tasks.lint]
description = "Run all linting tasks"
depends = ["python_lint", "rust_lint"]

[tasks.test_py312]
description = "Run pytest with Python 3.12"
tools.python = "3.12"
usage = 'arg "[files]" var=#true help="Files to test"'
run = "uv tool run --with tox-uv tox -q -e py312 -- ${usage_files}"

[tasks.test_py313]
description = "Run pytest with Python 3.13"
tools.python = "3.13"
usage = 'arg "[files]" var=#true help="Files to test"'
run = "uv tool run --with tox-uv tox -q -e py313 -- ${usage_files}"

[tasks.test_py314]
description = "Run pytest with Python 3.14"
tools.python = "3.14"
alias = "test"
usage = 'arg "[files]" var=#true help="Files to test"'
run = "uv tool run --with tox-uv tox -q -e py314 -- ${usage_files}"

[tasks.test_all_versions]
description = "Run tests on all Python versions (3.12, 3.13, 3.14)"
usage = 'arg "[files]" var=#true help="Files to test"'
run = "mise run test_py312 ${usage_files} ::: test_py313 ${usage_files} ::: test_py314 ${usage_files}"

[tasks.build]
description = "Builds the project (in development mode)"
run = "uv build"

[tasks.coverage]
description = "Run code coverage for Python and Rust"
run = '''
  # Clean up old coverage files
  rm -f coverage_py.lcov coverage_rust.lcov coverage.lcov

  # Install cargo-llvm-cov if not present
  cargo install cargo-llvm-cov --quiet 2>/dev/null || true

  # Set up environment variables for Rust instrumentation coverage
  eval "$(cargo llvm-cov show-env --export-prefix 2>/dev/null | grep '^export')"

  # Clean previous profiling data
  cargo llvm-cov clean --workspace

  # Run Rust tests with coverage instrumentation
  cargo test

  # Build the Python extension with Rust instrumentation enabled
  uv run --with maturin maturin develop --uv

  # Run Python tests with Python coverage (this will also exercise Rust code)
  uv run --with pytest --with pytest-forked python -m covers --lcov --out coverage_py.lcov -m pytest || true

  # Generate Rust coverage report from all profraw files (includes coverage from Python tests)
  cargo llvm-cov report --lcov --output-path coverage_rust.lcov

  # Combine coverage files
  cat coverage_py.lcov coverage_rust.lcov > coverage.lcov

  echo 'Coverage generated: coverage_py.lcov (Python), coverage_rust.lcov (Rust), coverage.lcov (combined)'
'''
