# ğŸ“œ CrashLens v2.0 Legacy Policy Configuration
# Optimized suppression rules and budget policies for hybrid system

suppression_rules:
  # Retry Loop Detector - Highest priority
  retry_loop:
    enabled: true
    suppress_if_retry_loop: false  # Can't suppress itself
    threshold: 4  # More lenient for production
    
  # Fallback Storm Detector - Enhanced for v2.0
  fallback_storm:
    enabled: true
    suppress_if_retry_loop: true
    min_models: 2  # Must involve multiple models
    time_window_minutes: 5  # Expanded window
    
  # Fallback Failure Detector - Production optimized
  fallback_failure:
    enabled: true
    suppress_if_retry_loop: true
    expensive_models: ["gpt-4", "gpt-4-turbo", "claude-3-opus", "claude-3-sonnet"]
    
  # Overkill Model Detector - Enhanced thresholds
  overkill_model:
    enabled: true
    suppress_if_retry_loop: true  # Should be suppressed by higher priority detectors
    token_threshold: 50  # Increased from 20
    expensive_models: ["gpt-4", "claude-3-opus", "gpt-4-turbo"]

# ğŸ“Š Enhanced Budget Policy Enforcement (v2.0)
budget_policies:
  - name: gpt4_production_budget
    model: "gpt-4"
    monthly_cap_usd: 2000  # Increased for production
    daily_cap_usd: 100     # New daily limit
    threshold_alerts:
      - percentage: 60
        action: send_slack_alert
        message: "ğŸ“Š GPT-4 budget at 60% (${spent}/${budget}) - monitoring recommended"
      - percentage: 80
        action: send_slack_alert
        message: "âš ï¸ GPT-4 budget at 80% (${spent}/${budget}) - review usage patterns"
      - percentage: 95
        action: send_slack_alert
        message: "ğŸš¨ GPT-4 budget at 95% - implement cost controls immediately"
      - percentage: 100
        action: block_requests
        message: "ğŸ›‘ GPT-4 monthly budget exceeded - requests blocked until next cycle"
        
  - name: claude_opus_budget
    model: "claude-3-opus"
    monthly_cap_usd: 1000  # Increased limit
    daily_cap_usd: 50      # New daily limit
    threshold_alerts:
      - percentage: 75
        action: send_slack_alert
        message: "Claude-3-Opus budget at 75% - consider cheaper alternatives"
      - percentage: 90
        action: send_slack_alert  
        message: "ğŸš¨ Claude-3-Opus budget critical - implement restrictions"
      - percentage: 100
        action: block_requests
        message: "Claude-3-Opus budget exceeded - use claude-3-sonnet or cheaper models"

  # New: Overall organization budget
  - name: organization_total_budget
    model: "*"  # All models
    monthly_cap_usd: 5000
    daily_cap_usd: 200
    threshold_alerts:
      - percentage: 70
        action: send_slack_alert
        message: "ğŸ“ˆ Organization AI budget at 70% - cost optimization recommended"
      - percentage: 85
        action: send_slack_alert
        message: "âš ï¸ Organization AI budget at 85% - implement usage restrictions"
      - percentage: 100
        action: send_email_alert
        message: "ğŸš¨ CRITICAL: Organization AI budget exceeded - emergency review required"

# ğŸ§  2. Enhanced Overkill Model Policies
policies:
  - name: overkill_model_detection
    enabled: true
    trigger_conditions:
      model_is: ["gpt-4", "gpt-4-32k", "claude-3-opus"]
      input_tokens_lt: 50
      simple_task_keywords: ["summarize", "translate", "what is", "hello", "hi"]
      # Optional: comment_tags: ["#low_priority", "#simple"]
    actions:
      - type: log_event
        severity: "medium"
      - type: send_slack_alert
        template: "ğŸ’° Overkill detected: ${model} for ${prompt_preview} (${cost_estimate})"
      - type: suggest_routing
        route_to: "gpt-3.5-turbo"
        savings_estimate: true

# ğŸŒ©ï¸ 3. Enhanced Fallback Policies        
  - name: fallback_storm_detection
    enabled: true
    trigger_conditions:
      min_calls: 3
      min_distinct_models: 2
      max_trace_window_minutes: 3
    suppression_rules:
      suppress_if_retry_loop: true
    actions:
      - type: log_event
        severity: "high"
      - type: send_slack_alert
        template: "ğŸŒªï¸ Fallback storm: ${models_used} in ${duration}min (waste: ${waste_usd})"
        
  - name: fallback_failure_detection
    enabled: true
    trigger_conditions:
      time_window_minutes: 5
      cheaper_fails_before_expensive_succeeds: true
    suppression_rules:
      suppress_if_retry_loop: true
    actions:
      - type: log_event
        severity: "medium"
      - type: send_slack_alert
        template: "ğŸ’¸ Fallback failure pattern detected (waste: ${waste_usd})"

# Global settings
global:
  include_suppressed_by_default: false
  show_suppression_summary: true
  transparency_mode: true  # Always show what was suppressed and why

# ğŸ”§ Enhanced Detector Thresholds
thresholds:
  retry_loop:
    max_retries: 3
    time_window_minutes: 5
    max_retry_interval_minutes: 2
    
  fallback_storm:
    min_calls: 3
    min_models: 2
    max_trace_window_minutes: 3
    
  fallback_failure:
    time_window_seconds: 300
    
  overkill_model:
    max_prompt_tokens: 20
    max_prompt_chars: 150
    expensive_models:
      - "gpt-4"
      - "gpt-4-32k" 
      - "gpt-4-turbo"
      - "claude-3-opus"
      - "claude-3-sonnet"
