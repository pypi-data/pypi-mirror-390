{%- if scheduler_backend != "memory" -%}
"""
Scheduled task CLI commands.

Provides command-line interface for managing scheduled jobs,
viewing job statistics, and manually triggering tasks.
"""

import asyncio
import json
from datetime import datetime
from typing import Any

from rich import print as rprint
from rich.console import Console
from rich.panel import Panel
from rich.table import Table
import typer

from app.core.log import logger
from app.services.scheduler import ScheduledTaskManager
from app.services.scheduler.models import ScheduledTask

app = typer.Typer(
    name="tasks",
    help="Scheduled task management commands",
    no_args_is_help=True,
)

console = Console()


@app.command("list")
def list_jobs() -> None:
    """
    List all scheduled jobs with their current status.

    Shows job details including next run time, status, and configuration.
    """

    rprint("ğŸ“‹ [bold blue]Listing Scheduled Jobs[/bold blue]")

    try:
        tasks = asyncio.run(_get_scheduled_tasks())

        if not tasks:
            rprint("â„¹ï¸  [yellow]No scheduled jobs found[/yellow]")
            return

        table = Table(
            title="ğŸ•’ Scheduled Jobs",
            show_header=True,
            header_style="bold magenta",
        )
        table.add_column("Job ID", style="cyan", no_wrap=True)
        table.add_column("Name", style="green")
        table.add_column("Status", style="bold")
        table.add_column("Next Run", style="yellow")
        table.add_column("Trigger", style="dim")

        for task in tasks:
            status_color = "green" if task.is_active else "red"
            next_run = (
                task.next_run_time.strftime("%Y-%m-%d %H:%M:%S")
                if task.next_run_time
                else "Not scheduled"
            )

            table.add_row(
                task.job_id,
                task.name or task.job_id,
                (
                    f"[{status_color}]{'Active' if task.is_active else 'Paused'}"
                    f"[/{status_color}]"
                ),
                next_run,
                task.trigger_type or "Unknown"
            )

        console.print(table)
        rprint(f"\nğŸ“Š [cyan]Total jobs:[/cyan] {len(tasks)}")

    except Exception as e:
        rprint(f"âŒ [red]Failed to list jobs:[/red] {e}")
        raise typer.Exit(1)


@app.command("stats")
def job_statistics(
    job_id: str | None = typer.Argument(
        None, help="Specific job ID to show stats for"
    ),
    json_output: bool = typer.Option(
        False, "--json", help="Output stats in JSON format"
    ),
) -> None:
    """
    Show job execution statistics and performance metrics.

    Without job_id: Shows overall scheduler statistics
    With job_id: Shows detailed statistics for specific job
    """

    try:
        if job_id:
            rprint(f"ğŸ“Š [bold blue]Job Statistics for: {job_id}[/bold blue]")
            stats = asyncio.run(_get_job_statistics(job_id))
        else:
            rprint("ğŸ“Š [bold blue]Overall Scheduler Statistics[/bold blue]")
            stats = asyncio.run(_get_overall_statistics())

        if json_output:
            print(json.dumps(stats, indent=2, default=str))
            return

        _display_statistics(stats, job_id)

    except Exception as e:
        rprint(f"âŒ [red]Failed to get statistics:[/red] {e}")
        raise typer.Exit(1)


@app.command("history")
def job_history(
    limit: int = typer.Option(
        20, "--limit", "-l", help="Number of recent executions to show", min=1, max=100
    ),
    job_id: str | None = typer.Option(
        None, "--job-id", "-j", help="Filter by specific job ID"
    ),
    json_output: bool = typer.Option(
        False, "--json", help="Output history in JSON format"
    ),
) -> None:
    """
    Show recent job execution history.

    Displays execution times, durations, and results for recent job runs.
    """

    try:
        if job_id:
            rprint(
                f"ğŸ“š [bold blue]Execution History for: {job_id}[/bold blue] "
                f"(last {limit})"
            )
        else:
            rprint(
                f"ğŸ“š [bold blue]Recent Job Execution History[/bold blue] "
                f"(last {limit})"
            )

        history = asyncio.run(_get_job_history(limit, job_id))

        if json_output:
            print(json.dumps(history, indent=2, default=str))
            return

        if not history:
            rprint("â„¹ï¸  [yellow]No execution history found[/yellow]")
            return

        table = Table(
            title="ğŸ•°ï¸  Job Execution History",
            show_header=True,
            header_style="bold magenta",
        )
        table.add_column("Timestamp", style="cyan")
        table.add_column("Job ID", style="green")
        table.add_column("Duration", style="yellow")
        table.add_column("Status", style="bold")
        table.add_column("Details", style="dim")

        for execution in history:
            status_color = "green" if execution.get("status") == "success" else "red"
            duration = f"{execution.get('duration_ms', 0):.1f}ms"

            status_value = execution.get('status', 'Unknown')
            status_display = f"[{status_color}]{status_value}[/{status_color}]"
            details = execution.get("details", "")[:50]
            if len(execution.get("details", "")) > 50:
                details += "..."

            table.add_row(
                execution.get("timestamp", "Unknown"),
                execution.get("job_id", "Unknown"),
                duration,
                status_display,
                details,
            )

        console.print(table)

    except Exception as e:
        rprint(f"âŒ [red]Failed to get job history:[/red] {e}")
        raise typer.Exit(1)


@app.command("trigger")
def trigger_job(
    job_id: str = typer.Argument(..., help="Job ID to trigger manually"),
    wait: bool = typer.Option(True, "--wait/--no-wait", help="Wait for job completion"),
    timeout: int = typer.Option(
        30, "--timeout", help="Timeout for waiting (seconds)", min=1, max=300
    ),
) -> None:
    """
    Manually trigger a scheduled job.

    Executes the specified job immediately, bypassing the normal schedule.
    Useful for testing job functionality or running jobs on-demand.
    """

    rprint(f"ğŸš€ [bold blue]Triggering job:[/bold blue] {job_id}")

    try:
        # First verify the job exists
        tasks = asyncio.run(_get_scheduled_tasks())
        job_exists = any(task.job_id == job_id for task in tasks)

        if not job_exists:
            rprint(f"âŒ [red]Job not found:[/red] {job_id}")
            rprint("ğŸ’¡ [yellow]Use 'tasks list' to see available jobs[/yellow]")
            raise typer.Exit(1)

        # Trigger the job
        result = asyncio.run(_trigger_job_execution(job_id, wait, timeout))

        if result.get("status") == "success":
            rprint(f"âœ… [green]Job triggered successfully![/green]")
            if wait and result.get("execution_details"):
                details = result["execution_details"]
                duration_ms = details.get('duration_ms', 0)
                rprint(f"â±ï¸  [cyan]Duration:[/cyan] {duration_ms:.1f}ms")
                rprint(f"ğŸ“‹ [cyan]Result:[/cyan] {details.get('result', 'No result')}")
        else:
            error_msg = result.get('error', 'Unknown error')
            rprint(f"âŒ [red]Job execution failed:[/red] {error_msg}")

    except Exception as e:
        rprint(f"âŒ [red]Failed to trigger job:[/red] {e}")
        raise typer.Exit(1)


async def _get_scheduled_tasks() -> list[ScheduledTask]:
    """Get list of scheduled tasks from the scheduler."""
    manager = ScheduledTaskManager()
    return await manager.list_tasks()


async def _get_job_statistics(job_id: str) -> dict[str, Any]:
    """Get statistics for a specific job."""
    manager = ScheduledTaskManager()
    return await manager.get_job_statistics(job_id)


async def _get_overall_statistics() -> dict[str, Any]:
    """Get overall scheduler statistics."""
    manager = ScheduledTaskManager()
    return await manager.get_overall_statistics()


async def _get_job_history(limit: int, job_id: str | None) -> list[dict[str, Any]]:
    """Get recent job execution history."""
    manager = ScheduledTaskManager()
    return await manager.get_job_history(limit, job_id)


async def _trigger_job_execution(
    job_id: str, wait: bool, timeout: int
) -> dict[str, Any]:
    """Trigger manual job execution."""
    manager = ScheduledTaskManager()
    return await manager.trigger_job(job_id, wait, timeout)


def _display_statistics(stats: dict[str, Any], job_id: str | None) -> None:
    """Display formatted statistics."""

    if job_id:
        # Job-specific statistics
        info_text = f"""
[bold cyan]Job Performance Metrics[/bold cyan]

ğŸƒ [yellow]Executions:[/yellow] {stats.get('total_executions', 0)}
âœ… [yellow]Successful:[/yellow] {stats.get('successful_executions', 0)}
âŒ [yellow]Failed:[/yellow] {stats.get('failed_executions', 0)}
ğŸ“Š [yellow]Success Rate:[/yellow] {stats.get('success_rate_percent', 0):.1f}%

â±ï¸  [yellow]Avg Duration:[/yellow] {stats.get('avg_duration_ms', 0):.1f}ms
ğŸš€ [yellow]Min Duration:[/yellow] {stats.get('min_duration_ms', 0):.1f}ms
ğŸŒ [yellow]Max Duration:[/yellow] {stats.get('max_duration_ms', 0):.1f}ms

ğŸ• [yellow]Last Execution:[/yellow] {stats.get('last_execution', 'Never')}
ğŸ•‘ [yellow]Next Scheduled:[/yellow] {stats.get('next_run', 'Not scheduled')}
        """.strip()

        title = f"ğŸ“Š Statistics for {job_id}"
        console.print(Panel(info_text, title=title, border_style="blue"))

    else:
        # Overall scheduler statistics
        info_text = f"""
[bold cyan]Scheduler Overview[/bold cyan]

ğŸ“‹ [yellow]Total Jobs:[/yellow] {stats.get('total_jobs', 0)}
ğŸŸ¢ [yellow]Active Jobs:[/yellow] {stats.get('active_jobs', 0)}
ğŸ”´ [yellow]Paused Jobs:[/yellow] {stats.get('paused_jobs', 0)}

ğŸƒ [yellow]Total Executions:[/yellow] {stats.get('total_executions', 0)}
âœ… [yellow]Successful:[/yellow] {stats.get('successful_executions', 0)}
âŒ [yellow]Failed:[/yellow] {stats.get('failed_executions', 0)}

ğŸ“Š [yellow]Overall Success Rate:[/yellow] {stats.get('success_rate_percent', 0):.1f}%
â±ï¸  [yellow]Avg Execution Time:[/yellow] {stats.get('avg_duration_ms', 0):.1f}ms

ğŸ• [yellow]Scheduler Uptime:[/yellow] {stats.get('uptime', 'Unknown')}
ğŸ”„ [yellow]Last Activity:[/yellow] {stats.get('last_activity', 'No recent activity')}
        """.strip()

        console.print(
            Panel(info_text, title="ğŸ“Š Scheduler Statistics", border_style="green")
        )


if __name__ == "__main__":
    app()
{%- endif -%}