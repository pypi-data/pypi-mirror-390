# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/01_core.ipynb.

# %% auto 0
__all__ = ['setup_db']

# %% ../nbs/01_core.ipynb 4
from fastlite import *
from apswutils.utils import cursor_row2dict

# %% ../nbs/01_core.ipynb 5
@patch
def query(self: Database, sql: str, params: Optional[Union[Iterable, dict]] = None) -> Generator[dict, None, None]:
    '''Execute a query and return results as a list of AttrDict'''
    p = params if isinstance(params, dict) else tuple(params or tuple())
    cursor = self.execute(sql, p)
    cursor.row_trace = cursor_row2dict
    yield from cursor

# %% ../nbs/01_core.ipynb 7
@patch
def mk_store(self:Database,  # database connection
               name:str='content',  # table name
               **kw,  # additional args to pass to fastlite create
               ):
    "Make a sql table for content storage with FTS5 and vector search capabilities"
    _content = self.t[name].create(id=int, content=str, embedding=bytes, metadata=str, uploaded_at=float,
        if_not_exists=True, pk='id', defaults=dict(uploaded_at='CURRENT_TIMESTAMP'), not_null=['content'], **kw)
    if not _content.detect_fts(): _content.enable_fts(['content','metadata'], create_triggers=True, tokenize='porter', replace=True)
    return _content

# %% ../nbs/01_core.ipynb 8
def setup_db(pth_or_uri:str=':memory:',  # the database name or URL
             wal:bool=True,  # use WAL mode
             sem_search:bool=True,  # enable usearch extensions
             **kw,  # additional args to pass to apswutils database
             ) -> Database:
    '''Set up a database connection and load usearch extensions. You can refer usearch docs on sqlite plugins here: <https://unum-cloud.github.io/USearch/sqlite/index.html>'''

    if isinstance(pth_or_uri, (str, Path)): Path(pth_or_uri).parent.mkdir(exist_ok=True)
    _db = Database(pth_or_uri, **kw)
    if wal: _db.enable_wal()
    if not sem_search: return _db
    from usearch import sqlite_path
    _db.conn.enableloadextension(True)
    _db.conn.loadextension(sqlite_path())
    _db.conn.enableloadextension(False)
    return _db

# %% ../nbs/01_core.ipynb 9
@patch
def search(self: Database,      # database connection
           q:str,               # query string
           emb:bytes,    # embedding vector
           columns:list=None,   # columns to return
           where:str=None,      # additional where clause
           where_args:dict=None,# args for where clause
           lim=50,              # limit on number of results
           tbl='content',       # table name
           rrf=True             # need to rerank results with reciprocal rank fusion
           ):
    if not q.strip(): return None
    content = self.mk_store(tbl)
    fts = dict2obj(L(content.search(q, order_by='rank', columns=columns, limit=lim, where=where, where_args=where_args)))
    vecs = L(dict2obj(content(select=','.join(columns), where='embedding is not null' + (' AND ' + where if where else ''),
                   where_args=dict(qvec=emb, **(where_args or {})), order_by='distance_cosine_f32(embedding, :qvec)',limit=lim)))
    if not rrf: return dict(fts=fts, vec=vecs)
    ranked = (fts + vecs).groupby('content')
    return L(ranked.items()).map(lambda kv: first(kv[1]))
