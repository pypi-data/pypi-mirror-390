---
tags: SPICE, Qt, Quicklook
---
# 2023-11-28 Quicklook Qt meeting
Participants: **David, Frédéric, Éric, Claude, Alfred**
*  [Previous notes](https://codimd.math.cnrs.fr/pnaSH3RzQaufDrbjpBcQQw?both)
*  [Next notes](https://codimd.math.cnrs.fr/0Q_uJd1US4Wgux3-BN10bg?both)

## New features

![](https://codimd.math.cnrs.fr/uploads/upload_6af4409f81a9da837358a34b0cf15790.png)
In file history but does not exist anymore -> change error message
- At leat on windows, a window briefly opens at each generation of a plot.

## Suggestions
- change mouse cursor to arrow when hovering over cut bars
- For single exposure files, allow I(lambda), but without gaussian fit
- Bars to select the ROI are not visible when plot is zoomed. Not enough contrast.

## Ready to be checked :checkered_flag:

- (Add previous/next links in codimd pages to go through all the notes)
- Bug on windows: Open file - > Cancel - > Frozen
    - OK
- Prevent user from loading wrong data files (e.g. level 1)
    - OK -> see above, also check for non-existing files
- Disable menu when loading data (and first time app is open)
    - OK
:question: Where do we upload the doc? or we could open the doc from the project itself.
:point_right: **Answer:** ... link to gitlab?
- Show hourglass when data are loading (ok on Ubuntu 22.04 and Win10)
    - From Fred's computer Win11: OK
    - From Eric's: OK (Ubuntu 23.04)
- Review english in the app, remove explanations, instead we suggest a link to the user documentation?
    - English looks OK. Suggestion: "The grey bars are used to restrict the ROI used to generate the fit maps (e.g. to ignore dumbbells)."
- Use unicode λ and σ and remove $_{max}$
    - OK
- Add shortcuts for open file (Ctrl+O), use Ctrl+L to load the last data file you previously loaded!
    - OK
- Review behavior when changing scale to logarithmic or other in level option
:question: We use now the "scaled" values to display the image, are they wrong in the histogram then (next to maps)? Pyqtgraph expects 3D objects to display maps+histograms
:point_right: **Answer:** yes the values on the histogram axis are "wrong" (they are the scaled values), but maybe this just has to be documented? Matplotlib can handle the color bar scaling correctly, but maybe PyQtGraph can't.
- Show original values on mouse hover and not the binned/scaled data cube (blue text in plot titles)
    - show the binned + linear values
    - also change Ave 2D in smooth 2D
- Cancel levels: when using the Cancel button on level process, abort previous changes, no maps should update (to test it: do cancel at the end of the process let's say >50%, the first maps "already leveled" shouldn't change anymore)
    - OK
- Bug detected and fixed: sometimes $I(\lambda)$ doesn't update because $I(\lambda)$.setData() was performed in a thread instead of the main process, remember we had the same kind of issue when maps became black
- Limit "de-zoom" to original value OK, but apply **also to profile**
    - OK
- Prevent user from loading several files (especially by using Ctrl+L twice)
    - OK
- Global levels: values > 100 are not caught properly before being passed to nanpercentile(), fix: thread is abort if min,max are float in [0;100]
    - Maybe force correct value after computations are finished
- In $I(\lambda)$ force lambda range to be fixed. Range should change only when zooming
    - OK
- The fitted curve (in purple) could be drawn with a better x-resolution than the data
    - OK
- Change size policy of left part of splitter so that left panel takes always the minimum size required
    - OK
- Add vertical line in profile (but not movable)
    - OK, but could be movable too
- Keep zoom state in maps after applying levels or averages
    - OK
- Show $\chi^2$ value next to fit parameters, :question: is this ok: $\chi^2=\sum_i \frac{(I_i-I_{fit,i})^2}{I_{fit,i}}$ with:
    - $I_{i}$: intensity of the "i-th" wavelength value in the histogram
    - $I_{fit,i}$: the intensity value on the fit curve for the same wavelength
    :point_right: **Answer:** use reduced χ² (divide Χ² by number of fitting parameters - 1)
- Fix important issue on threads and sliders: some refreshes were useless and led to memory leaks, it should be faster now (especially on profile updates)
    - OK
- Need to display fit values & pixel values as binned (or not) data values. Need to keep 3 cubes: original, binned & 8 bits scaled. **To sum up: "averaged + leveled" in images, original cube for mouse hovering, "averaged + not leveled" in profile $I(\lambda)$**
:question: What do we show for the profile when selected average = whole dim?
:point_right: limit fit when at least 4 lambda bins are available, otherwise do not show fit
:question: For the moment, averages are separately done for $I(x,y)$ and $I(\lambda, y)$ maps, do we have to merge the option for both maps, what is the behavior on the profile then...
:point_right: **Answer:** ... maybe run a single 3D smooth and keepd displays coherent. TBC.
- Remove export buttons, already have a right click -> Export option
    - OK
- Fix tooltip design (opacity on windows)
    - OK
- Show fit parameters above the profile where more space is available + fix: text was not centered when user decreased plot sizes
    - OK
- Handle sit-and-stare and full spectrum studies, for full spectrum:
    - Show/hide in the menu is locked and only $I(\lambda,y)$ is checked
    - Lambda rescaling by default set to 1

## Remaining to do
- Review about popup :question: What do we want in the "about" popup? (Fred mentioned his intern's app about this)
:point_right: **Answer:** IAS contact, release date, Eric's phone number...?
- Remove "%" value display on the footer bar that is related to "Recovering data file"
- Sort processes in the footer (by running ones, then date)
- Issue: zoom is looping -> implement a max
- Improve fit offset hint: take 1 percentile of the map to find it
- Write user doc
- Fix fit maps for sit-and-stare, fit maps should be shown in $(t,y)$ plane not $(x,y)$


## New bugs

Fitting:

* Open raster (solo_L2_spice-n-ras_20220402T131536_V06_100664004-000.fits), change y fitting boundaries for N IV 765, fit Ne VIII 770. Error:
```
  File "/home/eric/proposals/SO/SPICEops/visualization/data_quicklook/threads/workers/generate_fit_maps.py", line 30, in run
    intensities = self.main.dh.cube_ready_fit[win_key][x_i, y_i, :]
                  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^
IndexError: index 830 is out of bounds for axis 1 with size 830
```
* Actually the error is systematic, even when fitting a just-opened file (with no y boundaries changed)
* Then when one cancels the fit, one cannot re-try (because the fit is "already done")
* The warning "Before generating fit maps, you can adjust the y bounds (...)" appears systematically, even when the y bounds have already been changed

Binnning:

* Inconsistency between binning on λ and 2D filtering on (x,y)