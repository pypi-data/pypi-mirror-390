#!/usr/bin/env python3
"""
Bitbucket to GitHub Migration Toolkit

Comprehensive migration toolkit for transferring Bitbucket repositories to GitHub while
preserving metadata, comments, attachments, and cross-references between issues and pull requests.

.. warning::
   This tool was developed with AI assistance. Use at your own risk.
   Always perform dry runs and verify results before production use.

Architecture
------------
The tool uses a modular architecture with separate components:
- MigrationOrchestrator: Coordinates the overall migration process
- AuditOrchestrator: Handles pre-migration analysis and planning
- IssueMigrator: Handles issue migration with attachments and comments
- PullRequestMigrator: Handles PR migration with branch checking
- ReportGenerator: Generates comprehensive migration reports
- SecureConfigLoader: Loads configuration with security enhancements

Subcommands
-----------
audit       Audit repository for migration planning and generate configuration
migrate     Run full migration (requires configuration file)
cross-link  Post-migration processing of cross-repository links
test-auth   Test Bitbucket and GitHub API authentication
clean       Remove output files generated by other subcommands

Migration Strategy
------------------
Issues: All Bitbucket issues become GitHub issues, preserving original numbering with placeholders
Pull Requests:
    - OPEN PRs with existing branches → GitHub PRs (remain open)
    - OPEN PRs with missing branches → GitHub Issues
    - MERGED/DECLINED/SUPERSEDED PRs → GitHub Issues (safest approach)

Security Features
-----------------
- Tokens can be loaded from environment variables (BITBUCKET_TOKEN, GITHUB_TOKEN)
- Token format validation for added security
- Structured logging with file rotation
- Secure configuration loading with validation

Prerequisites
-------------
1. Create empty GitHub repository
2. Push git history: git push --mirror <github-url>
3. Generate Bitbucket API token with repository read access
4. Generate GitHub personal access token with repository write access
5. Run audit to understand migration scope and generate configuration

Examples
--------
# Audit repository before migration (recommended first step)
python migrate_bitbucket_to_github.py audit --workspace myteam --repo myproject --email user@example.com

# Test authentication before migration
python migrate_bitbucket_to_github.py test-auth --workspace myteam --repo myproject \\
    --email user@example.com --gh-owner myuser --gh-repo myproject

# Cross-link processing after migration
python migrate_bitbucket_to_github.py cross-link --config config.json

# Full migration
python migrate_bitbucket_to_github.py migrate --config config.json
"""

import argparse
import sys

# Import command modules
from bitbucket_migration.commands.audit_command import run_audit
from bitbucket_migration.commands.test_auth_command import run_test_auth
from bitbucket_migration.commands.clean_command import run_clean
from bitbucket_migration.commands.migration_command import run_migration
from bitbucket_migration.commands.cross_link_command import run_cross_link


def create_main_parser():
    """Create and configure the main argument parser with subcommands.

    Sets up the command-line interface with comprehensive help text, subcommands
    for audit, migrate, cross-link, test-auth, and clean operations, along with all
    required and optional arguments for each subcommand.

    Returns
    -------
    argparse.ArgumentParser
        Configured argument parser with all subcommands and options.

    Notes
    -----
    The parser includes detailed help text and examples in the epilog.
    All subcommands support interactive prompting for missing required arguments.
    """
    parser = argparse.ArgumentParser(
        description='Bitbucket to GitHub Migration Tools',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Bitbucket to GitHub Migration Toolkit

This tool provides comprehensive migration capabilities from Bitbucket to GitHub,
including authentication testing functionality, auditing of bitbucket repositories,
full migration, post-migration rewriting of cross-repository links, and cleanup operations.

SUBCOMMANDS:
   test-auth   Test Bitbucket and GitHub API authentication
   audit       Audit repository for migration planning
   migrate     Run full migration (requires config file)
   cross-link  Post-migration processing of cross-repository links
   clean       Remove output files generated by other subcommands

EXAMPLES:
  # Test authentication before migration
  python migrate_bitbucket_to_github.py test-auth --workspace myteam --repo myproject --email user@example.com --gh-owner myuser --gh-repo myproject

  # Generate migration config from audit (default behavior)
  python migrate_bitbucket_to_github.py audit --workspace myteam --repo myproject --email user@example.com

  # Skip config generation
  python migrate_bitbucket_to_github.py audit --workspace myteam --repo myproject --email user@example.com --no-config
  
  # Dry run to validate configuration
  python migrate_bitbucket_to_github.py migrate --config config.json --dry-run

  # Full migration
  python migrate_bitbucket_to_github.py migrate --config config.json

  # Clean output files (keeps config)
  python migrate_bitbucket_to_github.py clean

  # Clean all files including config
  python migrate_bitbucket_to_github.py clean --all

  # Clean repository directory using workspace/repo names
  python migrate_bitbucket_to_github.py clean --workspace myworkspace --repo myrepo

CONFIGURATION:
For migration and dry-run commands, provide a configuration file with:
{
  "bitbucket": {
    "workspace": "myworkspace",
    "repo": "myrepo",
    "email": "user@example.com",
    "token": "BITBUCKET_API_TOKEN"
  },
  "github": {
    "owner": "myuser",
    "repo": "myrepo",
    "token": "GITHUB_TOKEN"
  },
  "user_mapping": {
    "Bitbucket User": "github-username"
  }
}

SECURITY: Tokens can be loaded from environment variables (BITBUCKET_TOKEN, GITHUB_TOKEN)
to avoid storing sensitive data in configuration files.
        """
    )

    subparsers = parser.add_subparsers(dest='command', required=True, help='Available commands')

    # Test-auth subcommand
    test_auth_parser = subparsers.add_parser('test-auth', help='Test Bitbucket and GitHub API authentication')
    test_auth_parser.add_argument('--workspace', help='Bitbucket workspace name')
    test_auth_parser.add_argument('--repo', help='Repository name')
    test_auth_parser.add_argument('--email', help='Bitbucket email')
    test_auth_parser.add_argument('--token', help='Bitbucket API token')
    test_auth_parser.add_argument('--gh-owner', help='GitHub owner')
    test_auth_parser.add_argument('--gh-repo', help='GitHub repository name')
    test_auth_parser.add_argument('--gh-token', help='GitHub API token')
    test_auth_parser.add_argument('--debug', action='store_true', help='Enable debug logging')

    # Audit subcommand
    audit_parser = subparsers.add_parser('audit', help='Audit repository for migration planning')
    audit_parser.add_argument('--workspace', help='Bitbucket workspace name')
    audit_parser.add_argument('--repo', '--repos', type=str, nargs='*', help='Repository name(s)')
    audit_parser.add_argument(
        '--discover',
        action='store_true',
        help='Auto-discover all repositories in workspace'
    )
    audit_parser.add_argument('--email', help='Bitbucket email')
    audit_parser.add_argument('--token', help='Bitbucket API token')
    audit_parser.add_argument('--gh-owner', help='GitHub owner for config template')
    audit_parser.add_argument('--gh-repo', help='GitHub repository name for config template')
    audit_parser.add_argument(
        '--base-dir',
        type=str,
        default=None,
        help='Base directory for migration workspace. '
             'Defaults to current directory (".") if not specified.'
    )
    audit_parser.add_argument('--debug', action='store_true', help='Enable debug logging')

    # Migration subcommand
    migrate_parser = subparsers.add_parser('migrate', help='Run full migration')
    migrate_parser.add_argument('--config', required=True, help='Path to configuration JSON file')
    repo_selection = migrate_parser.add_mutually_exclusive_group()
    repo_selection.add_argument(
        '--repo', '--repos',
        type=str, nargs='*',
        help='Repository name(s) (comma-separated for multiple)'
    )
    repo_selection.add_argument(
        '--all',
        action='store_true',
        help='Explicitly migrate all repositories (default behavior)'
    )
    migrate_parser.add_argument('--dry-run', type=str, nargs='?', const='true', default=argparse.SUPPRESS,
                                help='Simulate migration without making changed')
    migrate_parser.add_argument('--skip-issues', type=str, nargs='?', const='true', default=argparse.SUPPRESS,
                                help='Skip issue migration (true/false, default from config)')
    migrate_parser.add_argument('--open-issues-only', type=str, nargs='?', const='true', default=argparse.SUPPRESS,
                                help='Only migrate open issue (true/false, default from config)')
    migrate_parser.add_argument('--skip-prs', type=str, nargs='?', const='true', default=argparse.SUPPRESS,
                                help='Skip PR migration (true/false, default from config)')
    migrate_parser.add_argument('--open-prs-only', type=str, nargs='?', const='true', default=argparse.SUPPRESS,
                                help='Only migrate open PRs (true/false, default from config)')
    migrate_parser.add_argument('--skip-pr-as-issue', type=str, nargs='?', const='true', default=argparse.SUPPRESS,
                                help='Skip migrating closed/merged PRs as issues (true/false, default from config)')
    migrate_parser.add_argument('--skip-milestones', type=str, nargs='?', const='true', default=argparse.SUPPRESS,
                                help='Skip milestone migration (true/false, default from config)')
    migrate_parser.add_argument('--open-milestones-only', type=str, nargs='?', const='true', default=argparse.SUPPRESS,
                                help='Only migrate open milestones (true/false, default from config)')
    migrate_parser.add_argument('--debug', action='store_true', help='Enable debug logging')

    # Cross-link subcommand
    cross_link_parser = subparsers.add_parser('cross-link', help='Post-migration processing of cross-repository links')
    cross_link_parser.add_argument('--config', required=True, help='Path to configuration JSON file')
    cross_link_repo_selection = cross_link_parser.add_mutually_exclusive_group()
    cross_link_repo_selection.add_argument(
        '--repo', '--repos',
        type=str, nargs='*',
        help='Repository name(s)'
    )
    cross_link_repo_selection.add_argument(
        '--all',
        action='store_true',
        help='Explicitly migrate all repositories (default behavior)'
    )
    cross_link_parser.add_argument('--dry-run', type=str, nargs='?', const='true', default=argparse.SUPPRESS,
                                   help='Simulate cross-linking without making changes')
    cross_link_parser.add_argument('--debug', action='store_true', help='Enable debug logging')


    # Clean subcommand
    clean_parser = subparsers.add_parser('clean', help='Remove output files generated by audit, dry-run, and migrate subcommands')
    clean_parser.add_argument(
        '--config',
        type=str,
        help='Path to migration config file to determine base directory'
    )
    clean_parser.add_argument(
        '--base-dir',
        type=str,
        default='.',
        help='Base directory to clean (default: current directory)'
    )
    clean_parser.add_argument(
        '--subcommand',
        type=str, nargs='*',
        help='Clean output of select commands (audit, dry-run, migrate, cross-link)'
    )
    clean_parser.add_argument(
        '--reset',
        action='store_true',
        help='Clean everything including config, cross-repo mappings, and file registry'
    )
    clean_parser.add_argument(
        '--workspace',
        type=str, nargs='*',
        help='Filter by workspace name(s) (requires file tracking)'
    )
    clean_parser.add_argument(
        '--repo', '--repos',
        type=str, nargs='*',
        help='Filter by Repository name(s) (requires file tracking)'
    )
    clean_parser.add_argument(
        '--dry-run',
        action='store_true',
        help='Preview what would be deleted without actually deleting'
    )

    return parser

def main():
    """Main entry point for the Bitbucket to GitHub migration CLI tool.

    Parses command-line arguments and routes execution to the appropriate subcommand
    handler (audit, migrate, cross-link, test-auth, or clean). Provides comprehensive error
    handling and user-friendly error messages.

    Side Effects
    ------------
    - Parses command-line arguments using argparse
    - Routes to appropriate subcommand handler function
    - May prompt user for missing required arguments
    - Exits program with appropriate error codes on failures
    - Prints status messages and errors to stdout/stderr

    Raises
    ------
    SystemExit
        Always exits with code 0 on success, 1 on error.

    Examples
    --------
    Run from command line with subcommands:

    $ python migrate_bitbucket_to_github.py audit --workspace myteam --repo myproject
    $ python migrate_bitbucket_to_github.py migrate --config migration_config.json
    $ python migrate_bitbucket_to_github.py cross-link --config migration_config.json
    $ python migrate_bitbucket_to_github.py test-auth --workspace myteam --repo myproject
    """
    parser = create_main_parser()
    args = parser.parse_args()
    if args.command == 'audit':
        run_audit(args, parser)
    elif args.command == 'migrate':
        run_migration(args)
    elif args.command == 'cross-link':
        run_cross_link(args)
    elif args.command == 'test-auth':
        run_test_auth(args, parser)
    elif args.command == 'clean':
        run_clean(args)
    else:
        print(f"❌ Unknown command: {args.command}")
        sys.exit(1)


if __name__ == '__main__':
    main()