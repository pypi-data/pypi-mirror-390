---
name: Create Signed Release Tag

on:
  workflow_dispatch:
    inputs:
      version:
        description: Version to tag (e.g. 0.5.2)
        required: true

permissions:
  contents: read
  # Minimal permissions: only need to create and push tags and OIDC token access for Gitsign

jobs:
  sign-and-push-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Harden the runner (audit mode)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout repository  # zizmor: This workflow doesn't generate artifacts
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0

      - name: Setup Gitsign for keyless signing
        uses: chainguard-dev/actions/setup-gitsign@1b32103f5aa389c31ab0be75a8edc38d7e4750d8 # main

      - name: Configure git identity
        run: |
          set -euo pipefail
          git config user.name "Miniflux Release Bot"
          git config user.email "release@reuteras.net"

      - name: Create signed tag
        env:
          VERSION: ${{ github.event.inputs.version }}
        run: |
          set -euo pipefail
          TAG="v${VERSION}"

          if git rev-parse "${TAG}" >/dev/null 2>&1; then
            echo "Tag ${TAG} already exists locally; refusing to overwrite." >&2
            exit 1
          fi

          if git ls-remote --tags origin "${TAG}" | grep -q "${TAG}$"; then
            echo "Tag ${TAG} already exists on origin; aborting." >&2
            exit 1
          fi

          git tag -s "${TAG}" -m "${TAG}"
          git push origin "${TAG}"
