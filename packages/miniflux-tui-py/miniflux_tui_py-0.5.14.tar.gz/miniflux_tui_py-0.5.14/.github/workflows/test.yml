---
name: Test Python Versions

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - 'assets/**'
      - 'mkdocs.yml'
      - 'config.toml.example'
  pull_request:
    branches:
      - main
    paths-ignore:
      - '**/*.md'
      - 'docs/**'
      - 'assets/**'
      - 'mkdocs.yml'
      - 'config.toml.example'

permissions:
  contents: read

jobs:
  test:
    name: "${{ matrix.os }} / Python ${{ matrix.python-version }}"
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read  # For checking out code
      pull-requests: write  # For posting coverage comments
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ["3.11", "3.12", "3.13", "3.14"]
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          persist-credentials: false

      - name: Install uv
        uses: astral-sh/setup-uv@85856786d1ce8acfbcc2f13a5f3fbd6b938f9f41 # v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine uv cache directory
        id: uv-cache-dir
        run: |
          echo "dir=$(uv cache dir)" >> "$GITHUB_OUTPUT"

      - name: Cache uv packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ${{ steps.uv-cache-dir.outputs.dir }}
          key: uv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-${{ matrix.python-version }}-

      - name: Set up Python ${{ matrix.python-version }}
        run: uv python install ${{ matrix.python-version }}

      - name: Install dependencies
        run: uv sync --locked

      - name: Check formatting with ruff
        run: uv run ruff check miniflux_tui tests

      - name: Type check with pyright
        run: uv run pyright miniflux_tui tests

      - name: Run tests with coverage
        env:
          COVERAGE_FILE: .coverage.${{ matrix.os }}-py${{ matrix.python-version }}
        run: |
          uv run --with pytest-xdist pytest tests --cov=miniflux_tui --cov-report=xml \
            --cov-report=term-missing --cov-report=html \
            -n auto --dist=loadscope

      - name: Upload coverage artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: coverage-${{ matrix.os }}-py${{ matrix.python-version }}
          path: |
            coverage.xml
            .coverage.${{ matrix.os }}-py${{ matrix.python-version }}
          retention-days: 7

      - name: Upload coverage to Coveralls
        uses: coverallsapp/github-action@648a8eb78e6d50909eff900e4ec85cab4524a45b # v2.3.6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          file: ./coverage.xml
          format: cobertura
          flag-name: ${{ matrix.os }}-py${{ matrix.python-version }}
          parallel: true

      - name: Coverage differential for PRs
        if: github.event_name == 'pull_request' && matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
        continue-on-error: true
        env:
          BASE_REF: ${{ github.base_ref }}
        run: |
          {
            echo "## Coverage Differential"
            echo ""
            echo "Analyzing coverage changes in this PR..."
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"
          # Run diff-cover to show coverage of changes
          uvx diff-cover coverage.xml \
            --compare-branch="origin/${BASE_REF}" \
            --fail-under=70 \
            --markdown-report=diff-coverage.md || true
          # Add results to step summary
          if [ -f diff-coverage.md ]; then
            cat diff-coverage.md >> "$GITHUB_STEP_SUMMARY"
          fi
          {
            echo ""
            echo "â„¹ï¸ Target: â‰¥70% coverage on changed lines"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Copy coverage file for comment action
        if: github.event_name == 'pull_request' && matrix.os == 'ubuntu-latest' && matrix.python-version == '3.13'
        run: cp .coverage.${{ matrix.os }}-py${{ matrix.python-version }} .coverage

      - name: Coverage comment on PR
        if: github.event_name == 'pull_request' && matrix.os == 'ubuntu-latest' && matrix.python-version == '3.13'
        uses: py-cov-action/python-coverage-comment-action@e623398c19eb3853a5572d4a516e10b15b5cefbc # v3.39
        with:
          GITHUB_TOKEN: ${{ github.token }}
          MINIMUM_GREEN: 80
          MINIMUM_ORANGE: 60

      - name: Check coverage threshold
        run: |
          uv run python - <<'PY'
          import sys
          import xml.etree.ElementTree as ET

          threshold = 60.0
          coverage = float(ET.parse("coverage.xml").getroot().get("line-rate")) * 100

          if coverage < threshold:
              sys.exit(f"Coverage {coverage:.2f}% is below threshold {threshold:.0f}%")

          print(f"Coverage {coverage:.2f}% meets threshold {threshold:.0f}%")
          PY

  test-future:
    name: Test Python 3.15 (Preview)
    runs-on: ubuntu-latest
    continue-on-error: true
    defaults:
      run:
        shell: bash
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          persist-credentials: false

      - name: Install uv
        uses: astral-sh/setup-uv@85856786d1ce8acfbcc2f13a5f3fbd6b938f9f41 # v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine uv cache directory
        id: uv-cache-dir
        run: |
          echo "dir=$(uv cache dir)" >> "$GITHUB_OUTPUT"

      - name: Cache uv packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ${{ steps.uv-cache-dir.outputs.dir }}
          key: uv-${{ runner.os }}-3.15-${{ hashFiles('uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-3.15-

      - name: Set up Python 3.15
        run: uv python install 3.15

      - name: Install dependencies
        run: uv sync --locked

      - name: Check formatting with ruff
        run: uv run ruff check miniflux_tui tests

      - name: Type check with pyright
        run: uv run pyright miniflux_tui tests

      - name: Run tests with coverage
        run: |
          uv run pytest tests --cov=miniflux_tui --cov-report=xml \
            --cov-report=term-missing

      - name: Check coverage threshold
        run: |
          uv run python - <<'PY'
          import sys
          import xml.etree.ElementTree as ET

          threshold = 60.0
          coverage = float(ET.parse("coverage.xml").getroot().get("line-rate")) * 100

          if coverage < threshold:
              sys.exit(f"Coverage {coverage:.2f}% is below threshold {threshold:.0f}%")

          print(f"Coverage {coverage:.2f}% meets threshold {threshold:.0f}%")
          PY

  coverage-finish:
    name: Finish Coveralls
    needs: [test, test-future]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Coveralls Finished
        uses: coverallsapp/github-action@648a8eb78e6d50909eff900e4ec85cab4524a45b # v2.3.6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          parallel-finished: true

  # coverage-report job disabled - artifacts structure issue
  # Coveralls already provides combined coverage reporting
  # coverage-report:
  #   name: Generate Coverage Report
  #   needs: test
  #   runs-on: ubuntu-latest
  #   if: false  # Disabled
  #   permissions:
  #     contents: write
  #   steps:
  #     - name: Harden the runner (Audit all outbound calls)
  #       uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
  #       with:
  #         egress-policy: audit
  #
  #     - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
  #       with:
  #         persist-credentials: false
  #
  #     - name: Download coverage artifacts
  #       uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6
  #       with:
  #         pattern: coverage-*
  #         path: coverage-data
  #
  #     - name: Install uv
  #       uses: astral-sh/setup-uv@85856786d1ce8acfbcc2f13a5f3fbd6b938f9f41 # v7
  #       with:
  #         github-token: ${{ secrets.GITHUB_TOKEN }}
  #
  #     - name: Combine coverage reports
  #       run: |
  #         # Find all .coverage.* files in subdirectories and move to coverage-data root
  #         find coverage-data -type f -name '.coverage.*' -exec mv {} coverage-data/ \;
  #         cd coverage-data
  #         ls -la  # Debug: show what files we have
  #         uvx coverage combine --keep .coverage.*
  #         uvx coverage xml -o ../coverage.xml
  #         uvx coverage html --directory=../htmlcov
  #
  #     - name: Deploy coverage HTML to GitHub Pages
  #       uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e # v4.0.0
  #       with:
  #         github_token: ${{ secrets.GITHUB_TOKEN }}
  #         publish_dir: ./htmlcov
  #         destination_dir: coverage
  #         enable_jekyll: false

  mutation-testing:
    name: Mutation Testing
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    continue-on-error: true
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          persist-credentials: false

      - name: Install uv
        uses: astral-sh/setup-uv@85856786d1ce8acfbcc2f13a5f3fbd6b938f9f41 # v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python 3.11
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync --locked

      - name: Run mutation testing
        id: mutmut
        continue-on-error: true
        timeout-minutes: 30
        run: |
          # Run mutmut on the main codebase
          # Note: Mutation testing can be slow. We run with a timeout to prevent excessive CI time.
          echo "## Mutation Testing Results" >> "$GITHUB_STEP_SUMMARY"
          echo "Running mutation testing (limited to 30 minutes)..." >> "$GITHUB_STEP_SUMMARY"

          # Run with pytest runner
          uvx mutmut run --paths-to-mutate=miniflux_tui --runner="pytest -x -q" --tests-dir=tests || true

          # Generate results
          uvx mutmut results > mutation-results.txt || true
          uvx mutmut html || true

          # Show summary
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Summary" >> "$GITHUB_STEP_SUMMARY"
          uvx mutmut results | head -30 >> "$GITHUB_STEP_SUMMARY" || true
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "ðŸ“ Full report available in artifacts" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload mutation report
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5
        with:
          name: mutation-testing-report
          path: |
            mutation-results.txt
            html/
          retention-days: 30

      - name: Comment mutation score
        if: always()
        run: |
          echo "âœ¨ Mutation testing completed!"
          echo "ðŸ“Š Check the uploaded artifacts for detailed results"
          echo "ðŸŽ¯ Target: >80% mutation score for high-quality tests"
          echo ""
          echo "Note: Mutation testing is informational and does not block PR merging."
