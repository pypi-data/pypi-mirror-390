---
name: Auto-Approve Passing PRs

# Trigger when a pull request is opened or updated
# Uses bot account (via BOT_TOKEN secret) to approve PRs from authorized users
on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: read

jobs:
  auto-approve:
    name: Auto-Approve PR
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    # Approve PRs from:
    # 1. reuteras (solo developer) - must be User type
    # 2. renovate[bot] (dependency updates) - must be Bot type
    # 3. dependabot[bot] (dependency updates) - must be Bot type
    # 4. github-actions[bot] (automated workflows) - must be Bot type
    # Skip draft PRs
    if: >-
      github.event.pull_request.draft == false &&
      (
        (github.event.pull_request.user.login == 'reuteras' &&
          github.event.pull_request.user.type == 'User') ||
        (github.event.pull_request.user.login == 'renovate[bot]' &&
          github.event.pull_request.user.type == 'Bot') ||
        (github.event.pull_request.user.login == 'dependabot[bot]' &&
          github.event.pull_request.user.type == 'Bot') ||
        (github.event.pull_request.user.login == 'github-actions[bot]' &&
          github.event.pull_request.user.type == 'Bot')
      )
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Check if PR is already approved
        id: check-approval
        run: |
          # Get current reviews
          reviews=$(gh pr view "${{ github.event.pull_request.number }}" \
            --repo "${{ github.repository }}" \
            --json reviews --jq '.reviews[].state')

          # Check if already approved by GitHub Actions
          if echo "$reviews" | grep -q "APPROVED"; then
            echo "already_approved=true" >> "$GITHUB_OUTPUT"
          else
            echo "already_approved=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          GH_TOKEN: ${{ secrets.BOT_TOKEN }}
        continue-on-error: true

      - name: Wait for status checks to complete
        if: steps.check-approval.outputs.already_approved == 'false'
        run: |
          # Give GitHub Actions a moment to update check status
          sleep 5
        env:
          GH_TOKEN: ${{ secrets.BOT_TOKEN }}

      - name: Check all required status checks pass
        if: steps.check-approval.outputs.already_approved == 'false'
        id: check-status
        run: |
          # Get the PR's status check summary
          pr_status=$(gh pr view "${{ github.event.pull_request.number }}" \
            --repo "${{ github.repository }}" \
            --json statusCheckRollup \
            --jq '.statusCheckRollup[].conclusion')

          # Count passed vs failed checks
          failed_count=$(echo "$pr_status" | grep -c "FAILURE" || true)

          if [ "$failed_count" -gt 0 ]; then
            echo "Some checks failed - will not approve"
            exit 1
          fi

          echo "All checks passed!"
        env:
          GH_TOKEN: ${{ secrets.BOT_TOKEN }}
        continue-on-error: true

      - name: Auto-approve PR
        if: >-
          steps.check-approval.outputs.already_approved == 'false' &&
          steps.check-status.outcome == 'success'
        run: |
          # Determine PR source for approval message
          # Using environment variable to prevent template injection attacks
          case "$PR_ACTOR" in
            "renovate[bot]")
              APPROVAL_REASON="Automated dependency update"
              ;;
            "dependabot[bot]")
              APPROVAL_REASON="Automated dependency update"
              ;;
            "github-actions[bot]")
              APPROVAL_REASON="Automated GitHub Actions workflow"
              ;;
            "reuteras")
              APPROVAL_REASON="Solo developer workflow"
              ;;
            *)
              APPROVAL_REASON="Unknown source"
              ;;
          esac

          gh pr review "$PR_NUMBER" \
            --repo "$GITHUB_REPOSITORY" \
            --approve \
            --body "âœ… All automated checks passed. Approval reason: $APPROVAL_REASON"
        env:
          GH_TOKEN: ${{ secrets.BOT_TOKEN }}
          PR_ACTOR: ${{ github.event.pull_request.user.login }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
