"""
Phase 2: JS generator for Electron preload and runtime stub.
- Consumes Python-side API schema (from dars.desktop.api.get_schema()).
- Emits:
  * preload.js content (uses contextBridge to expose safe API)
  * stub.js content (runtime helper that calls window.DarsDesktopAPI)
Optionally writes files when paths are provided.
"""
from __future__ import annotations
from typing import Dict, Optional

PREAMBLE = """// Auto-generated by Dars (Phase 2)
// Do not edit manually; generation will overwrite this file.
"""


def _gen_preload_api_impl(schema: Dict[str, Dict[str, str]]) -> str:
    lines = [
        "const { contextBridge, ipcRenderer } = require('electron');",
        "",
        "// Build a safe API surface based on provided schema",
        "const api = {};",
    ]
    for ns, methods in schema.items():
        lines.append(f"api['{ns}'] = {{}};")
        for m in methods.keys():
            # Forward all calls to ipcRenderer.invoke with a channel name
            channel = f"dars::{ns}::{m}"
            lines.append(
                f"api['{ns}']['{m}'] = (...args) => ipcRenderer.invoke('{channel}', ...args);"
            )
    lines.append("")
    lines.append("contextBridge.exposeInMainWorld('DarsDesktopAPI', api);")
    return "\n".join(lines)


def generate_preload_js(schema: Dict[str, Dict[str, str]]) -> str:
    return PREAMBLE + _gen_preload_api_impl(schema) + "\n"


def _gen_stub_impl(schema: Dict[str, Dict[str, str]]) -> str:
    lines = [
        "// Runtime stub for Renderer (Dars) to call into preload-exposed API",
        "export const DarsDesktopAPI = (typeof window !== 'undefined' && window.DarsDesktopAPI) ? window.DarsDesktopAPI : {};",
    ]
    return "\n".join(lines)


def generate_stub_js(schema: Dict[str, Dict[str, str]]) -> str:
    return PREAMBLE + _gen_stub_impl(schema) + "\n"


def write_backend_templates(out_dir: str, *, package_json: Optional[str] = None, main_js: Optional[str] = None, preload_js: Optional[str] = None) -> None:
    """Write static backend templates if provided. Phase 3 exporter will call this.
    """
    import os
    os.makedirs(out_dir, exist_ok=True)
    if package_json is not None:
        with open(os.path.join(out_dir, 'package.json'), 'w', encoding='utf-8') as f:
            f.write(package_json)
    if main_js is not None:
        with open(os.path.join(out_dir, 'main.js'), 'w', encoding='utf-8') as f:
            f.write(main_js)
    if preload_js is not None:
        with open(os.path.join(out_dir, 'preload.js'), 'w', encoding='utf-8') as f:
            f.write(preload_js)
