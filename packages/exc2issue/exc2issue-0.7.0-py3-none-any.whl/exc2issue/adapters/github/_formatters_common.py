"""Common helper functions for formatters.

This module contains shared utility functions used across different
formatter modules to avoid code duplication.
"""

from exc2issue.core.models import ErrorRecord


def format_timestamp(error_record: ErrorRecord) -> str:
    """Format error record timestamp as ISO string.

    Args:
        error_record: Error record with optional timestamp

    Returns:
        ISO formatted timestamp string or 'Unknown'
    """
    return (
        error_record.timestamp.isoformat()
        if error_record.timestamp
        else 'Unknown'
    )


def add_error_details_section(
    body_parts: list[str],
    error_record: ErrorRecord,
    include_timestamp: bool = True
) -> None:
    """Add error details section to body parts.

    Args:
        body_parts: List to append error details to
        error_record: Error record with details
        include_timestamp: Whether to include timestamp field
    """
    body_parts.extend([
        "## Error Details",
        f"**Function:** `{error_record.function_name}`",
        f"**Error Type:** {error_record.error_type}",
        f"**Error Message:** {error_record.error_message}",
    ])

    if include_timestamp:
        timestamp_str = format_timestamp(error_record)
        body_parts.append(f"**Timestamp:** {timestamp_str}")

    body_parts.append("")


def add_function_context_section(
    body_parts: list[str],
    error_record: ErrorRecord
) -> None:
    """Add function context section if arguments are available.

    Args:
        body_parts: List to append context section to
        error_record: Error record with function context
    """
    if not (error_record.function_args or error_record.function_kwargs):
        return

    body_parts.extend(["## Function Context", ""])

    if error_record.function_args:
        body_parts.append(f"**Arguments:** `{error_record.function_args}`")
    if error_record.function_kwargs:
        body_parts.append(
            f"**Keyword Arguments:** `{error_record.function_kwargs}`"
        )
    body_parts.append("")


def add_traceback_section(body_parts: list[str], error_record: ErrorRecord) -> None:
    """Add stack trace section if available.

    Args:
        body_parts: List to append traceback section to
        error_record: Error record with optional traceback
    """
    if error_record.traceback and error_record.traceback.strip():
        body_parts.extend([
            "## Stack Trace",
            f"```\n{error_record.traceback}\n```",
            ""
        ])


def add_footer(body_parts: list[str], is_ai_mode: bool = True) -> None:
    """Add footer with attribution.

    Args:
        body_parts: List to append footer to
        is_ai_mode: Whether AI mode is active (affects footer text)
    """
    body_parts.append("---")

    if is_ai_mode:
        body_parts.append(
            "*This issue was automatically created by "
            "[exc2issue](https://github.com/exc2issue/exc2issue)*"
        )
    else:
        body_parts.append(
            "*This issue was automatically generated by exc2issue (fallback mode - "
            "install with `pip install exc2issue[ai]` for AI-powered descriptions)*"
        )
