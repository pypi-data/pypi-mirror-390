"""Fill in a module description here"""

# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/02_cli.ipynb.

# %% auto 0
__all__ = ['cli', 'sync', 'init', 'config']

# %% ../nbs/02_cli.ipynb 3
import click
from pathlib import Path
from junco_sync.sync import (
    init_duckdb,
    sync_models,
    get_models_from_selection,
)
from .config import load_config, save_config

# %% ../nbs/02_cli.ipynb 4
@click.group()
def cli():
    """
    üê¶ junco-sync: Sync Snowflake sources to DuckDB for local dbt development
    
    Named after the Dark-eyed Junco, commonly known as the "snowbird"
    """
    pass


# %% ../nbs/02_cli.ipynb 5
@cli.command()
@click.option('--select', '-s', multiple=True, 
              help='dbt selection syntax (can be used multiple times)')
@click.option('--exclude', '-e', multiple=True, 
              help='dbt exclusion syntax')
@click.option('--selector', 
              help='Named selector from selectors.yml')
@click.option('--sample', default=10000, 
              help='Number of rows to sample per table')
@click.option('--full', is_flag=True, 
              help='Sync full tables (no sampling)')
@click.option('--days', type=int, 
              help='For time-based tables, sync last N days')
@click.option('--manifest', default='target/manifest.json', 
              help='Path to dbt manifest.json')
@click.option('--profiles-dir', 
              help='dbt profiles directory')
@click.option('--dry-run', is_flag=True,
              help='Show what would be synced without syncing')
@click.option('--debug', is_flag=True,
              help='Print debug information')
def sync(select, exclude, selector, sample, full, days, manifest, profiles_dir, dry_run, debug):
    """
    Sync source dependencies for dbt models to DuckDB.
    
    Uses dbt selection syntax - works like dbt run/test/build.
    
    If run in a dbt project directory without --select, syncs all models.
    
    \b
    Examples:
      junco-sync sync --select my_model
      junco-sync sync --select +my_model
      junco-sync sync --select tag:daily
      junco-sync sync --select path:marts/finance/*
      junco-sync sync --select tag:daily --exclude tag:deprecated
      junco-sync sync --select +fct_inquiries --days 90
      junco-sync sync --select dim_* --full
      junco-sync sync --selector my_dev_models
    """
    
    # Check if we're in a dbt project
    manifest_path = Path(manifest)
    if not manifest_path.exists():
        click.echo(f"‚ùå Manifest not found at {manifest_path}")
        click.echo("   Run 'dbt compile' or 'dbt run' first to generate the manifest.")
        return
    
    # If no selection provided, default to all models
    if not select and not selector:
        click.echo("No --select provided, syncing all models in project...")
        select = ('*',)
    
    try:
        # Get models using dbt list
        click.echo("üîç Finding models matching selection criteria...")
        models = get_models_from_selection(
            list(select),
            list(exclude) if exclude else None,
            selector,
            profiles_dir,
            debug=debug  # Pass debug flag
        )
    except Exception as e:
        click.echo(f"‚ùå Error getting models: {e}")
        if debug:
            import traceback
            traceback.print_exc()
        return
    
    if not models:
        click.echo("‚ùå No models matched the selection criteria")
        return
    
    click.echo(f"\nüìã Matched {len(models)} model(s):")
    for model in models[:10]:  # Show first 10
        click.echo(f"  - {model}")
    if len(models) > 10:
        click.echo(f"  ... and {len(models) - 10} more")
    
    if dry_run:
        click.echo("\nüîç Dry run - would sync dependencies for these models")
        return
    
    # Confirm if many models
    if len(models) > 5:
        if not click.confirm(f"\nProceed with syncing dependencies for {len(models)} models?"):
            click.echo("Aborted.")
            return
    
    # Build where clauses for time-based filtering
    where_clauses = {}
    if days:
        click.echo(f"\n‚è∞ Using last {days} days for time-based tables")
        # Will apply to tables with common timestamp column names
        # This is a simple heuristic - could be made configurable
    
    # Sync
    click.echo()
    sample_size = None if full else sample
    
    try:
        results = sync_models(
            models,
            sample_size=sample_size,
            where_clauses=where_clauses if days else None,
            manifest_path=str(manifest_path),
            verbose=True
        )
        
        # Summary
        successful = sum(1 for v in results.values() if v >= 0)
        total_rows = sum(v for v in results.values() if v >= 0)
        
        click.echo(f"\n{'='*60}")
        click.echo(f"‚úÖ Successfully synced {successful}/{len(results)} sources")
        click.echo(f"üìä Total rows synced: {total_rows:,}")
        click.echo(f"{'='*60}")
        
    except Exception as e:
        click.echo(f"\n‚ùå Error during sync: {e}")
        return


# %% ../nbs/02_cli.ipynb 6
@cli.command()
@click.option('--path', '-p', 
              help='Custom path for DuckDB database')
@click.option('--name', default='dev_database.duckdb',
              help='Database filename (used if no path provided)')
def init(path, name):
    """
    Initialize a new DuckDB database for local development.
    
    Creates database in ~/.junco_sync/ by default.
    
    \b
    Examples:
      junco-sync init
      junco-sync init --name staging.duckdb
      junco-sync init --path /path/to/my_db.duckdb
    """
    try:
        db_path = init_duckdb(
            db_path=path,
            db_name=name,
            set_as_default=True
        )
        click.echo(f"\nüéâ Ready to sync! Use 'junco-sync sync --select <model>' to get started.")
    except Exception as e:
        click.echo(f"‚ùå Error initializing database: {e}")

# %% ../nbs/02_cli.ipynb 7
@cli.command()
@click.argument('action', type=click.Choice(['show', 'set', 'get']))
@click.argument('key', required=False)
@click.argument('value', required=False)
def config(action, key, value):
    """
    Manage junco-sync configuration.
    
    \b
    Examples:
      junco-sync config show                           # Show all config
      junco-sync config get duckdb_path                # Get specific value
      junco-sync config set duckdb_path /path/to/db    # Set a value
    """
    cfg = load_config()
    
    if action == 'show':
        if not cfg:
            click.echo("No configuration set yet. Run 'junco-sync init' to get started.")
            return
        
        click.echo("Current configuration:")
        for k, v in cfg.items():
            click.echo(f"  {k}: {v}")
    
    elif action == 'get':
        if not key:
            click.echo("‚ùå Must provide a key to get")
            return
        
        val = cfg.get(key)
        if val is None:
            click.echo(f"‚ùå Key '{key}' not found in config")
        else:
            click.echo(val)
    
    elif action == 'set':
        if not key or not value:
            click.echo("‚ùå Must provide both key and value")
            return
        
        cfg[key] = value
        save_config(cfg)
        click.echo(f"‚úì Set {key} = {value}")
