@echo off
setlocal enabledelayedexpansion

:: -------------------------------
::  Настройка путей
:: -------------------------------
:: PROJECT_DIR — папка, где находится скрипт
set "PROJECT_DIR=%~dp0"
:: VENV_DIR — виртуальное окружение будет здесь
set "VENV_DIR=%PROJECT_DIR%venv"
:: APP_DIR — папка с Django приложением, где manage.py
set "APP_DIR=%PROJECT_DIR%app"
:: Папка с заранее подготовленным Lib для офлайн установки
set "LIB_SRC=%PROJECT_DIR%Lib"

echo ----------------------------------------
echo   Запуск Django проекта (офлайн)
echo ----------------------------------------

:: -------------------------------
:: 1. Проверка наличия Python
:: -------------------------------
where py >nul 2>&1
if %errorlevel%==0 (
    set "PYTHON_CMD=py"
) else (
    where python >nul 2>&1
    if %errorlevel%==0 (
        set "PYTHON_CMD=python"
    ) else (
        echo [ОШИБКА] Python не найден.
        echo Пожалуйста, установите Python и повторите запуск.
        pause
        exit /b
    )
)
echo Найден Python: %PYTHON_CMD%

:: -------------------------------
:: 2. Создание виртуального окружения (если нет)
:: -------------------------------
if not exist "%VENV_DIR%" (
    echo Создаю виртуальное окружение в папке venv...
    %PYTHON_CMD% -m venv "%VENV_DIR%"
    if %errorlevel% neq 0 (
        echo [ОШИБКА] Не удалось создать виртуальное окружение.
        pause
        exit /b
    )
) else (
    echo Виртуальное окружение уже существует.
)

:: -------------------------------
:: 3. Копирование заранее подготовленных библиотек
:: -------------------------------
if exist "%LIB_SRC%" (
    echo Копирую подготовленные библиотеки в виртуальное окружение...
    xcopy /E /I /Y "%LIB_SRC%\*" "%VENV_DIR%\Lib\site-packages\"
) else (
    echo [ПРЕДУПРЕЖДЕНИЕ] Папка Lib с библиотеками не найдена. Django может не работать.
)

:: -------------------------------
:: 4. Активация виртуального окружения
:: -------------------------------
call "%VENV_DIR%\Scripts\activate.bat"
if %errorlevel% neq 0 (
    echo [ОШИБКА] Не удалось активировать виртуальное окружение.
    pause
    exit /b
)
echo Виртуальное окружение активировано.

:: Проверка установленного Django
python -m django --version >nul 2>&1
if %errorlevel% neq 0 (
    echo [ПРЕДУПРЕЖДЕНИЕ] Django не найден в виртуальном окружении.
    echo Убедитесь, что в папке Lib лежит пакет Django.
) else (
    echo Django найден!
)

:: -------------------------------
:: 5. Переход в папку приложения и запуск сервера
:: -------------------------------
cd /d "%APP_DIR%"
echo Переход в папку приложения: %APP_DIR%
echo Запуск Django сервера...
start "" cmd /k "%PYTHON_CMD% manage.py runserver"

:: Подождать 3 секунды для старта сервера
timeout /t 3 >nul

:: Открыть браузер
set URL=http://127.0.0.1:8000
echo Открываю браузер по адресу %URL%
start %URL%

:: Сообщение пользователю
echo.
echo ----------------------------------------
echo Сервер запущен! Если страница не открылась автоматически, перейдите по адресу выше.
echo ----------------------------------------
pause
