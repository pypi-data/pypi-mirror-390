{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://specplatform.org/schemas/aip-v0.1.schema.json",
  "title": "Agentic Implementation Plan (AIP)",
  "description": "Schema for Agentsway-aligned implementation plans with risk-based tiering",
  "type": "object",
  "required": ["version", "aip_id", "title", "tier", "objective", "plan", "orchestrator_contract"],
  "additionalProperties": true,
  "properties": {
    "version": { 
      "type": "string",
      "pattern": "^0\\.1$",
      "description": "AIP schema version"
    },
    "schema_url": {
      "type": "string",
      "format": "uri",
      "description": "URL to the canonical schema for this version"
    },
    "aip_id": { 
      "type": "string",
      "pattern": "^AIP-\\d{4}-\\d{2}-\\d{2}-\\d{3}$",
      "description": "Unique identifier (format: AIP-YYYY-MM-DD-NNN)"
    },
    "title": { 
      "type": "string",
      "minLength": 3,
      "maxLength": 100,
      "description": "Human-readable task/feature name"
    },
    "tier": { 
      "enum": ["A", "B", "C"],
      "description": "Risk tier: A=high-risk, B=moderate, C=low-risk"
    },
    "lifecycle_scope": {
      "type": "array",
      "items": { 
        "enum": ["planning", "prompting", "coding", "testing", "fine_tuning", "governance"] 
      },
      "uniqueItems": true,
      "minItems": 1,
      "description": "Which Agentsway phases this AIP covers"
    },
    "repo": {
      "type": "object",
      "required": ["url", "default_branch", "working_branch"],
      "properties": {
        "url": { 
          "type": "string",
          "pattern": "^(git@[^:]+:[^\\s]+\\.git|https?://[^\\s]+)$",
          "description": "Git repository URL (SSH or HTTPS)"
        },
        "default_branch": { 
          "type": "string",
          "pattern": "^[a-zA-Z0-9/_-]+$",
          "default": "main"
        },
        "working_branch": { 
          "type": "string",
          "pattern": "^[a-zA-Z0-9/_-]+$",
          "description": "Feature branch for this AIP"
        }
      },
      "additionalProperties": false
    },
    "paths": {
      "type": "object",
      "properties": {
        "protected": { 
          "type": "array", 
          "items": { "type": "string" },
          "description": "Path patterns that Tier C cannot modify"
        },
        "allowed": { 
          "type": "array", 
          "items": { "type": "string" },
          "description": "Path patterns this AIP may modify"
        }
      },
      "additionalProperties": false
    },
    "models_tools": {
      "type": "object",
      "properties": {
        "models": { 
          "type": "array", 
          "items": { "type": "string" },
          "description": "LLM models available for this AIP"
        },
        "tools": { 
          "type": "array", 
          "items": { "type": "string" },
          "description": "CLI tools/frameworks the agent may invoke"
        }
      },
      "additionalProperties": false
    },
    "meta": {
      "type": "object",
      "required": ["created_by", "created_at"],
      "properties": {
        "created_by": { "type": "string" },
        "created_at": { 
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp"
        },
        "stakeholders": { 
          "type": "array", 
          "items": { "type": "string" },
          "description": "Roles or people involved"
        },
        "related_aips": { 
          "type": "array", 
          "items": { 
            "type": "string",
            "pattern": "^AIP-\\d{4}-\\d{2}-\\d{2}-\\d{3}$"
          },
          "description": "Dependencies or related AIPs"
        }
      },
      "additionalProperties": false
    },
    "objective": {
      "type": "object",
      "required": ["goal", "acceptance_criteria"],
      "properties": {
        "goal": { 
          "type": "string",
          "minLength": 5,
          "description": "What we're building and why"
        },
        "acceptance_criteria": { 
          "type": "array", 
          "items": { "type": "string" },
          "minItems": 1,
          "description": "Measurable outcomes defining 'done'"
        }
      },
      "additionalProperties": false
    },
    "context": {
      "type": "object",
      "properties": {
        "background": { "type": "string" },
        "constraints": { 
          "type": "array", 
          "items": { "type": "string" },
          "description": "Architectural, compliance, or technical constraints"
        }
      },
      "additionalProperties": false
    },
    "data_classification": {
      "type": "object",
      "properties": {
        "confidentiality": { 
          "enum": ["public", "internal", "confidential", "restricted"],
          "description": "Data sensitivity level"
        },
        "contains_phi": { "type": "boolean", "default": false },
        "notes": { "type": "string" }
      },
      "additionalProperties": false
    },
    "budget_total": {
      "type": "object",
      "properties": {
        "amount": { "type": "number", "minimum": 0 },
        "currency": { "enum": ["USD", "CAD", "ARS", "EUR", "GBP"] },
        "exchange_rate_source": { "type": "string", "description": "API or static rate used" },
        "usd_equivalent": { "type": "number", "minimum": 0, "description": "Normalized for reporting" }
      },
      "required": ["amount", "currency"],
      "additionalProperties": false,
      "description": "Total budget cap for this AIP"
    },
    "metrics": {
      "type": "object",
      "properties": {
        "targets": { 
          "type": "object",
          "properties": {
            "coverage_min": { "type": "number", "minimum": 0, "maximum": 1 },
            "override_rate_max": { "type": "number", "minimum": 0, "maximum": 1 },
            "time_to_green_hours": { "type": "number", "minimum": 0 },
            "defect_density_max": { 
              "type": "number", 
              "minimum": 0,
              "description": "Maximum defects per 1000 lines of code"
            }
          },
          "additionalProperties": true
        },
        "emit": {
          "type": "array",
          "items": { 
            "enum": ["override_rate", "time_to_green", "defect_density", "coverage"] 
          },
          "description": "Which metrics must be logged"
        }
      },
      "additionalProperties": false
    },
    "governance": { 
      "type": "object",
      "properties": {
        "iso42001_controls": { "type": "array", "items": { "type": "string" } },
        "nist_ai_rmf_functions": { "type": "array", "items": { "type": "string" } },
        "privacy": {
          "type": "object",
          "properties": {
            "touches_phi": { "type": "boolean" },
            "notes": { "type": "string" }
          }
        }
      },
      "additionalProperties": true
    },
    "risk": {
      "type": "object",
      "required": ["rationale"],
      "properties": {
        "rationale": { 
          "type": "string",
          "description": "Why this tier was chosen"
        },
        "rollback_plan": { 
          "type": "string",
          "description": "How to undo this change if it fails"
        }
      },
      "additionalProperties": false
    },
    "locks": {
      "type": "object",
      "properties": {
        "paths": { 
          "type": "array", 
          "items": { "type": "string" },
          "description": "Paths that must be exclusively locked during execution"
        },
        "policy": { 
          "enum": ["exclusive", "advisory"],
          "description": "Lock enforcement level"
        }
      },
      "additionalProperties": false
    },
    "policy_packs": {
      "type": "array",
      "items": { 
        "type": "string",
        "description": "URI or path to reusable policy pack"
      }
    },
    "gates": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["gate_id", "when", "approver_role", "required"],
        "properties": {
          "gate_id": { 
            "type": "string",
            "pattern": "^G\\d{1,3}-[a-z0-9-]+$",
            "description": "Unique gate identifier (e.g., G1-plan-approve, G12-security-review)"
          },
          "when": { 
            "type": "string",
            "pattern": "^after:step:[a-z]+-\\d{2,3}$",
            "description": "Step trigger (e.g., after:step:plan-01). Runner MUST validate step exists."
          },
          "approver_role": { "type": "string" },
          "required": { "type": "boolean" },
          "sla_hours": { "type": "number", "minimum": 0 },
          "escalation": { "type": "string" }
        },
        "additionalProperties": false
      }
    },
    "fast_lane": {
      "type": "object",
      "required": ["enabled"],
      "properties": {
        "enabled": { "type": "boolean" },
        "limits": { 
          "type": "object",
          "properties": {
            "tests": { "type": "array", "items": { "type": "string" } },
            "max_changed_files": { "type": "integer", "minimum": 1 },
            "blocked_paths": { "type": "array", "items": { "type": "string" } }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    },
    "orchestrator_contract": {
      "type": "object",
      "required": ["state_machine", "artifacts_dir", "logging"],
      "properties": {
        "state_machine": {
          "type": "object",
          "required": ["states", "events"],
          "properties": {
            "states": { 
              "type": "array", 
              "items": { 
                "enum": ["pending", "running", "awaiting_human", "failed", "succeeded", "rolled_back"]
              },
              "minItems": 6
            },
            "events": { 
              "type": "array", 
              "items": { 
                "enum": ["run_step", "await_gate", "approve", "reject", "retry", "escalate", "complete"]
              },
              "minItems": 7
            }
          },
          "additionalProperties": false
        },
        "artifacts_dir": { 
          "type": "string",
          "pattern": "^(?:\\.?[\\w./-]+/)?AIP-\\d{4}-\\d{2}-\\d{2}-\\d{3}$",
          "description": "Path to artifacts directory, must end with AIP ID"
        },
        "state_file": {
          "type": "string",
          "default": "artifacts/state.json",
          "description": "Path to state file for resume capability"
        },
        "logging": { 
          "enum": ["jsonl"],
          "description": "Audit log format"
        }
      },
      "additionalProperties": false
    },
    "provenance": {
      "type": "object",
      "properties": {
        "git_commit": { "type": "string" },
        "runner_version": { "type": "string" },
        "tool_versions": { 
          "type": "object", 
          "additionalProperties": { "type": "string" } 
        },
        "model_lock": {
          "type": "object",
          "properties": {
            "provider": { "type": "string" },
            "model_id": { "type": "string" }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": true
    },
    "plan": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["step_id", "role", "kind", "description"],
        "oneOf": [
          { "required": ["prompt_registry_id"], "not": { "required": ["prompt"] } },
          { "required": ["prompt"], "not": { "required": ["prompt_registry_id"] } },
          { "not": { "anyOf": [ { "required": ["prompt"] }, { "required": ["prompt_registry_id"] } ] } }
        ],
        "properties": {
          "step_id": { 
            "type": "string",
            "pattern": "^[a-z]+-\\d{2,3}$",
            "description": "Step identifier (e.g., plan-01, code-123)"
          },
          "role": { 
            "enum": ["planning_agent", "prompting_agent", "coding_agent", "testing_agent", "fine_tuning_agent"]
          },
          "kind": { 
            "enum": ["plan", "prompt", "code", "test", "learn"]
          },
          "description": { 
            "type": "string",
            "minLength": 10
          },
          "needs": {
            "type": "array",
            "items": { 
              "type": "string", 
              "pattern": "^[a-z]+-\\d{2,3}$" 
            },
            "description": "Step IDs that must complete before this step (enables DAG execution)"
          },
          "inputs": { 
            "type": "array", 
            "items": { "type": "string" },
            "description": "Artifact paths this step consumes"
          },
          "prompt_registry_id": { 
            "type": "string",
            "description": "Reference to a versioned prompt in the registry (exclusive with 'prompt')"
          },
          "prompt": { 
            "type": "string",
            "description": "Inline prompt text for the agent (exclusive with 'prompt_registry_id')"
          },
          "actions": { 
            "type": "array", 
            "items": { "type": "string" },
            "description": "File operations (create:/edit:/delete:)"
          },
          "commands": { 
            "type": "array", 
            "items": { "type": "string" },
            "description": "Shell commands to execute"
          },
          "outputs": { 
            "type": "array", 
            "items": { "type": "string" },
            "description": "Artifact paths this step produces"
          },
          "timeout_s": {
            "type": "number",
            "minimum": 1,
            "description": "Overall step timeout in seconds"
          },
          "retries": {
            "type": "integer",
            "minimum": 0,
            "default": 0,
            "description": "Number of automatic retries on failure"
          },
          "verify": {
            "type": "object",
            "properties": {
              "assertions": { 
                "type": "array", 
                "items": { "type": "string" },
                "description": "Human-readable checks"
              },
              "commands": { 
                "type": "array", 
                "items": { "type": "string" },
                "description": "Commands that must succeed"
              },
              "require_green": { 
                "type": "boolean",
                "description": "Halt on test failure"
              },
              "coverage_min": { "type": "number", "minimum": 0, "maximum": 1 },
              "timeout_s": { "type": "number", "minimum": 1 }
            },
            "additionalProperties": false
          },
          "on_fail": {
            "type": "object",
            "properties": {
              "retry": { "type": "integer", "minimum": 0 },
              "backoff_s": { "type": "number", "minimum": 0 },
              "then": { 
                "type": "object",
                "additionalProperties": true
              },
              "escalate": { "type": "boolean" },
              "ignore": { "type": "boolean" }
            },
            "additionalProperties": false
          },
          "budget": {
            "type": "object",
            "properties": {
              "amount": { "type": "number", "minimum": 0 },
              "currency": { "enum": ["USD", "CAD", "ARS", "EUR", "GBP"] },
              "exchange_rate_source": { "type": "string" },
              "usd_equivalent": { "type": "number", "minimum": 0 }
            },
            "required": ["amount", "currency"],
            "additionalProperties": false,
            "description": "Maximum cost for this step"
          }
        },
        "additionalProperties": false
      }
    },
    "pull_request": { 
      "type": "object",
      "properties": {
        "required": { "type": "boolean" },
        "title": { "type": "string" },
        "reviewers": { "type": "array", "items": { "type": "string" } },
        "merge_policy": {
          "type": "object",
          "properties": {
            "strategy": { "enum": ["merge", "squash", "rebase"] },
            "require_status_checks": { "type": "boolean" },
            "block_on_paths": { "type": "array", "items": { "type": "string" } }
          }
        }
      },
      "additionalProperties": false
    },
    "audit": { 
      "type": "object",
      "properties": {
        "decision_log": { "type": "string" },
        "evidence": { "type": "array", "items": { "type": "string" } }
      },
      "additionalProperties": false
    },
    "notifications": { 
      "type": "object",
      "properties": {
        "on_events": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["event", "channel"],
            "properties": {
              "event": { 
                "enum": ["awaiting_human", "failed", "succeeded", "step_started", "step_completed", "gate_opened", "gate_decided"],
                "description": "Event type that triggers notification"
              },
              "channel": { 
                "type": "string",
                "description": "Notification destination (e.g., slack://#channel, email:user@example.com)"
              }
            }
          }
        }
      },
      "additionalProperties": false
    }
  }
}
