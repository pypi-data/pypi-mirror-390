name: PyPI Release

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type (patch/minor/major)'
        required: false
        type: choice
        options:
          - patch
          - minor
          - major
      version:
        description: 'Specific version to release (e.g., 0.1.1)'
        required: false
        type: string
  push:
    branches:
      - main
    paths:
      - 'pyproject.toml'

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should-release: ${{ steps.check.outputs.should_release }}
      new-version: ${{ steps.check.outputs.new_version }}
      old-version: ${{ steps.check.outputs.old_version }}
      is-semantic: ${{ steps.check.outputs.is_semantic }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check version and determine if should release
        id: check
        run: |
          # Initialize variables with default values
          SHOULD_RELEASE="false"
          NEW_VERSION=""
          OLD_VERSION=""
          IS_SEMANTIC="false"
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ -n "${{ github.event.inputs.version }}" ]; then
              # Manual dispatch with specific version
              NEW_VERSION="${{ github.event.inputs.version }}"
              OLD_VERSION=$(grep -E '^version\s*=' pyproject.toml | sed -E 's/version\s*=\s*["'\'']([^"'\'']+)["'\'']/\1/')
              
              # Validate semantic version format
              if [[ "$NEW_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                SHOULD_RELEASE="true"
                IS_SEMANTIC="true"
              else
                echo "Error: Version must follow semantic versioning (X.Y.Z)"
                exit 1
              fi
            elif [ -n "${{ github.event.inputs.release_type }}" ]; then
              # Manual dispatch with release type
              RELEASE_TYPE="${{ github.event.inputs.release_type }}"
              CURRENT_VERSION=$(grep -E '^version\s*=' pyproject.toml | sed -E 's/version\s*=\s*["'\'']([^"'\'']+)["'\'']/\1/')
              
              IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
              MAJOR=${VERSION_PARTS[0]}
              MINOR=${VERSION_PARTS[1]}
              PATCH=${VERSION_PARTS[2]}
              
              case "$RELEASE_TYPE" in
                major)
                  MAJOR=$((MAJOR + 1))
                  MINOR=0
                  PATCH=0
                  ;;
                minor)
                  MINOR=$((MINOR + 1))
                  PATCH=0
                  ;;
                patch)
                  PATCH=$((PATCH + 1))
                  ;;
              esac
              
              NEW_VERSION="$MAJOR.$MINOR.$PATCH"
              OLD_VERSION="$CURRENT_VERSION"
              SHOULD_RELEASE="true"
              IS_SEMANTIC="true"
            else
              # Manual dispatch without inputs - use current version from pyproject.toml
              echo "Warning: workflow_dispatch executed without inputs. Using current version from pyproject.toml"
              CURRENT_VERSION=$(grep -E '^version\s*=' pyproject.toml | sed -E 's/version\s*=\s*["'\'']([^"'\'']+)["'\'']/\1/')
              
              if [[ "$CURRENT_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                NEW_VERSION="$CURRENT_VERSION"
                OLD_VERSION="$CURRENT_VERSION"
                SHOULD_RELEASE="true"
                IS_SEMANTIC="true"
                echo "Using current version for release: $CURRENT_VERSION"
              else
                echo "Error: Current version '$CURRENT_VERSION' does not follow semantic versioning (X.Y.Z)"
                echo "Please specify a valid version using 'version' input or 'release_type' input"
                exit 1
              fi
            fi
          else
            # Automatic trigger on push
            if git diff HEAD~1 HEAD --name-only | grep -q "^pyproject.toml$"; then
              OLD_VERSION=$(git show HEAD~1:pyproject.toml | grep -E '^version\s*=' | sed -E 's/version\s*=\s*["'\'']([^"'\'']+)["'\'']/\1/')
              NEW_VERSION=$(grep -E '^version\s*=' pyproject.toml | sed -E 's/version\s*=\s*["'\'']([^"'\'']+)["'\'']/\1/')
              
              echo "Version comparison: OLD=$OLD_VERSION, NEW=$NEW_VERSION"
              
              if [ "$OLD_VERSION" != "$NEW_VERSION" ]; then
                # Validate semantic version format (X.Y.Z)
                if [[ "$NEW_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                  SHOULD_RELEASE="true"
                  IS_SEMANTIC="true"
                  echo "Semantic version detected: $OLD_VERSION -> $NEW_VERSION"
                else
                  echo "Warning: Version $NEW_VERSION does not follow semantic versioning (X.Y.Z format)"
                fi
              else
                echo "Version unchanged: $OLD_VERSION == $NEW_VERSION, skipping release"
              fi
            else
              echo "pyproject.toml was not changed in this commit, skipping release"
            fi
          fi
          
          # Write outputs once at the end to avoid duplicates
          echo "should_release=$SHOULD_RELEASE" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "old_version=$OLD_VERSION" >> $GITHUB_OUTPUT
          echo "is_semantic=$IS_SEMANTIC" >> $GITHUB_OUTPUT
          
          # Debug output
          echo "Debug - Outputs set:"
          echo "  should_release: $SHOULD_RELEASE"
          echo "  new_version: $NEW_VERSION"
          echo "  old_version: $OLD_VERSION"
          echo "  is_semantic: $IS_SEMANTIC"
          
      - name: Display outputs for debugging
        run: |
          echo "Job outputs will be:"
          echo "  should-release: ${{ steps.check.outputs.should_release }}"
          echo "  new-version: ${{ steps.check.outputs.new_version }}"
          echo "  old-version: ${{ steps.check.outputs.old_version }}"
          echo "  is-semantic: ${{ steps.check.outputs.is_semantic }}"

  build-test-release:
    needs: check-version
    if: needs.check-version.outputs.should-release == 'true' && needs.check-version.outputs.is-semantic == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libmagic1

      - name: Setup Rye
        uses: eifinger/setup-rye@v4

      - name: Install dependencies
        run: rye sync

      - name: Run tests
        run: rye run pytest src/combinatorial_config -v

      - name: Build package
        run: rye build --all

      - name: Check package
        run: rye run twine check dist/*

      - name: Publish to TestPyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TESTPYPI_API_TOKEN }}
        run: rye run twine upload --repository testpypi dist/* --verbose

      - name: Verify TestPyPI installation
        run: |
          pip install --index-url https://test.pypi.org/simple/ --no-deps combinatorial-config==${{ needs.check-version.outputs.new-version }} || true

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: rye run twine upload dist/* --verbose

