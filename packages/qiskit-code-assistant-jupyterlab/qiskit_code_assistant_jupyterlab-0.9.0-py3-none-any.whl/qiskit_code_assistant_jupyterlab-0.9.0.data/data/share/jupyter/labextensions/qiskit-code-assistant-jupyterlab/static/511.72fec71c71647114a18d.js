"use strict";(self.webpackChunkqiskit_code_assistant_jupyterlab=self.webpackChunkqiskit_code_assistant_jupyterlab||[]).push([[511],{511:(e,t,n)=>{n.r(t),n.d(t,{default:()=>X});var o=n(986),s=n(956),i=n(762),a=n(560),r=n(748),c=n(694),l=n(256),d=n(297),u=n(860);async function m(e="",t={}){const n=u.ServerConnection.makeSettings(),o=d.URLExt.join(n.baseUrl,"qiskit-code-assistant",e);let s;try{s=await u.ServerConnection.makeRequest(o,t,n)}catch(e){throw console.error("The qiskit_code_assistant_jupyterlab server extension appears to be missing.\n",e),new u.ServerConnection.NetworkError(e)}return s}const h=[401,403,422];async function p(e){h.includes(e.status)&&await e.json().then(e=>{e.detail&&o.Notification.error(`Qiskit Code Assistant:\n${e.detail}`,{autoClose:!1})})}async function g(e){return await m("service",{method:"POST",body:JSON.stringify({url:e})}).then(e=>{if(e.ok)return e.json().then(e=>(console.debug("Updated service URL:",e.url),e));throw console.error("Error updating service URL",e.status,e.statusText),Error(e.statusText)})}function f(e,t={}){if(!e.startsWith("data: "))return null;try{const t=e.substring(6);if(!t)return null;const n=JSON.parse(t);if(n.error){if(console.error(`Backend streaming error: ${n.error}`,n),o.Notification.error(`Qiskit Code Assistant Error:\n${n.error}`,{autoClose:5e3}),"chunk_processing_error"!==n.type)throw new Error(n.error);return null}return n}catch(n){if(console.error(`Error parsing JSON chunk: ${n}`,{line:e.substring(0,100),...t}),!(n instanceof SyntaxError))throw n;return null}}async function b(e){return await m(`prompt/${e}/acceptance`,{method:"POST",body:JSON.stringify({accepted:!0})}).then(async e=>{if(e.ok)return await e.json();throw p(e),console.error("Error accepting prompt",e.status,e.statusText),Error(e.statusText)})}async function w(){return await m("credentials").then(async e=>{if(e.ok){const t=await e.json();return console.debug("credentials list:",t),t}throw console.error("Error getting credentials",e.status,e.statusText),Error(e.statusText)})}async function k(e){return await m("credentials",{method:"POST",body:JSON.stringify({credential_name:e})}).then(e=>{if(!e.ok)throw console.error("Error selecting credential",e.status,e.statusText),Error(e.statusText);e.json().then(e=>{const t=`Switched to credential: ${e.selected_credential}`;o.Notification.info(`Qiskit Code Assistant:\n${t}`,{autoClose:3e3}),console.debug(t)})})}async function v(e){return await m("credentials",{method:"PUT",body:JSON.stringify(e)}).then(t=>{if(!t.ok)throw console.error("Error updating credential flags",t.status,t.statusText),Error(t.statusText);console.debug("Credential flags updated:",e)})}var y=n(345),_=n.n(y);let C,E=[];function A(){return E}function S(){return C}function T(e){var t;C=E.find(t=>t._id===(null==e?void 0:e._id)),null===(t=J.widget)||void 0===t||t.refreshStatusBar()}async function x(){return await async function(){return await m("models").then(async e=>{if(e.ok){const t=await e.json();return console.debug("models list:",t),t.models}throw p(e),console.error("Error getting models",e.status,e.statusText),Error(e.statusText)})}().then(e=>{var t;E=e,C=E.find(e=>e._id===(null==C?void 0:C._id))||(null==e?void 0:e[0]),null===(t=J.widget)||void 0===t||t.refreshStatusBar()}).catch(e=>{throw new Error(e)})}async function I(e){return await async function(e){return await m(`model/${e}/disclaimer`).then(async e=>{if(e.ok)return await e.json();throw p(e),console.error("Error getting disclaimer",e.status,e.statusText),Error(e.statusText)})}(e).then(async t=>{if(t.accepted)return t.accepted;const n={__html:t.body};return await(0,o.showDialog)({title:t.title,body:_().createElement("div",{dangerouslySetInnerHTML:n}),buttons:[o.Dialog.cancelButton(),o.Dialog.okButton({label:"Accept"})]}).then(async n=>!!n.button.accept&&await async function(e,t){return await m(`disclaimer/${e}/acceptance`,{method:"POST",body:JSON.stringify({model:t,accepted:!0})}).then(async e=>{if(e.ok)return await e.json();throw p(e),console.error("Error accepting disclaimer",e.status,e.statusText),Error(e.statusText)})}(t._id,e).then(async e=>await x().then(()=>e.success)))})}async function N(e=!1){try{const t=await w(),{credentials:n,selected_credential:s,using_env_var:i}=t;if(i)return void await(0,o.showDialog)({title:"Environment Variable Override",body:"The QISKIT_IBM_TOKEN environment variable is currently set and will override any credential selection. To use credentials from ~/.qiskit/qiskit-ibm.json, unset the QISKIT_IBM_TOKEN environment variable and restart JupyterLab.",buttons:[o.Dialog.okButton({label:"Understood"})]});if(0===n.length)return void await(0,o.showDialog)({title:"No Credentials Found",body:'No credentials found in ~/.qiskit/qiskit-ibm.json. Please add your IBM Quantum credentials to the file or use the "Set IBM Quantum API token" command.',buttons:[o.Dialog.okButton()]});if(!e){const e=await(0,o.showDialog)({title:"Select IBM Quantum Credential",body:"Choose how you want to authenticate:",buttons:[o.Dialog.okButton({label:"Select Credential"}),o.Dialog.warnButton({label:"Enter Token Manually"}),o.Dialog.cancelButton()]});if("Enter Token Manually"===e.button.label)return void await B();if(!e.button.accept)return}const a=n.map(e=>e.name===s?`${e.name} (current)`:e.name),r=n.findIndex(e=>e.name===s),c=await o.InputDialog.getItem({title:"Select IBM Quantum Credential",items:a,current:r>=0?r:0,label:"Choose which credential from ~/.qiskit/qiskit-ibm.json to use:"});if(c.button.accept&&c.value){const e=c.value.replace(" (current)",""),t=n.find(t=>t.name===e);t&&(t.name!==s?(await k(t.name),await x()):console.debug("Selected same credential, no action needed"))}}catch(e){throw console.error("Error selecting credential:",e),e}}async function q(){if(!await async function(){return await m("token").then(async e=>{if(e.ok)return(await e.json()).success;throw console.error("Error getting models",e.status,e.statusText),Error(e.statusText)})}()){try{if((await w()).credentials.length>1)return await async function(){try{const e=await w(),{credentials:t}=e;if(0===t.length)return void console.debug("No credentials found in qiskit-ibm.json");if(1===t.length)return void(e.selected_credential||await k(t[0].name));await N()}catch(e){console.error("Error checking credentials:",e)}}()}catch(e){console.debug("No credentials found in config file")}return await B()}}async function B(){await o.InputDialog.getPassword({title:"Enter your API token from quantum.cloud.ibm.com",label:"In order to use Qiskit Code Assistant you need a IBM Quantum API Token"}).then(async e=>{if(e.button.accept&&e.value)return await async function(e){return await m("token",{method:"POST",body:JSON.stringify({token:e})}).then(e=>{if(!e.ok)throw console.error("Error submitting IBM Quantum API Token",e.status,e.statusText),Error(e.statusText);e.json().then(e=>{const t="IBM Quantum API Token saved";o.Notification.info(`Qiskit Code Assistant:\n${t}`,{autoClose:!1}),console.debug(t)})})}(e.value).then(async()=>{try{return await x()}catch(e){console.error("Failed to load models list",e)}});throw Error("API token not set")}).catch(()=>{throw Error("API token not set")})}let P=null;function D(e){var t,n;return null!==(n=null!==(t=null==e?void 0:e.generated_text)&&void 0!==t?t:null==e?void 0:e.results[0].generated_text)&&void 0!==n?n:""}async function M(e,t,n){return J.widget.setLoadingStatus(),async function(e,t,n){return await m(`model/${e}/prompt`,{method:"POST",body:JSON.stringify({input:t}),signal:n}).then(async e=>{if(e.ok){const t=await e.json();return console.debug("prompt:",t),t}throw p(e),console.error("Error sending prompt",e.status,e.statusText),Error(e.statusText)})}(e,t,n).then(e=>{const n=[];return e.results.map(e=>n.push(e.generated_text)),{items:n,prompt_id:e.prompt_id,input:t}})}async function*j(e,t,n){J.widget.setLoadingStatus();const s=async function*(e,t,n){const s=await async function*(e="",t={},n){const o=u.ServerConnection.makeSettings(),s=d.URLExt.join(o.baseUrl,"qiskit-code-assistant",e),i={...t,signal:n||t.signal};let a;const r=new TextDecoder;try{if(a=await u.ServerConnection.makeRequest(s,i,o),!a.body)throw console.error("The qiskit_code_assistant_jupyterlab server extension request returned no body."),new u.ServerConnection.ResponseError(a,"Fetch failed. No response body returned.");const e=a.body.getReader();try{for(;;){const{done:t,value:n}=await e.read();if(t)break;yield r.decode(n,{stream:!0})}const t=r.decode();t&&(yield t)}finally{e.releaseLock()}}catch(e){if(e instanceof Error&&"AbortError"===e.name)throw console.debug("Streaming request was aborted"),e;throw console.error("The qiskit_code_assistant_jupyterlab server extension appears to be missing.\n",e),new u.ServerConnection.NetworkError(e)}}(`model/${e}/prompt`,{method:"POST",body:JSON.stringify({input:t,stream:!0})},n);let i="";for await(const e of s){if(null==n?void 0:n.aborted){console.debug("Stream processing aborted by signal");break}if(i+=e,i.length>1048576){const e="Stream buffer exceeded maximum size (1048576 bytes)";throw console.error(e),o.Notification.error(`Qiskit Code Assistant Error:\n${e}`,{autoClose:5e3}),new Error(e)}const t=i.split("\n");i=t.pop()||"";for(const e of t){const t=f(e.trim(),{buffer:i});t&&(yield t)}}if(i.trim()){const e=i.trim(),t=f(e,{buffer:e});t&&(yield t)}}(e,t,n);for await(const e of s){const n={items:[D(e)],prompt_id:e.prompt_id,input:t};yield n}}async function L(e){const t={items:[],prompt_id:"",input:""};P&&(console.debug("Cancelling previous non-streaming request before starting new one"),P.abort(),J.widget.stopLoadingStatus());const n=new AbortController;return P=n,await q().then(async()=>{var o;const s=Math.max(0,e.length-4e3),i=e.slice(s,e.length),a=S();return void 0===a?(console.error("Failed to send prompt","No model selected"),t):(null===(o=a.disclaimer)||void 0===o?void 0:o.accepted)?await M(a._id,i,n.signal):await I(a._id).then(async e=>e?await M(a._id,i,n.signal):(console.error("Disclaimer not accepted"),t))}).catch(e=>(e instanceof Error&&"AbortError"===e.name?console.debug("Non-streaming request was cancelled"):console.error("Failed to send prompt",e),t)).finally(()=>{P===n&&(P=null,J.widget.stopLoadingStatus())})}const Q=new c.LabIcon({name:"qiskit:feedback",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 32 32">\n  <polygon class="jp-icon2" fill="#000" points="22 4 22 6 26.586 6 20 12.586 21.414 14 28 7.414 28 12 30 12 30 4 22 4"/>\n  <path class="jp-icon2" fill="#000" d="M28,16v4a1.9965,1.9965,0,0,1-2,2H20l-4,7,1.7358,1,3.4288-6H26a3.9992,3.9992,0,0,0,4-4V16Z"/>\n  <path class="jp-icon2" fill="#000" d="M4,20V8A1.9965,1.9965,0,0,1,6,6H18V4H6A3.9986,3.9986,0,0,0,2,8V20a3.9992,3.9992,0,0,0,4,4h9V22H6A1.9965,1.9965,0,0,1,4,20Z"/>\n</svg>\n'}),O=new c.LabIcon({name:"qiskit:logo",svgstr:'<svg id="qiskit" xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 200 200">\n    <path fill="#fff" d="M174.09,100.19c0-.07,0-.14,0-.22s0-.44,0-.67a74.13,74.13,0,0,0-15-44,12.85,12.85,0,0,0-3.37-4.11A74.34,74.34,0,0,0,102.42,26c-.8,0-1.61-.08-2.42-.08s-1.41,0-2.11.06A74,74,0,0,0,44.23,51.21a12.68,12.68,0,0,0-3.42,4.24A74.53,74.53,0,0,0,25.91,99.7a2.45,2.45,0,0,0,0,.27c0,.13,0,.25,0,.37A73.93,73.93,0,0,0,41.12,145a11.89,11.89,0,0,0,2.3,2.88,74.38,74.38,0,0,0,54.51,26.19c.69,0,1.38.05,2.07.05s1.27,0,1.91,0a74,74,0,0,0,54.88-26.49,12.65,12.65,0,0,0,2-2.51A74.64,74.64,0,0,0,174.09,100.19Zm-20.54,44.66c-3.56,3.23-11.35,6.54-22.6,8.83a6.47,6.47,0,0,0-5.68-3.35l-.51,0L114.07,126a128.16,128.16,0,0,1,24.71,4.12c10.45,3,16.95,7.17,16.95,11a3.66,3.66,0,0,1-.44,1.62C154.73,143.4,154.15,144.13,153.55,144.85Zm-54.9,11.78c-25.6-.27-45-5.52-51.76-11.25-.77-.91-1.53-1.84-2.27-2.8a3.91,3.91,0,0,1-.35-1.53c0-3.3,5.24-8.11,19.94-11.74a152.92,152.92,0,0,1,34-3.85H100c3.14,0,6.25.08,9.3.23l11.57,26.38a6.48,6.48,0,0,0-2,3.49A181.25,181.25,0,0,1,98.65,156.63Zm-1.18,13.16c-7.52-.48-12-3-12-4.38S91,161,100,161s14.56,2.89,14.56,4.46-4.66,4-12.39,4.4C100.6,169.85,99,169.85,97.47,169.79ZM47.37,54.07c4-3.1,11.52-6,21.71-8a7,7,0,0,0,6.22,3.8,5.85,5.85,0,0,0,.73,0L86.62,74C61.15,72,44.27,65.06,44.27,58.89a4,4,0,0,1,.24-1.3C45.43,56.39,46.37,55.21,47.37,54.07ZM100,43.29c25.78,0,45.41,5.07,52.67,10.82,1,1.1,1.9,2.25,2.8,3.42a3.9,3.9,0,0,1,.26,1.36c0,6.51-21.73,15.59-57.08,15.59-2.49,0-4.91-.1-7.27-.22L79.91,48.11a7,7,0,0,0,2.26-4C87.68,43.6,93.65,43.29,100,43.29Zm-14.56-8.7c0-1.47,4.85-4.1,12.9-4.42l1.54,0c.65,0,1.29,0,1.94,0,8,.35,12.74,3,12.74,4.41S109,39.05,100,39.05,85.44,36.17,85.44,34.59Zm50.43,47.27c20.23,3.84,33.44,10.74,34,17.68,0,.2,0,.4,0,.59-.27,8.9-23.45,18.63-58,20.69l-18.41-42q3.28-.1,6.61-.11A195.75,195.75,0,0,1,135.87,81.86ZM71.59,76.35q-4.26.59-8.28,1.35h0c-15.25,2.9-26.5,7.44-32.49,12.87A70.51,70.51,0,0,1,41,62.63C44.42,69.11,56.6,73.76,71.59,76.35ZM30.15,99.76c.26-7,13.53-14,33.95-17.89h0A186.59,186.59,0,0,1,88.84,79l18.43,42c-2.92.11-5.9.18-9,.18-40.45-.46-67.71-11.18-68.15-21C30.16,100.07,30.15,99.91,30.15,99.76ZM139.94,126a110.87,110.87,0,0,0-11.74-2.6,142.17,142.17,0,0,0,22.48-4.9c8.4-2.64,14.61-5.76,18.52-9.24a70.22,70.22,0,0,1-10.17,28C156.75,132.82,150.27,129,139.94,126Zm29.28-35.41c-6-5.46-17.26-10-32.55-12.92q-4.15-.78-8.57-1.38C143.38,73.67,155.57,69,159,62.57c.91,1.43,1.77,2.89,2.58,4.4A69.53,69.53,0,0,1,169.22,90.61Zm-53.7-50.9A6.4,6.4,0,0,0,118.76,35a2.12,2.12,0,0,0,0-.44,2,2,0,0,0,0-.43,5.19,5.19,0,0,0-.36-1.52A70.09,70.09,0,0,1,142.68,44.7,127.08,127.08,0,0,0,115.52,39.71ZM67,38.43A70.14,70.14,0,0,1,81.62,32.6a4.82,4.82,0,0,0-.38,1.56,2,2,0,0,0,0,.43,2.12,2.12,0,0,0,0,.44,6.43,6.43,0,0,0,3.24,4.68L81.66,40a7,7,0,0,0-13.28,1.93,94.18,94.18,0,0,0-11,2.79A70,70,0,0,1,67,38.43Zm-36.2,70.9c3.71,3.34,9.49,6.35,17.25,8.91a136.36,136.36,0,0,0,23.4,5.24c-2.86.49-5.61,1.06-8.22,1.71h0c-12,3-19.68,7.2-22.22,12.14-.89-1.4-1.74-2.82-2.54-4.3A69.65,69.65,0,0,1,30.77,109.33Zm53.86,50.85c-2,1.27-3.22,2.87-3.39,4.8a2,2,0,0,0,0,.43,2.12,2.12,0,0,0,0,.44,5,5,0,0,0,.35,1.49A70.2,70.2,0,0,1,56.9,155,127.31,127.31,0,0,0,84.63,160.18Zm48.4,1.39a69.81,69.81,0,0,1-14.64,5.82,5.1,5.1,0,0,0,.37-1.54,2.12,2.12,0,0,0,0-.44,2,2,0,0,0,0-.43c-.17-2-1.45-3.58-3.48-4.85,1.41-.13,2.8-.28,4.19-.44a6.48,6.48,0,0,0,12.21-1.9,98,98,0,0,0,11.72-3.06A69.92,69.92,0,0,1,133,161.57Z"/>\n</svg>'}),$="qiskit-code-assistant:prompt-feedback";let F;const R=()=>F=void 0;function Z(e,t){const n=[];if(t instanceof i.NotebookPanel){const o=t.content.activeCellIndex,s=t.content.widgets;for(let e=0;e<o;e++)if(["code","markdown"].includes(s[e].model.type)){const t=s[e].model.toJSON().source;n.push(Array.isArray(t)?t.join("\n"):t)}return n.push(e),n.join("\n")}return e}class K{constructor(e){this.identifier="QiskitCodeAssistant:completer",this.rank=1100,this.prompt_id="",this.results=[],this.settings=e.settings,this.app=e.app}async fetch(e,t){return L(Z(e.text,t.widget)).then(t=>(this.prompt_id=t.prompt_id,this.results=t.items,this.prompt_id&&(F=t,this.app.commands.notifyCommandChanged($)),{start:e.offset,end:e.offset,items:t.items.map(e=>({label:e.trim(),insertText:e,icon:O}))}))}async isApplicable(e){return this.settings.composite.enableCompleter}accept(e){this.prompt_id&&this.results.includes(e)&&b(this.prompt_id)}}class z{constructor(e){var t;this.icon=O,this.identifier="qiskit-code-assistant-inline-completer",this.name="Qiskit Code Assistant",this.prompt_id="",this.schema={default:{enabled:!0,timeout:15e3}},this._streamPromises=new Map,this._currentNotebook=null,this.settings=e.settings,this.app=e.app,this._boundKeyDown=this._onKeyDown.bind(this),this._boundFocusOut=this._onFocusOut.bind(this),document.addEventListener("keydown",this._boundKeyDown),document.addEventListener("focusout",this._boundFocusOut),(null===(t=this.app.shell)||void 0===t?void 0:t.currentChanged)&&this.app.shell.currentChanged.connect(this._onShellChanged,this);const n=this.app.shell.currentWidget;n instanceof i.NotebookPanel&&this._setupNotebookListeners(n)}_onKeyDown(e){"Escape"===e.key&&this._streamPromises.size>0&&(console.debug(`ESC pressed with ${this._streamPromises.size} active stream(s), cancelling`),this.cancelAllStreams())}_onFocusOut(e){this._streamPromises.size>0&&setTimeout(()=>{this._streamPromises.size>0&&(console.debug(`Focus lost with ${this._streamPromises.size} active stream(s), cancelling`),this.cancelAllStreams())},100)}_setupNotebookListeners(e){this._currentNotebook!==e&&(this._currentNotebook&&(this._currentNotebook.content.activeCellChanged.disconnect(this._onActiveCellChanged,this),this._currentNotebook.content.model&&this._currentNotebook.content.model.contentChanged.disconnect(this._onContentChanged,this)),this._currentNotebook=e,e.content.activeCellChanged.connect(this._onActiveCellChanged,this),e.content.model&&e.content.model.contentChanged.connect(this._onContentChanged,this))}_onContentChanged(){this._streamPromises.size>0&&(console.debug(`Notebook content changed with ${this._streamPromises.size} active stream(s), cancelling`),this.cancelAllStreams())}_onActiveCellChanged(){this._streamPromises.size>0&&(console.debug(`Active cell changed with ${this._streamPromises.size} active stream(s), cancelling`),this.cancelAllStreams())}_onShellChanged(e,t){this._streamPromises.size>0&&(console.debug(`Shell changed with ${this._streamPromises.size} active stream(s), cancelling`),this.cancelAllStreams()),t.newValue instanceof i.NotebookPanel&&this._setupNotebookListeners(t.newValue)}dispose(){var e;document.removeEventListener("keydown",this._boundKeyDown),document.removeEventListener("focusout",this._boundFocusOut),(null===(e=this.app.shell)||void 0===e?void 0:e.currentChanged)&&this.app.shell.currentChanged.disconnect(this._onShellChanged,this),this._currentNotebook&&(this._currentNotebook.content.activeCellChanged.disconnect(this._onActiveCellChanged,this),this._currentNotebook.content.model&&this._currentNotebook.content.model.contentChanged.disconnect(this._onContentChanged,this),this._currentNotebook=null),this.cancelAllStreams()}async fetch(e,t){if(t.triggerKind===s.InlineCompletionTriggerKind.Automatic)return{items:[]};const n=this.settings.composite.enableStreaming,o=Z(e.text,t.widget);if(n){this._streamPromises.size>0&&(console.debug(`Cancelling ${this._streamPromises.size} existing stream(s) before starting new one`),this.cancelAllStreams());const e=new AbortController,t=`qiskit-code-assistant_${Date.now()}_${Math.random().toString(36).substring(2,11)}`,n=(this.schema.default.timeout||3e4)+Math.min(Math.floor(o.length/50),6e4),s=setTimeout(()=>{console.warn(`Streaming request timed out after ${n}ms`),e.abort(),this._streamPromises.delete(t)},n),i=async function*(e,t){var n;const o={items:[],prompt_id:"",input:""};try{await q();const s=Math.max(0,e.length-4e3),i=e.slice(s,e.length),a=S();if(void 0===a)return console.error("Failed to send prompt","No model selected"),void(yield o);if(null===(n=a.disclaimer)||void 0===n?void 0:n.accepted){const e=j(a._id,i,t);for await(const t of e)yield t}else if(await I(a._id)){const e=j(a._id,i,t);for await(const t of e)yield t}else console.error("Disclaimer not accepted"),yield o}catch(e){console.error("Failed to send prompt",e),e instanceof Error&&"AbortError"===e.name?console.debug("Streaming was cancelled by user"):yield o}finally{J.widget.stopLoadingStatus()}}(o,e.signal);return this._streamPromises.set(t,{generator:i,abortController:e,timeoutId:s}),Promise.resolve({items:[{insertText:"",isIncomplete:!0,token:t}]})}return L(o).then(e=>(this.prompt_id=e.prompt_id,this.prompt_id&&(F=e,this.app.commands.notifyCommandChanged($)),{items:e.items.map(e=>({insertText:e}))}))}async*stream(e){const t=this._streamPromises.get(e);if(!t)return void console.warn(`Stream context not found for token: ${e}`);const{generator:n,timeoutId:o}=t,s=[];let i;try{for await(const e of n){i=e;const t=i.items[0];t&&(s.push(t),yield{response:{insertText:s.join("")}}),i&&i.prompt_id&&!this.prompt_id&&(this.prompt_id=i.prompt_id,F=i,this.app.commands.notifyCommandChanged($))}i&&(F=i)}catch(t){t instanceof Error&&"AbortError"===t.name?console.debug(`Stream ${e} was aborted`):console.error("Error during streaming:",t)}finally{o&&clearTimeout(o),this._streamPromises.delete(e),J.widget.stopLoadingStatus()}}cancelStream(e){const t=this._streamPromises.get(e);t&&(t.timeoutId&&clearTimeout(t.timeoutId),t.abortController.abort(),this._streamPromises.delete(e),J.widget.stopLoadingStatus(),console.debug(`Cancelled stream: ${e}`))}cancelAllStreams(){const e=this._streamPromises.size;for(const[e,t]of this._streamPromises.entries())t.timeoutId&&clearTimeout(t.timeoutId),t.abortController.abort(),console.debug(`Cancelled stream: ${e}`);this._streamPromises.clear();for(let t=0;t<e;t++)J.widget.stopLoadingStatus()}async isApplicable(e){return!0}accept(){this.prompt_id&&b(this.prompt_id)}}class J extends l.Widget{constructor(){super(),this._activeRequestCount=0;const e=document.createElement("div");e.title="Click to change the model",e.classList.add("jp-qiskit-code-assistant-statusbar"),e.classList.add("jp-StatusBar-GroupItem"),this.addClass("jp-mod-highlighted"),this.node.appendChild(e),this._statusBar=e,this.refreshStatusBar(),J.widget=this}async refreshStatusBar(){const e=S();e?(this._statusBar.innerHTML="Qiskit Code Assistant: "+e.display_name,this._statusBar.title="Click to change the model",this.removeClass("jp-qiskit-code-assistant-statusbar-warn")):(this._statusBar.innerHTML="Qiskit Code Assistant: No Model Selected",this._statusBar.title="No model selected. Click to select a model.",this.addClass("jp-qiskit-code-assistant-statusbar-warn"))}setLoadingStatus(){this._activeRequestCount++,1===this._activeRequestCount&&(this._statusBar.innerHTML=this._statusBar.innerHTML+c.refreshIcon.svgstr)}stopLoadingStatus(){this._activeRequestCount=Math.max(0,this._activeRequestCount-1),0===this._activeRequestCount&&this.refreshStatusBar()}async onClick(){await q().then(()=>{var e;const t=A(),n=[...t.map(e=>e.display_name)];o.InputDialog.getItem({title:"Select a Model",items:n,current:n.indexOf((null===(e=S())||void 0===e?void 0:e.display_name)||"")}).then(e=>{if(e.button.accept){const n=t.find(t=>t.display_name===e.value);n&&I(n._id).then(e=>{e&&(R(),T(n))})}})})}onAfterAttach(e){super.onAfterAttach(e),this._statusBar.addEventListener("click",this.onClick.bind(this))}onBeforeDetach(e){this._statusBar.removeEventListener("click",this.onClick.bind(this)),super.onBeforeDetach(e)}}function U(){const e=c.ReactWidget.create(_().createElement("div",{className:"jp-qiskit-code-assistant-feedback",title:"Give feedback for the Qiskit Code Assistant",onClick:()=>H(!1)},_().createElement(Q.react,{stylesheet:"statusBar",tag:"span",top:"2px",verticalAlign:"middle"})));return e.addClass("jp-mod-highlighted"),e}function H(e=!0){var t;const n=null===(t=S())||void 0===t?void 0:t._id,s=e?null==F?void 0:F.prompt_id:void 0,i=e?null==F?void 0:F.input:void 0,a=e?null==F?void 0:F.items[0]:void 0,r=new o.Dialog({title:"Qiskit Code Assistant Feedback",body:V(a),buttons:[o.Dialog.cancelButton(),o.Dialog.okButton({label:"Submit"})],focusNodeSelector:".jp-qiskit-code-assistant-feedback-form textarea"}),c=r.handleEvent;return r.handleEvent=e=>{"keydown"===e.type&&"Enter"===e.code&&document.activeElement instanceof HTMLTextAreaElement||c.call(r,e)},r.launch().then(e=>{var t,r,c,l;e.button.accept&&((null===(t=e.value)||void 0===t?void 0:t.positive_feedback)||(null===(r=e.value)||void 0===r?void 0:r.comment))&&async function(e,t,n,o,s,i){return await m("feedback",{method:"POST",body:JSON.stringify({model_id:e,prompt_id:t,positive_feedback:n,comment:o,input:s,output:i})}).then(async e=>{if(e.ok)return await e.json();throw p(e),console.error("Error sending feedback",e.status,e.statusText),Error(e.statusText)})}(n,s,(e=>{switch(e){case"true":return!0;case"false":return!1;default:return}})(null===(c=e.value)||void 0===c?void 0:c.positive_feedback),null===(l=e.value)||void 0===l?void 0:l.comment,i,a).then(e=>{o.Notification.info(`Qiskit Code Assistant:\n${e.message}`,{autoClose:5e3})})})}function V(e){const t=c.ReactWidget.create(_().createElement(_().Fragment,null,!!e&&_().createElement(_().Fragment,null,_().createElement("b",null,"Completion"),_().createElement("pre",null,e.trim())),_().createElement("form",null,!!e&&_().createElement("p",null,"How helpful was this completion? Â Â Â Â Â ",_().createElement("label",null,_().createElement("input",{type:"radio",name:"positive_feedback",value:"true"}),_().createElement("span",{className:"positive-feedback"},"ðŸ‘")),"Â Â Â Â Â ",_().createElement("label",null,_().createElement("input",{type:"radio",name:"positive_feedback",value:"false"}),_().createElement("span",{className:"positive-feedback"},"ðŸ‘Ž"))),_().createElement("p",null,_().createElement("label",null,_().createElement("p",null,e?"Additional feedback (Optional)":"Please share your experience with Qiskit Code Assistant"),_().createElement("textarea",{name:"comment"}))))));return t.addClass("jp-qiskit-code-assistant-feedback-form"),e?t.addClass("jp-qiskit-code-assistant-feedback-prompt"):t.addClass("jp-qiskit-code-assistant-feedback-general"),t.getValue=()=>{const e=t.node.querySelector("form"),n=new FormData(e||void 0);return{positive_feedback:n.get("positive_feedback")||void 0,comment:n.get("comment")||void 0}},t}const W="qiskit-code-assistant-jupyterlab";var G;!function(e){e.acceptInline="inline-completer:accept",e.selectCompleterNotebook="completer:select-notebook",e.selectCompleterFile="completer:select-file",e.updateApiToken="qiskit-code-assistant:set-api-token",e.selectCredential="qiskit-code-assistant:select-credential",e.clearCredential="qiskit-code-assistant:clear-credential",e.promptFeedback="qiskit-code-assistant:prompt-feedback"}(G||(G={}));const Y={id:W+":plugin",description:"AI Autocomplete JupyterLab extension for Qiskit Code Assistant",autoStart:!0,requires:[s.ICompletionProviderManager,i.INotebookTracker,o.ICommandPalette,a.ISettingRegistry,r.IStatusBar],activate:async(e,t,n,s,i,a)=>{console.debug("JupyterLab extension "+W+" is activated!");const r=await i.load(Y.id);console.debug(W+" settings loaded:",r.composite);let c=!1;g(r.composite.serviceUrl).then(e=>{c=e.is_openai,R()}),r.changed.connect(()=>g(r.composite.serviceUrl).then(e=>{c=e.is_openai,R(),x()}));const l=new K({settings:r,app:e}),d=new z({settings:r,app:e});t.registerProvider(l),t.registerInlineProvider(d),a.registerStatusItem(W+":feedback",{item:U(),align:"left",isActive:()=>!c});const u=new J;a.registerStatusItem(W+":statusbar",{item:u,align:"left"}),await async function(){try{const e=await w(),{credentials:t,selected_credential:n,using_env_var:s,never_prompt:i,has_prompted:a}=e;if(i)return console.debug('User chose "Don\'t Ask Again", skipping credential prompt'),!1;if(a)return console.debug("Already prompted in this session, skipping"),!1;if(s)return console.debug("Using QISKIT_IBM_TOKEN environment variable, skipping credential selection"),!1;if(0===t.length)return console.debug("No credentials found in qiskit-ibm.json"),!1;if(1===t.length)return console.debug("Only one credential available, auto-selecting"),!1;if(n)return console.debug(`Credential already selected: ${n}, skipping prompt`),!1;console.debug(`Found ${t.length} credentials, prompting user to select`);const r=await(0,o.showDialog)({title:"Multiple IBM Quantum Credentials Found",body:`Qiskit Code Assistant found ${t.length} IBM Quantum credentials. Would you like to choose which one to use?`,buttons:[o.Dialog.okButton({label:"Select Credential"}),o.Dialog.warnButton({label:"Enter Token Manually"}),o.Dialog.createButton({label:"Don't Ask Again"})]});return await v({has_prompted:!0}),"Select Credential"===r.button.label?(await N(!0),!0):"Enter Token Manually"===r.button.label?(await B(),!1):"Don't Ask Again"===r.button.label&&(await v({never_prompt:!0}),console.debug('User chose "Don\'t Ask Again"'),!1)}catch(e){return console.error("Error in proactive credential selection:",e),!1}}().catch(e=>(console.debug("Credential selection check skipped:",e),!1))||await x().catch(e=>{console.error("Failed initial load of models list",e)}),e.commands.addCommand(G.promptFeedback,{label:"Give feedback for the Qiskit Code Assistant",icon:Q,execute:()=>H(),isEnabled:()=>!c&&void 0!==F,isVisible:()=>{var e;return!c&&["code","markdown"].includes((null===(e=n.activeCell)||void 0===e?void 0:e.model.type)||"")&&void 0!==F}}),e.commands.addCommand(G.updateApiToken,{label:"Qiskit Code Assistant: Set IBM Quantum API token",execute:()=>B()}),e.commands.addCommand(G.selectCredential,{label:"Qiskit Code Assistant: Select credential",execute:()=>N()}),e.commands.addCommand(G.clearCredential,{label:"Qiskit Code Assistant: Clear credential selection",execute:()=>async function(){try{const e=await w(),{selected_credential:t,using_env_var:n,never_prompt:s,has_prompted:i}=e;if(n)return void await(0,o.showDialog)({title:"Environment Variable Set",body:"The QISKIT_IBM_TOKEN environment variable is currently set and takes precedence over credential selection. There is no saved credential selection to clear.",buttons:[o.Dialog.okButton({label:"OK"})]});if(!t&&!s&&!i)return void await(0,o.showDialog)({title:"Nothing to Clear",body:"There is no credential selection or preferences saved. The extension is already using default behavior.",buttons:[o.Dialog.okButton({label:"OK"})]});(await(0,o.showDialog)({title:"Reset Credential Selection",body:"This will reset your credential selection and clear all related preferences. You'll be prompted to choose a new credential immediately.\n\nAre you sure?",buttons:[o.Dialog.cancelButton({label:"Cancel"}),o.Dialog.warnButton({label:"Reset"})]})).button.accept&&(await async function(){return await m("credentials",{method:"DELETE"}).then(e=>{if(!e.ok)throw console.error("Error clearing credential selection",e.status,e.statusText),Error(e.statusText);e.json().then(e=>{o.Notification.info(`Qiskit Code Assistant:\n${e.message}`,{autoClose:3e3}),console.debug("Credential selection cleared")})})}(),await N())}catch(e){throw console.error("Error clearing credential selection:",e),e}}()}),s.addItem({command:G.updateApiToken,category:"Qiskit Code Assistant"}),s.addItem({command:G.selectCredential,category:"Qiskit Code Assistant"}),s.addItem({command:G.clearCredential,category:"Qiskit Code Assistant"}),t.selected.connect((e,t)=>{r.composite.enableTelemetry&&l.accept(t.insertText)}),e.commands.commandExecuted.connect((e,t)=>{t.id===G.acceptInline&&r.composite.enableTelemetry&&d.accept()})}},X=Y}}]);