name: release
on:
  push:
    branches:
      - "release/*"

jobs:
  testing:
    name: testing release
    runs-on: debian13-node
    if: ${{ !startsWith(github.event.head_commit.message,'release') }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Get tags
        run: git fetch --all --tags

      - name: Get version
        run: |
              BRANCH=$(git symbolic-ref --short HEAD)
              VER=${BRANCH#*release/}
              if [[ $(git tag | grep ${VER}rc) ]];then
                TAGS=$(git tag | grep ${VER}rc | awk 'END {print}')
                REL=${TAGS##*rc}
                let REL++
              else
                REL=1
              fi
              echo "BUILDVER=${VER}rc${REL}" >> $GITHUB_ENV

      - name: Update versions
        run: |
              sed -i "/^ *VERSION = /cVERSION = '${{ env.BUILDVER }}'" pawfetch/__version__.py

      - name: Making tags
        run: |
              git config user.name github-actions
              git config user.email github-actions@github.com
              git add .
              git commit -m "tagged unstable ${{ env.BUILDVER }}"
              git tag --force ${{ env.BUILDVER }}

      - name: Upload changes
        run: |
              git pull && git push && git push --tags

      - name: Install Python
        shell: bash
        run: |
              if command -v sudo >/dev/null 2>&1; then
                sudo apt-get update
                sudo apt-get install -y python3 python3-pip python3-venv python3-full jq
                sudo ln -sf /usr/bin/python3 /usr/local/bin/python
              else
                apt-get update
                apt-get install -y python3 python3-pip python3-venv python3-full jq
                ln -sf /usr/bin/python3 /usr/local/bin/python
              fi

      - name: Prepare virtualenv
        shell: bash
        run: |
              python3 -m venv .venv
              source .venv/bin/activate
              python -m pip install --upgrade pip
              python -m pip install build twine
              echo "VIRTUAL_ENV=$(pwd)/.venv" >> $GITHUB_ENV
              echo "PATH=$(pwd)/.venv/bin:$PATH" >> $GITHUB_ENV

      - name: Build distribution artifacts
        shell: bash
        run: |
              source .venv/bin/activate
              python -m build

      - name: Upload to PYPI
        shell: bash
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PIPY_API_TOKEN }}
        run: |
              source .venv/bin/activate
              twine upload dist/*

  release:
    name: formal release
    runs-on: debian13-node
    if: ${{ startsWith(github.event.head_commit.message,'release') }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Get version
        run: |
              BRANCH=$(git symbolic-ref --short HEAD)
              echo "BUILDVER=${BRANCH#*release/}" >> $GITHUB_ENV

      - name: Update package.json
        uses: https://github.com/jossef/action-set-json-field@v2
        with:
          file: package.json
          field: version
          value: ${{ env.BUILDVER }}

      - name: Update neofetch version
        run: |
              REVISION=$(expr $(git rev-list --count HEAD neofetch) - 2902)
              sed -i "/^ *version=/cversion=7.4.0r${REVISION}" neofetch

      - name: Update other versions
        run: |
              sed -i "/^ *VERSION = /cVERSION = '${{ env.BUILDVER }}'" pawfetch/__version__.py
              sed -i "/^ *### Unpublished/c### ${{ env.BUILDVER }}" README.md

      - name: Make final tags
        run: |
              git config user.name github-actions
              git config user.email github-actions@github.com
              git add . && git commit -m "tagged stable ${{ env.BUILDVER }}"
              git tag --force ${{ env.BUILDVER }}

      - name: Merge branch and push
        run: |
              parent=$(git remote show origin | sed -n '/HEAD branch/s/.*: //p')
              git fetch origin "${parent}"
              git checkout "${parent}"
              git merge --no-edit "release/${{ env.BUILDVER }}"
              git push origin "${parent}"
              git push origin --tags

      - name: Generate changelog from README
        run: (sed '0,/^ *### ${{ env.BUILDVER }}/d;/^ *#/,$d' <README.md)>temp_CHANGELOG.md

      - name: Publish release
        uses: https://github.com/ncipollo/release-action@v1
        with:
          bodyFile: "temp_CHANGELOG.md"
          tag: ${{ env.BUILDVER }}
          token: ${{ secrets.GH_TOKEN }}
