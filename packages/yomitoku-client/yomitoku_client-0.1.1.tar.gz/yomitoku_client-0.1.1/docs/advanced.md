# Advanced

## API Reference

SageMaker ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰å–å¾—ã§ãã‚‹ API ã‚¹ã‚­ãƒ¼ãƒã¯ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚ˆã‚Šç¢ºèªã§ãã¾ã™ã€‚

* [YomiToku-Pro Document Analyzer API Schema (v1.3.2)](https://mlism-marketplace-documents.s3.ap-northeast-1.amazonaws.com/yomitoku-pro-document-analyzer-v1-3-2.html)

---

## è©³ç´°è¨­å®š
### ä¸¦åˆ—å‡¦ç†
YomitokuClientã§ã¯ã€è¤‡æ•°ãƒšãƒ¼ã‚¸ã§æ§‹æˆã•ã‚Œã‚‹PDFãªã©ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒšãƒ¼ã‚¸å˜ä½ã§åˆ†å‰²ã—ã€Endpointã«ä¸¦åˆ—ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã„ã¾ã™ã€‚ä¸¦åˆ—å‡¦ç†ã®ãƒ¯ãƒ¼ã‚«ãƒ¼ã®æ•°ã®è¨­å®šãŒå¯èƒ½ã§ã™ã€‚

```bash
yomitoku-client batch -i ./input -o ./output -e my-endpoint --workers 8
```

### ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ / ãƒªãƒˆãƒ©ã‚¤å‡¦ç†

YomitokuClient ã§ã¯ã€Boto3 ãƒ¬ã‚¤ãƒ¤ãŠã‚ˆã³ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ¬ã‚¤ãƒ¤ã®åŒæ–¹ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¶å¾¡ã‚’è¡Œã„ã¾ã™ã€‚
å„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ„å‘³ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å              | å‹       | æ—¢å®šå€¤    | å¯¾è±¡ç¯„å›²     | èª¬æ˜                                  |
| ------------------- | ------- | ------ | -------- | ----------------------------------- |
| `--connect_timeout` | `int`   | `10` ç§’ | å„ãƒªã‚¯ã‚¨ã‚¹ãƒˆå˜ä½ | SageMaker Endpoint ã¸ã®æ¥ç¶šç¢ºç«‹ã¾ã§ã®æœ€å¤§å¾…æ©Ÿæ™‚é–“ã€‚ |
| `--read_timeout`    | `int`   | `60` ç§’ | å„ãƒªã‚¯ã‚¨ã‚¹ãƒˆå˜ä½ | æ¥ç¶šç¢ºç«‹å¾Œã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡ã¾ã§ã®æœ€å¤§å¾…æ©Ÿæ™‚é–“ã€‚æ¨è«–é…å»¶æ™‚ã«é©ç”¨ã€‚    |
| `--max_retries`     | `int`   | `3` å›  | å„ãƒªã‚¯ã‚¨ã‚¹ãƒˆå˜ä½ | boto3 ã®å†è©¦è¡Œå›æ•°ã®ä¸Šé™ã€‚é€šä¿¡ã‚¨ãƒ©ãƒ¼ã‚„ 5xx å¿œç­”æ™‚ã«å†è©¦è¡Œã€‚ |
| `--request_timeout` | `float` | ä»»æ„è¨­å®š   | ãƒšãƒ¼ã‚¸å˜ä½    | 1 ãƒšãƒ¼ã‚¸ï¼ˆã¾ãŸã¯ 1 ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã®å‡¦ç†ä¸Šé™æ™‚é–“ã€‚           |
| `--total_timeout`   | `float` | ä»»æ„è¨­å®š   | ãƒãƒƒãƒå…¨ä½“    | å…¨ãƒšãƒ¼ã‚¸åˆè¨ˆã®å‡¦ç†ä¸Šé™æ™‚é–“ã€‚è¶…éæ™‚ã¯æœªå®Œäº†ã‚¿ã‚¹ã‚¯ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€‚    |

**ä½¿ç”¨ä¾‹**
```bash
yomitoku-client batch \
  -i ./input -o ./output -e my-endpoint \
  --connect_timeout 5 \
  --read_timeout 120 \
  --max_retries 5 \
  --request_timeout 150 \
  --total_timeout 300
```

---

### ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼

ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ã¯ã€é€£ç¶šã—ã¦è§£æã«å¤±æ•—ã—ãŸå ´åˆã«ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä¿è­·ã™ã‚‹ãŸã‚ã®ä»•çµ„ã¿ã§ã™ã€‚
ã“ã‚ŒãŒå­˜åœ¨ã—ãªã„å ´åˆã€è¤‡æ•°ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒç„¡åˆ¶é™ã«ãƒªãƒˆãƒ©ã‚¤ã‚’è¡Œã„ã€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®è² è·ãŒéå¤§ã«ãªã‚‹æã‚ŒãŒã‚ã‚Šã¾ã™ã€‚

YomitokuClient ã¯ã“ã®ãƒªã‚¹ã‚¯ã‚’é˜²ããŸã‚ã€**é€£ç¶šå¤±æ•—æ™‚ã«ä¸€æ™‚çš„ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åœæ­¢**ã—ã€ä¸€å®šæ™‚é–“å¾Œã«å†è©¦è¡Œã‚’è¡Œã†è¨­è¨ˆã¨ãªã£ã¦ã„ã¾ã™ã€‚

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å                | å‹     | æ—¢å®šå€¤    | èª¬æ˜                           |
| --------------------- | ----- | ------ | ---------------------------- |
| `--threthold_circuit` | `int` | `5`    | é€£ç¶šå¤±æ•—ã®ã—ãã„å€¤ã€‚ã“ã‚Œã‚’è¶…ãˆã‚‹ã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä¸€æ™‚åœæ­¢ã€‚ |
| `--cooldown_time`     | `int` | `30` ç§’ | ã‚µãƒ¼ã‚­ãƒƒãƒˆãŒé–‹ã„ãŸå¾Œã«å†è©¦è¡Œã‚’è¨±å¯ã™ã‚‹ã¾ã§ã®å¾…æ©Ÿæ™‚é–“ã€‚  |

**ä½¿ç”¨ä¾‹**
```bash
yomitoku-client batch \
  -i ./input -o ./output -e my-endpoint \
  --threthold_circuit 3 \
  --cooldown_time 60
```

> ğŸ”’ é€£ç¶šå¤±æ•—ãŒ 3 å›ç™ºç”Ÿã—ãŸå ´åˆã€60 ç§’é–“ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒåœæ­¢ã—ã¾ã™ã€‚
> ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³çµŒéå¾Œã«è‡ªå‹•çš„ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å†é–‹ã—ã¾ã™ã€‚

---

### ä¸Šæ›¸ãåˆ¶å¾¡
YomiToku-Clientã®ãƒãƒƒãƒå‡¦ç†ã¯éå»ã®ãƒ­ã‚°æƒ…å ±(`${OUTPUT_DIR}/process_log.jsonl`)ã‚’å‚ç…§ã—ã€å‡¦ç†ã«å¤±æ•—ã—ãŸãƒ‡ãƒ¼ã‚¿ã®ã¿å†æ¨è«–ãŒå¯èƒ½ã§ã™ã€‚é€šå¸¸ã¯`overwrite=False`ã®ã¨ãã¯ã‚¨ãƒ©ãƒ¼ã®ç™ºç”Ÿãªã©ã«ã‚ˆã‚Šã€æ¨è«–ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãªã„ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’å¯¾è±¡ã¨ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¾ã™ã€‚`overwrite=True`ã®ã¨ãã¯ã€ãƒ•ã‚©ãƒ«ãƒ€å†…ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å¯¾è±¡ã«å†ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã„ã¾ã™ã€‚

`--overwrite`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€å‡¦ç†ã®å®Ÿæ–½/æœªå®Ÿæ–½ã«é–¢ã‚ã‚‰ãšãƒ•ã‚©ãƒ«ãƒ€å†…ã®å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¾ã™ã€‚
```bash
yomitoku-client batch -i ./input -o ./output -e my-endpoint --overwrite
```

| ã‚ªãƒ—ã‚·ãƒ§ãƒ³         | å‹        | èª¬æ˜                            |
| ------------- | -------- | ----------------------------- |
| `--overwrite` | *(flag)* | True ã®å ´åˆã€æ—¢å­˜ã®å‡ºåŠ›ã«é–¢ä¿‚ãªãå…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†å‡¦ç†ã€‚ |

---

## ğŸ” ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³

```mermaid
sequenceDiagram
    participant Client as YomitokuClient
    participant Boto3 as boto3 (AWS SDK)
    participant AWS as SageMaker Endpoint

    %% --- å…¨ä½“æ§‹é€  ---
    Note over Client,AWS: å…¨ä½“ã®åˆ¶å¾¡æ§‹é€ ï¼ˆtotal_timeoutï¼‰å†…ã§<br>è¤‡æ•°ãƒšãƒ¼ã‚¸ãƒ»è¤‡æ•°ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä¸¦è¡Œå®Ÿè¡Œã•ã‚Œã‚‹

    Client->>Timer: total_timeout é–‹å§‹
    activate Timer

    %% --- å„ãƒšãƒ¼ã‚¸å‡¦ç†ãƒ«ãƒ¼ãƒ— ---
    loop å„ãƒšãƒ¼ã‚¸è§£æ (request_timeout)
        %% --- æ¥ç¶šãƒ•ã‚§ãƒ¼ã‚º ---
        Client->>Boto3: ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
        Boto3->>AWS: HTTPS Request (connect_timeout)
        Note right of AWS: æ¥ç¶šç¢ºç«‹ã¾ã§ã®å¾…æ©Ÿ = connect_timeout
        AWS-->>Boto3: Connection established or timeout

        alt æ¥ç¶šå¤±æ•— (connect_timeout)
            Boto3-->>AWS: ãƒªãƒˆãƒ©ã‚¤ã¾ãŸã¯ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ç™ºå‹•
        else æ¥ç¶šæˆåŠŸ
            Boto3->>AWS: ãƒ‡ãƒ¼ã‚¿é€ä¿¡ & æ¨è«–å¾…æ©Ÿ (read_timeout)
            Note right of AWS: æ¨è«–å¿œç­”å¾…æ©Ÿ = read_timeout
            AWS-->>Boto3: Response or read timeout
            alt read_timeout ç™ºç”Ÿ
                Boto3-->>AWS: ãƒªãƒˆãƒ©ã‚¤ã¾ãŸã¯ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ç™ºå‹•
            else å¿œç­”æˆåŠŸ
                Boto3-->>Client: ãƒšãƒ¼ã‚¸è§£æçµæœã‚’è¿”å´
            end
        end
    end

    %% --- å…¨ä½“ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ ---
    Timer-->>Client: total_timeout è¶…éã§å…¨ä½“åœæ­¢
    deactivate Timer

    %% --- çµ‚äº†å‡¦ç† ---
    Client-->>Client: ãƒšãƒ¼ã‚¸å˜ä½ã®çµæœã‚’çµ±åˆã—ã¦å‡ºåŠ›
```

## ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®šä¾‹(Python API)

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãŠã‚ˆã³ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼è¨­å®šã‚’å«ã‚€
YomitokuClient ã®ä½¿ç”¨ä¾‹ã§ã™ã€‚

```python
from yomitoku_client.client import RequestConfig, CircuitConfig, YomitokuClient

request_config = RequestConfig(
    read_timeout=120,     # å¿œç­”å¾…æ©Ÿã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ [ç§’]
    connect_timeout=5,    # æ¥ç¶šç¢ºç«‹ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ [ç§’]
    max_retries=5,       # boto3 ã®ãƒªãƒˆãƒ©ã‚¤å›æ•°
)

circuit_config = CircuitConfig(
    threshold=3,          # é€£ç¶šå¤±æ•—ã®ã—ãã„å€¤
    cooldown_time=60,      # ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ç™ºå‹•å¾Œã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ [ç§’]
)

async with YomitokuClient(
    endpoint=ENDPOINT_NAME,
    region=AWS_REGION,
    request_config=request_config,
    circuit_config=circuit_config,
    max_workers=5,        # ä¸¦åˆ—ãƒ¯ãƒ¼ã‚«ãƒ¼æ•°
) as client:
    await client.analyze_batch_async(
        input_dir="./input",
        output_dir="./output",
        request_timeout=150,   # ãƒšãƒ¼ã‚¸å˜ä½ã®è§£æä¸Šé™æ™‚é–“ [ç§’]
        total_timeout=300,     # å…¨ä½“è§£æä¸Šé™æ™‚é–“ [ç§’]
        overwrite=False,       # æœªå‡¦ç†ãƒ‡ãƒ¼ã‚¿ã®ã¿å¯¾è±¡
    )

```