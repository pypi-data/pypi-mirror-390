name: CI

permissions:
  contents: read
  pull-requests: read
  actions: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 6 * * 1'  # weekly audit

jobs:
  detect-changes:
    uses: enterprise-assistant-platform/.github/.github/workflows/python-detect-changes.yml@main

  quality-checks:
    needs: detect-changes
    if: needs.detect-changes.outputs.code == 'true'
    uses: enterprise-assistant-platform/.github/.github/workflows/python-quality.yml@main
    with:
      python-version: '3.12'
      uv-version: '0.8.0'

  tests:
    needs: [detect-changes, quality-checks]
    if: needs.detect-changes.outputs.code == 'true'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        test-type: ["unit"]
        python-version: ["3.12"]
    uses: enterprise-assistant-platform/.github/.github/workflows/python-tests.yml@main
    with:
      uv-version:     '0.8.0'
      python-version: ${{ matrix.python-version }}
      os:             ${{ matrix.os }}
      test-type:      ${{ matrix.test-type }}
      coverage-pkg:   'src/eap_sdk'

  tests-full:
    needs: [detect-changes, quality-checks]
    if: >
      needs.detect-changes.outputs.code == 'true' &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main'
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        test-type: ['unit', 'integration']
        python-version: ['3.10', '3.11', '3.12', '3.13']
    uses: enterprise-assistant-platform/.github/.github/workflows/python-tests.yml@main
    with:
      uv-version:     '0.8.0'
      python-version: ${{ matrix.python-version }}
      os:             ${{ matrix.os }}
      test-type:      ${{ matrix.test-type }}
      coverage-pkg:   'src/eap_sdk'

  security-audit:
    needs: detect-changes
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'push' &&
       (needs.detect-changes.outputs.code == 'true' || needs.detect-changes.outputs.ci == 'true'))
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']
    uses: enterprise-assistant-platform/.github/.github/workflows/python-security-audit.yml@main
    with:
      uv-version: '0.8.0'
      python:     ${{ matrix.python-version }}

  pypy-tests:
    needs: tests
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        test-type: ["unit"]
        python-version: ["pypy3.9", "pypy3.10"]
    uses: enterprise-assistant-platform/.github/.github/workflows/python-tests.yml@main
    with:
      uv-version:     '0.8.0'
      python-version: ${{ matrix.python-version }}
      os:             ${{ matrix.os }}
      test-type:      ${{ matrix.test-type }}
      coverage-pkg:   'src/eap_sdk'

  performance-benchmark:
    needs: tests
    if: github.ref == 'refs/heads/main'
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']
    uses: enterprise-assistant-platform/.github/.github/workflows/python-bench.yml@main
    with:
      uv-version:     '0.8.0'
      python-version: ${{ matrix.python-version }}
