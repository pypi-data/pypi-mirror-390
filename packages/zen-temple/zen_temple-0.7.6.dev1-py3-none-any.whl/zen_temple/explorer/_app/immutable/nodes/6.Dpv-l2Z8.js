import"../chunks/DsnmJJEf.js";import{o as nt,s as xe}from"../chunks/Dv-zU6kM.js";import{q as kt,p as Pt,u as Ye,h as e,e as E,j as yt,g as be,i as y,m as ge,l as xt,f as V,be as ft,bf as wt,a as ue,s as k,d as D,r as C,b as O,t as we,n as He,bg as _t,c as At,k as Xt,aN as Ut}from"../chunks/wiODf3u9.js";import{i as ve}from"../chunks/BanhNaiI.js";import{p as Wt,b as Ft}from"../chunks/CdVljubK.js";import{E as _e}from"../chunks/Dmw0JB4Z.js";import{C as bt,H as zt,D as Gt,n as Ge,j as $t,r as Vt,B as Et,F as dt,S as qt,b as Zt,t as Kt,e as Jt}from"../chunks/CrYm4EAs.js";import{e as Qe,i as et,u as Qt,g as er,b as Ct}from"../chunks/CuRYjgcn.js";import{u as Nt}from"../chunks/DFszdP0_.js";import{M as Tt}from"../chunks/BpW8IzjD.js";import{s as oe,c as St,a as Ot}from"../chunks/CcFbe3Gs.js";import{s as Bt}from"../chunks/D_sdVLPA.js";import{d as tr,n as rr,s as Fe,a as Rt,b as ar,c as gt,e as vt,y as or,p as mt,i as ht,f as nr,T as sr}from"../chunks/wXGIymCH.js";import{d as lr}from"../chunks/CgsLtv0Y.js";const Ae=140,tt=16,ir=50,ur=200,Ht=140,cr=32,Pe=5,rt=20,Dt=10,It=2,We=16,fr=40;let ee=[],je=[],ze=!1;function Ve(a,l){return a.reduce((t,d)=>t+l(d),0)}function dr(){ee.forEach(a=>{a.linksOut=je.filter(l=>l.source===a),a.linksIn=je.filter(l=>l.target===a)})}function gr(){ee.forEach(a=>{a.value=ze?1:Math.max(Ve(a.linksIn,l=>l.value),Ve(a.linksOut,l=>l.value))})}function vr(){ee=ee.filter(a=>a.linksIn.length>0||a.linksOut.length>0)}function hr(){let a=0,l=[];je.forEach(t=>{Yt(t.source,t.target,l)?(t.causesCycle=!0,t.cycleIndex=++a):(t.causesCycle=!1,l.push(t))})}function Yt(a,l,t){let d=t.filter(s=>s.source===l);return t.length==0||d.length==0?!1:d.some(s=>s.target===a||Yt(a,s.target,t))}function yr(){let a=ee,l=[],t=0;for(;a.length;)l=[],a.forEach(d=>{d.x=t,d.linksOut.forEach(s=>{s.causesCycle||l.push(s.target)})}),a=l,t++;for(a=ee;a.length;)l=[],a.forEach(d=>{if(d.linksOut.length>0&&d.stickTo===null){const s=d.linksOut.filter(f=>!f.causesCycle).map(f=>f.target.x);s.length>0&&(d.x=Math.max(d.x,Math.min(...s)-1))}d.linksIn.forEach(s=>{s.causesCycle||l.push(s.source)})}),a=l;ee.forEach(d=>{d.stickTo==="right"&&(d.x=t-1)}),mr(Ht+Ae)}function mr(a){ee.forEach(l=>{l.x*=a})}function pr(){let a={};return ee.forEach(l=>{const t=l.x;a[t]||(a[t]=[]),a[t].push(l)}),Object.values(a).sort((l,t)=>l[0].x-t[0].x)}function at(a){return a.y+a.dy/2}function _r(){let a=pr();l(),f();for(let m=1,p=0;p<cr;++p,m*=.95)s(m),f(),d(m),f();function l(){const m=ze?fr:ur,p=Math.min(...ee.map(u=>u.value>1e-6?m/u.value:1/0));let x=0;ee.filter(u=>u.distinctRow).sort((u,w)=>u.x-w.x).forEach(u=>{u.y=x,u.dy=u.value*p,x+=u.dy+ir}),a.forEach(u=>{let w=0;u.filter(N=>!N.distinctRow).forEach(N=>{N.y=w,N.dy=N.value*p,w+=N.dy+tt})}),je.forEach(u=>{u.dy=ze?6:u.value*p})}function t(m){return ze?1:Math.max(m.value,1e-6)}function d(m){a.forEach(p=>{p.forEach(x=>{if(x.linksIn.length===0||x.distinctRow)return;const u=x.linksIn,w=Ve(u,N=>at(N.source)*t(N))/Ve(u,N=>t(N));x.y+=(w-at(x))*m})})}function s(m){a.slice().reverse().forEach(p=>{p.forEach(x=>{if(x.linksOut.length===0||x.distinctRow)return;const u=x.linksOut,w=Ve(u,N=>at(N.target)*t(N))/Ve(u,N=>t(N));x.y+=(w-at(x))*m})})}function f(){a.forEach(m=>{let p=m[0],x,u=0,w=m.length,N;for(m.sort((X,Ne)=>X.y-Ne.y),N=0;N<w;++N)p=m[N],x=u-p.y,p.distinctRow?x>0?(m[N-1].y=p.y+p.dy+tt,u=m[N-1].y+m[N-1].dy+tt):u=p.y+p.dy+tt:(x>0&&(p.y+=x),u=p.y+p.dy+tt)})}}function jt(){let a=(t,d)=>(s,f)=>{const m=d?1:-1;return s.causesCycle&&f.causesCycle?m*(s.cycleIndex-f.cycleIndex):s.causesCycle?-m:f.causesCycle?m:s[t].y-f[t].y},l=Math.max(...ee.map(t=>t.y+t.dy));ee.forEach(t=>{t.linksIn.sort(a("source",t.y<l/2)),t.linksOut.sort(a("target",t.y<l/2))}),ee.forEach(t=>{let d=0,s=0;t.linksOut.forEach(f=>{ze?f.sy=(t.dy-f.dy)/2:(f.sy=d,d+=f.dy)}),t.linksIn.forEach(f=>{ze?f.ty=(t.dy-f.dy)/2:(f.ty=s,s+=f.dy)})})}function xr(a,l,t){ee=a,je=l,ze=t,dr(),gr(),vr(),hr(),yr(),_r(),jt()}function wr(a,l){a<0||a>=ee.length||(ee[a].y=l,jt())}function Lt(){const a=ee.map(t=>({label:t.label,color:t.color,value:t.value,unit:t.unit,unitSuffix:t.unitSuffix,showTotal:t.showTotal,x:t.x,y:t.y,dy:t.dy,linksIn:je.map((d,s)=>d.target===t?s:-1).filter(d=>d>=0),linksOut:je.map((d,s)=>d.source===t?s:-1).filter(d=>d>=0)})),l=je.map(t=>({source:a[ee.indexOf(t.source)],target:a[ee.indexOf(t.target)],value:t.value,color:t.color,unit:t.unit,causesCycle:t.causesCycle,cycleIndex:t.cycleIndex,dy:t.dy,sy:t.sy,ty:t.ty}));return[a,l]}const ot=a=>()=>a;function pt(a,{sourceEvent:l,subject:t,target:d,identifier:s,active:f,x:m,y:p,dx:x,dy:u,dispatch:w}){Object.defineProperties(this,{type:{value:a,enumerable:!0,configurable:!0},sourceEvent:{value:l,enumerable:!0,configurable:!0},subject:{value:t,enumerable:!0,configurable:!0},target:{value:d,enumerable:!0,configurable:!0},identifier:{value:s,enumerable:!0,configurable:!0},active:{value:f,enumerable:!0,configurable:!0},x:{value:m,enumerable:!0,configurable:!0},y:{value:p,enumerable:!0,configurable:!0},dx:{value:x,enumerable:!0,configurable:!0},dy:{value:u,enumerable:!0,configurable:!0},_:{value:w}})}pt.prototype.on=function(){var a=this._.on.apply(this._,arguments);return a===this._?this:a};function br(a){return!a.ctrlKey&&!a.button}function $r(){return this.parentNode}function Er(a,l){return l??{x:a.x,y:a.y}}function Cr(){return navigator.maxTouchPoints||"ontouchstart"in this}function Nr(){var a=br,l=$r,t=Er,d=Cr,s={},f=tr("start","drag","end"),m=0,p,x,u,w,N=0;function X(n){n.on("mousedown.drag",Ne).filter(d).on("touchstart.drag",Se).on("touchmove.drag",Oe,rr).on("touchend.drag touchcancel.drag",$e).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function Ne(n,P){if(!(w||!a.call(this,n,P))){var A=De(this,l.call(this,n,P),n,P,"mouse");A&&(Fe(n.view).on("mousemove.drag",Re,Rt).on("mouseup.drag",Te,Rt),ar(n.view),gt(n),u=!1,p=n.clientX,x=n.clientY,A("start",n))}}function Re(n){if(vt(n),!u){var P=n.clientX-p,A=n.clientY-x;u=P*P+A*A>N}s.mouse("drag",n)}function Te(n){Fe(n.view).on("mousemove.drag mouseup.drag",null),or(n.view,u),vt(n),s.mouse("end",n)}function Se(n,P){if(a.call(this,n,P)){var A=n.changedTouches,U=l.call(this,n,P),te=A.length,ce,Ee;for(ce=0;ce<te;++ce)(Ee=De(this,U,n,P,A[ce].identifier,A[ce]))&&(gt(n),Ee("start",n,A[ce]))}}function Oe(n){var P=n.changedTouches,A=P.length,U,te;for(U=0;U<A;++U)(te=s[P[U].identifier])&&(vt(n),te("drag",n,P[U]))}function $e(n){var P=n.changedTouches,A=P.length,U,te;for(w&&clearTimeout(w),w=setTimeout(function(){w=null},500),U=0;U<A;++U)(te=s[P[U].identifier])&&(gt(n),te("end",n,P[U]))}function De(n,P,A,U,te,ce){var Ee=f.copy(),re=mt(ce||A,P),Ie,q,he;if((he=t.call(n,new pt("beforestart",{sourceEvent:A,target:X,identifier:te,active:m,x:re[0],y:re[1],dx:0,dy:0,dispatch:Ee}),U))!=null)return Ie=he.x-re[0]||0,q=he.y-re[1]||0,function W(Z,Le,qe){var ne=re,fe;switch(Z){case"start":s[te]=W,fe=m++;break;case"end":delete s[te],--m;case"drag":re=mt(qe||Le,P),fe=m;break}Ee.call(Z,n,new pt(Z,{sourceEvent:Le,subject:he,target:X,identifier:te,active:fe,x:re[0]+Ie,y:re[1]+q,dx:re[0]-ne[0],dy:re[1]-ne[1],dispatch:Ee}),U)}}return X.filter=function(n){return arguments.length?(a=typeof n=="function"?n:ot(!!n),X):a},X.container=function(n){return arguments.length?(l=typeof n=="function"?n:ot(n),X):l},X.subject=function(n){return arguments.length?(t=typeof n=="function"?n:ot(n),X):t},X.touchable=function(n){return arguments.length?(d=typeof n=="function"?n:ot(!!n),X):d},X.on=function(){var n=f.on.apply(f,arguments);return n===f?X:n},X.clickDistance=function(n){return arguments.length?(N=(n=+n)*n,X):Math.sqrt(N)},X}function Mt(a,l){let t=0;for(let d of a)(d=+d)&&(t+=d);return t}var Tr=(a,l,t)=>l(e(t).carrier),Sr=V('<button class="flex items-center p-0 text-gray-600 dark:text-gray-400 text-sm"><svg width="40" height="12" class="me-1 svelte-l7ef6a"><rect width="40" height="12"></rect></svg> <span> </span></button>'),Or=V('<div class="flex flex-wrap gap-2"></div>'),Br=V('<h2 class="flex items-start font-bold text-lg me-4"><span class="me-2">Legend</span> <!></h2> <!>',1),Rr=_t('<path class="cycle-link svelte-l7ef6a"><title> </title></path>'),Dr=_t('<path class="link svelte-l7ef6a"><title> </title></path>'),Ir=_t('<g class="node svelte-l7ef6a"><rect class="svelte-l7ef6a"></rect><text text-anchor="middle"> </text></g>'),Lr=V('<div class="flex justify-between text-xs px-2 text-nowrap"><div class="flex items-center me-1"><svg class="me-1 svelte-l7ef6a" width="12" height="12"><rect width="12" height="12"></rect></svg> <span> </span></div> <div> </div></div>'),Mr=V('<div class="flex justify-between text-xs px-2 pt-1 text-nowrap"><strong>Total:</strong> <div> </div></div>'),Pr=V('<div><div class="font-bold text-xs px-2">Inflows:</div> <!> <!></div>'),Ar=V('<div class="flex justify-between text-xs px-2 text-nowrap"><div class="flex items-center me-1"><svg class="me-1 svelte-l7ef6a" width="12" height="12"><rect width="12" height="12"></rect></svg> <span> </span></div> <div> </div></div>'),Fr=V('<div class="flex justify-between text-xs px-2 pt-1 text-nowrap"><strong>Total:</strong> <div> </div></div>'),Hr=V('<div class="font-bold mt-1 text-sm px-2">Outflows:</div> <!> <!>',1),Yr=V('<div class="font-bold text-sm px-2"> </div> <!> <!>',1),jr=V('<div class="relative"><svg class="max-w-full svelte-l7ef6a"><g><g class="links"></g><g class="nodes"></g></g></svg> <!></div>'),kr=V("<!> <!>",1);function Xr(a,l){Pt(l,!0);let t=E(936),d=800,s=E(void 0),f=Wt(l,"id",3,"diagram"),m=lr(X,100);Ye(()=>{e(g),l.nodes.length&&yt(()=>{N(l.nodes,l.links),m()})});let p=[],x=[],u=E(be([])),w=E(be([]));function N(r,i){p=r.map(c=>({label:c.label??"Unnamed",color:c.color??"#ccc",id:c.id??"",value:0,unit:c.unit??"",unitSuffix:c.unitSuffix??!1,stickTo:c.stickTo??null,showTotal:c.showTotal??!0,distinctRow:c.distinctRow??!1,linksIn:[],linksOut:[],x:0,y:0,dy:0})),x=i.flatMap(c=>{if(!e(g)&&c.value<1e-6)return[];let h=p.find($=>$.id===c.source.id&&$.label===c.source.label),v=p.find($=>$.id===c.target.id&&$.label===c.target.label);return!h||!v?(console.warn("Link refers to unknown node",c),[]):[{source:h,target:v,value:c.value,color:c.color,unit:c.unit,causesCycle:!1,cycleIndex:0,dy:0,sy:0,ty:0}]})}function X(){xr(p,x,e(g)),(r=>{var i=xt(r,2);y(u,i[0],!0),y(w,i[1],!0)})(Lt())}function Ne(r,i){return c=>r*(1-c)+i*c}function Re(r){if(r.causesCycle){let Y=Pe,z=r.source.x+Ae,J=r.source.y+r.sy+r.dy,_=r.target.x,T=r.target.y,L=z+rt,H=J,S=L,I=-Dt-r.cycleIndex*(Y+It),R=_-rt,G=R,se=T+r.ty+r.dy,o=H-r.dy,b=se-r.dy,M=We/2-Pe;return r.target.y>e($e)/2&&(I=e($e)-I,H=r.source.y+r.sy,se=r.target.y+r.ty,o=H+r.dy,b=se+r.dy,Y=-Pe),`M${z},${H}L${L},${H}C${L+We},${H} ${S+We},${I} ${S},${I}H${R-Pe}C${R-We},${I} ${G-We},${se} ${G},${se}H${_}V${b}H${G}C${G-M},${b} ${R-M},${I+Y} ${R},${I+Y}H${S-Pe}C${S+M},${I+Y} ${L+M},${H-r.dy} ${L},${o}L${z},${o}`}const i=r.source.x+Ae,c=r.target.x,v=Ne(i,c)(.5),$=r.source.y+r.sy+r.dy/2,B=r.target.y+r.ty+r.dy/2;return`M${i},${$} C${v},${$} ${v},${B} ${c},${B}`}let Te=ge(()=>{if(!e(w).length)return 0;const r=Math.max(...e(w).map(i=>i.cycleIndex));return r==0?0:Dt+r*(Pe+It)}),Se=ge(()=>e(u).length&&e(u).some(r=>r.x===0&&r.linksIn.length>0)?-rt-Pe-We:0),Oe=ge(()=>{if(!e(u).length)return e(t);const r=Math.max(...e(u).map(i=>i.x+Ae));return e(u).some(i=>i.x===r&&i.linksOut.length>0)?r+rt+Pe+We-e(Se):r-e(Se)}),$e=ge(()=>e(u).length?Math.max(...e(u).map(r=>r.y+r.dy)):d);function De(r){let i,c,h,v=/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/;const $=r.match(v);if($)i=parseInt($[1],10),c=parseInt($[2],10),h=parseInt($[3],10);else return!1;return .299*i+.587*c+.114*h<85}function n(){if(!e(s))return;const{width:r}=e(s).parentElement.getBoundingClientRect();y(t,r,!0),m()}nt(n);let P=E(be(ht.toString())),A=nr().scaleExtent([1,1/0]).on("zoom",r=>{y(P,r.transform.toString(),!0),Le()}).on("end",()=>{Le()});Ye(()=>{A=A.translateExtent([[e(Se)-5,-e(Te)-5],[e(Oe)+5,e($e)+e(Te)+5]])}),nt(()=>{e(s)&&Fe(e(s)).call(A)});function U(){e(s)&&Fe(e(s)).call(A.transform,ht)}function te(r){const i=e(u).find(Y=>Y.label===r);if(!i||!e(s))return;const c=3*Ae+2*Ht+8,h=e(Oe)/c,v=-(i.x+Ae/2)*h+e(Oe)/2,$=-(i.y+i.dy/2)*h+e($e)/2,B=Fe(e(s));A.transform(B,ht.translate(v,$).scale(h))}let ce=Nr().on("start",function(){this.parentNode&&this.parentNode.appendChild(this)}).on("drag",function(r){const i=Number(this.dataset.idx);isNaN(i)||(Ee(r,i),Ie(r))});Ye(()=>{e(u),e(s)&&Fe(e(s)).selectAll(".node").call(ce)});function Ee(r,i){if(r.clientY===0||i<0||i>=e(u).length)return;const c=e(u)[i].y+r.dy,h=Math.max(0,c);wr(i,h),(v=>{var $=xt(v,2);y(u,$[0],!0),y(w,$[1],!0)})(Lt())}let re=E(null);function Ie(r){e(s)&&y(re,mt(r,e(s).parentElement),!0)}let q=E(null);function he(){e(s)&&y(q,e(s).getBoundingClientRect(),!0)}nt(he);let W=ge(()=>{if(!e(re)||!e(s))return null;let[r,i]=e(re),c=e(s).getBoundingClientRect(),h=Fe(e(s)).selectAll(".node").nodes().findLast($=>{let B=$.getBoundingClientRect(),Y=B.left-c.left,z=B.top-c.top;return r>=Y&&r<=Y+B.width&&i>=z&&i<=z+B.height});if(!h)return null;let v=Number(h.dataset.idx);return isNaN(v)||v<0||v>=e(u).length?null:e(u)[v]}),Z=E(null);function Le(){if(e(W)===null||!e(s))return;const r=e(u).findIndex(c=>c===e(W));if(r===-1)return;const i=Fe(e(s)).selectAll(`.node[data-idx="${r}"]`).nodes()[0];i&&y(Z,i.getBoundingClientRect(),!0)}Ye(Le);let qe=ge(()=>e(Z)===null||e(q)===null?0:e(Z).left-e(q).left+e(Z).width/2),ne=ge(()=>e(Z)===null||e(q)===null?0:e(Z).top-e(q).top+e(Z).height/2),fe=ge(()=>e(Z)===null?0:e(Z).height/2),st=ge(()=>e(Z)===null||e(q)===null?!1:e(Z).top-e(q).top>d/2);function Ze(r){return`${r.source.label} â†’ ${r.target.label}:
${r.value.toFixed(3)} ${r.unit}`}let g=E(!1);function ye(){return e(g)}function Me(){y(g,!e(g))}var pe={resetZoom:U,getShowStructureOnly:ye,toggleShowStructureOnly:Me},F=kr();ft("resize",wt,n),ft("scroll",wt,he);var ie=ue(F);bt(ie,{class:"flex",children:(r,i)=>{var c=Br(),h=ue(c),v=k(D(h),2);zt(v,{content:"Click on legend items to focus on into in the diagram."}),C(h);var $=k(h,2);{var B=Y=>{var z=Or();Qe(z,21,()=>l.legendItems,et,(J,_)=>{var T=Sr();T.__click=[Tr,te,_];var L=D(T),H=D(L);C(L);var S=k(L,2),I=D(S,!0);C(S),C(T),we(()=>{oe(H,"fill",e(_).color),xe(I,e(_).carrier)}),O(J,T)}),C(z),O(Y,z)};ve($,Y=>{l.legendItems&&l.legendItems.length>0&&Y(B)})}O(r,c)},$$slots:{default:!0}});var K=k(ie,2);return bt(K,{noPadding:!0,children:(r,i)=>{var c=jr(),h=D(c);oe(h,"height",d),h.__mousemove=Ie;var v=D(h),$=D(v);Qe($,21,()=>e(w).toSorted((J,_)=>_.value-J.value),et,(J,_)=>{var T=He(),L=ue(T);{var H=I=>{var R=Rr();let G;var se=D(R),o=D(se,!0);C(se),C(R),we((b,M,Q)=>{oe(R,"d",b),G=Bt(R,"",G,M),xe(o,Q)},[()=>Re(e(_)),()=>({fill:e(_).color}),()=>Ze(e(_))]),O(I,R)},S=I=>{var R=Dr();let G;var se=D(R),o=D(se,!0);C(se),C(R),we((b,M,Q)=>{oe(R,"d",b),G=Bt(R,"",G,M),xe(o,Q)},[()=>Re(e(_)),()=>({stroke:e(_).color,"stroke-width":Math.max(1,e(_).dy)}),()=>Ze(e(_))]),O(I,R)};ve(L,I=>{e(_).causesCycle?I(H):I(S,!1)})}O(J,T)}),C($);var B=k($);Qe(B,21,()=>e(u),et,(J,_,T)=>{var L=Ir();oe(L,"data-idx",T);var H=D(L),S=k(H),I=D(S);C(S),C(L),we((R,G)=>{oe(H,"x",e(_).x),oe(H,"y",e(_).y+.5),oe(H,"width",Ae),oe(H,"height",R),oe(H,"fill",e(_).color),oe(S,"x",e(_).x+Ae/2),oe(S,"y",e(_).dy>16?e(_).y+e(_).dy/2:e(_).y-2),Ot(S,0,G),oe(S,"dominant-baseline",e(_).dy>16?"middle":"auto"),xe(I,`${e(_).label??""}
								${e(_).unitSuffix?` [${e(_).unit}]`:""}`)},[()=>Math.max(.1,e(_).dy-1),()=>St([e(_).dy>16&&(De(e(_).color)?"fill-white":"fill-black"),e(_).dy<=16&&"fill-black dark:fill-white"])]),O(J,L)}),C(B),C(v),C(h),Ft(h,J=>y(s,J),()=>e(s));var Y=k(h,2);{var z=J=>{sr(J,{get x(){return e(qe)},get y(){return e(ne)},get yOffset(){return e(fe)},get isOnTop(){return e(st)},minX:0,get maxX(){return e(t)},children:(_,T)=>{var L=Yr(),H=ue(L),S=D(H,!0);C(H);var I=k(H,2);{var R=o=>{var b=Pr(),M=k(D(b),2);Qe(M,17,()=>e(W).linksIn,et,(ae,j)=>{var le=He(),Ce=ue(le);{var de=Be=>{var me=Lr(),Xe=D(me),Ue=D(Xe),lt=D(Ue);C(Ue);var Ke=k(Ue,2),it=D(Ke);C(Ke),C(Xe);var Je=k(Xe,2),ut=D(Je);C(Je),C(me),we(ct=>{oe(lt,"fill",e(w)[e(j)].source.color),xe(it,`${e(w)[e(j)].source.label??""}:`),xe(ut,`${ct??""}
										${e(w)[e(j)].unit??""}`)},[()=>e(w)[e(j)].value.toFixed(3)]),O(Be,me)};ve(Ce,Be=>{e(w)[e(j)].value&&Be(de)})}O(ae,le)});var Q=k(M,2);{var ke=ae=>{var j=Mr(),le=k(D(j),2),Ce=D(le);C(le),C(j),we(de=>xe(Ce,`${de??""}
									${e(W).unit??""}`),[()=>Mt(e(W).linksIn.map(de=>e(w)[de]?.value||0)).toFixed(3)]),O(ae,j)};ve(Q,ae=>{e(W).showTotal&&e(W).linksIn.length>1&&ae(ke)})}C(b),we(()=>Ot(b,1,St([e(W).linksOut.length>0&&"border-b border-gray-400 pb-1"]))),O(o,b)};ve(I,o=>{e(W).linksIn.length>0&&o(R)})}var G=k(I,2);{var se=o=>{var b=Hr(),M=k(ue(b),2);Qe(M,17,()=>e(W).linksOut,et,(ae,j)=>{var le=He(),Ce=ue(le);{var de=Be=>{var me=Ar(),Xe=D(me),Ue=D(Xe),lt=D(Ue);C(Ue);var Ke=k(Ue,2),it=D(Ke);C(Ke),C(Xe);var Je=k(Xe,2),ut=D(Je);C(Je),C(me),we(ct=>{oe(lt,"fill",e(w)[e(j)].target.color),xe(it,`${e(w)[e(j)].target.label??""}:`),xe(ut,`${ct??""}
									${e(w)[e(j)].unit??""}`)},[()=>e(w)[e(j)].value.toFixed(3)]),O(Be,me)};ve(Ce,Be=>{e(w)[e(j)].value&&Be(de)})}O(ae,le)});var Q=k(M,2);{var ke=ae=>{var j=Fr(),le=k(D(j),2),Ce=D(le);C(le),C(j),we(de=>xe(Ce,`${de??""}
								${e(W).unit??""}`),[()=>Mt(e(W).linksOut.map(de=>e(w)[de]?.value||0)).toFixed(3)]),O(ae,j)};ve(Q,ae=>{e(W).showTotal&&e(W).linksOut.length>1&&ae(ke)})}O(o,b)};ve(G,o=>{e(W).linksOut.length>0&&o(se)})}we(()=>xe(S,e(W).label)),O(_,L)},$$slots:{default:!0}})};ve(Y,J=>{e(W)!==null&&J(z)})}C(c),we(()=>{oe(h,"id",f()),oe(h,"width",e(t)),oe(h,"viewBox",`${e(Se)-10} ${-e(Te)} ${e(Oe)+20} ${e($e)+2*e(Te)+20}`),oe(v,"transform",e(P))}),ft("mouseleave",h,()=>y(re,null)),O(r,c)},$$slots:{default:!0}}),O(a,F),At(pe)}kt(["click","mousemove"]);var Ur=V("<!> <!>",1),Wr=V("<!> <!> <!>",1),zr=V('<i class="bi bi-house me-2"></i> <div>Reset zoom</div>',1),Gr=V('<i class="bi bi-diagram-3 me-2"></i> <div> </div>',1),Vr=V('<div class="flex justify-end items-end h-full gap-4"><!> <!></div>'),qr=V('<div class="text-center"><div class="spinner-border center" role="status"><span class="visually-hidden">Loading...</span></div></div>'),Zr=V('<div class="text-center">No solution selected</div>'),Kr=V('<div class="text-center">No carriers selected</div>'),Jr=V('<div class="text-center">No nodes selected</div>'),Qr=V('<div class="text-center">No data available for the selected filters</div>');function va(a,l){Pt(l,!0);let t=E(be([])),d=E(!1),s=E(!1),f=E(null),m=E(be([])),p=E(be([])),x=E(null),u=null,w=null,N="",X="",Ne="",Re=E(null),Te=E(null),Se=E(null),Oe=E(null),$e=E(null),De=E(null),n=E(null),P=E(null),A=E(null),U=E(null),te=E(null),ce=E(null),Ee=E(be([])),re=E(be([])),Ie=E(be([])),q=E(be([])),he=E(be([])),W=E(be([])),Z=E(void 0);Ye(()=>{if(!e(t).length){y(x,null);return}Ne&&e(t).includes(Number(Ne))?y(x,Ne,!0):y(x,e(t)[0].toString(),!0)}),Ye(()=>{e(x)&&(Ne=e(x))}),Nt(()=>e(q),()=>!!e(f),()=>N,()=>u,g=>y(m,g,!0),g=>N=g,g=>u=g),Nt(()=>e(he),()=>!!e(f),()=>X,()=>w,g=>y(p,g,!0),g=>X=g,g=>w=g),Ye(()=>{e(m),e(p),e(x),yt(()=>{Ze()})}),Ye(()=>{e(x),e(m),e(p),Xt().then(()=>{yt(()=>{Qt({year:e(x),car:e(m).map(g=>e(q).indexOf(g)).join("~")||null,nodes:e(p).map(g=>e(he).indexOf(g)).join("~")||null})})})}),nt(()=>{y(x,er("year"),!0),u=Ct("car"),w=Ct("nodes")});function Le(){qe()}async function qe(){if(!e(f))return;y(s,!0);let g=await Jt(e(f).solution_name,["flow_conversion_input","flow_conversion_output","flow_storage_charge","flow_storage_discharge","flow_import","flow_export","demand","shed_demand","flow_storage_inflow","flow_storage_spillage","flow_transport","flow_transport_loss"],e(f).scenario_name,"demand");y(Re,_e.fromRows(g.flow_conversion_input?.data??[])),y(Te,_e.fromRows(g.flow_conversion_output?.data??[]),!0),y(Se,_e.fromRows(g.flow_storage_charge?.data??[]),!0),y(Oe,_e.fromRows(g.flow_storage_discharge?.data??[]),!0),y($e,_e.fromRows(g.flow_import?.data??[]),!0),y(De,_e.fromRows(g.flow_export?.data??[]),!0),y(n,_e.fromRows(g.demand?.data??[]),!0),y(P,_e.fromRows(g.shed_demand?.data??[]),!0),y(A,_e.fromRows(g.flow_storage_inflow?.data??[]),!0),y(U,_e.fromRows(g.flow_storage_spillage?.data??[]),!0),y(te,_e.fromRows(g.flow_transport?.data??[]),!0),y(ce,_e.fromRows(g.flow_transport_loss?.data??[]),!0),y(Ee,g.unit?.data||[],!0),y(s,!1),Ze()}function ne(g){let ye=e(Ee).find(Me=>Me.carrier===g)||{};return ye[0]||ye.units||""}function fe(g){return e(f)&&e(f).detail.reference_carrier[g]||""}function st(g){return e(f)?e(f).detail.system.set_technologies.filter(ye=>{const Me=e(f)?.detail.carriers_input[ye]||[],pe=e(f)?.detail.carriers_output[ye]||[],F=e(f)?.detail.reference_carrier[ye];return[...Me,...pe].some(ie=>g.includes(ie))||F&&g.includes(F)}):[]}function Ze(){if(!e(f)||!e(Re)||!e(Te)||!e(Se)||!e(Oe)||!e($e)||!e(De)||!e(n)||!e(P)||!e(A)||!e(U)||!e(te)||!e(ce))return[];const g="rgb(180,180,180)",ye=e(f)?.detail.system.set_storage_technologies||[],Me=e(f)?.detail.system.set_conversion_technologies||[],pe=e(f)?.detail.system.set_transport_technologies||[];function F(o,b,M,Q,ke=!1,ae=null,j=!0,le=!1){return{id:o,label:b,color:M,unit:Q,unitSuffix:ke,stickTo:ae,showTotal:j,distinctRow:le}}Vt();const ie=[],K=e(q).map(o=>{const b=Ge(o);return ie.push({color:b,carrier:o}),F(o,o,b,ne(o),!0,null,!0,!0)}),r=Me.map(o=>F(o,o,g,ne(fe(o)),!1,null,!1)),i=ye.map(o=>F(o,o,g,ne(fe(o)),!1,null,!1)),c=ye.map(o=>F(o,o+"_inflow",g,ne(fe(o)))),h=ye.map(o=>F(o,o+"_spillage",g,ne(fe(o)),!1,null,!1));let v=Ge();const $=e(q).map(o=>F(o,o+" import",v,ne(o),!0,"left"));v=Ge();const B=e(q).map(o=>F(o,o+" export",v,ne(o),!0,"right"));v=Ge();const Y=e(q).map(o=>F(o,o+" shed demand",v,ne(o)));v=Ge();const z=e(q).map(o=>F(o,o+" demand",v,ne(o),!0,"right"));v=Ge();const J=pe.map(o=>F(o,o+" transport in",v,ne(fe(o)),!1,null,!1)),_=pe.map(o=>F(o,o+" transport out",v,ne(fe(o)),!1,null,!1)),T={carrier:e(m),node:e(p),technology:st(e(m))},L=e(t).indexOf(Number(e(x)));if(L===-1)return;const H=[];function S(o,b,M,Q,ke=0){return ae=>{let j=ae.data[L]-ke;Math.abs(j)<5e-4&&(j=0);const le=o.find(me=>me.id===ae.index[b]),Ce=M.find(me=>me.id===ae.index[Q]);if(!le||!Ce){console.warn("Missing source or target node",{sourceNode:le,targetNode:Ce},{sourceId:b,targetId:Q});return}let de=g;const Be=K.find(me=>me.id===ae.index.carrier);Be&&(de=Be.color||g),H.push({source:le,target:Ce,value:j,color:de,unit:ne(ae.index.carrier)})}}function I(o){const b=fe(o.index.technology);b&&(o.index.carrier=b)}e(Re).filterByCriteria(T).groupBy(["technology","carrier"]).forEach(S(K,"carrier",r,"technology")),e(Te).filterByCriteria(T).groupBy(["technology","carrier"]).forEach(S(r,"technology",K,"carrier")),e(Se).filterByCriteria(T).groupBy(["technology"]).forEach(o=>{const b=fe(o.index.technology);b&&(o.index.carrier=b)}).forEach(S(K,"carrier",i,"technology")),e(Oe).filterByCriteria(T).groupBy(["technology"]).forEach(I).forEach(S(i,"technology",K,"carrier")),e(A).filterByCriteria(T).groupBy(["technology"]).forEach(I).forEach(S(c,"technology",i,"technology")),e(U).filterByCriteria(T).groupBy(["technology"]).forEach(I).forEach(S(i,"technology",h,"technology")),e($e).filterByCriteria(T).groupBy(["carrier"]).forEach(S($,"carrier",K,"carrier")),e(De).filterByCriteria(T).groupBy(["carrier"]).forEach(S(K,"carrier",B,"carrier"));const R=e(P).filterByCriteria(T).groupBy(["carrier"]);R.forEach(S(Y,"carrier",z,"carrier")),e(n).filterByCriteria(T).groupBy(["carrier"]).forEach(o=>{const b=R.find(Q=>Q.index.carrier===o.index.carrier),M=b?b.data[L]:0;S(K,"carrier",z,"carrier",M)(o)});const G=$t(e(f).detail.edges,e(p),!0),se=e(ce).filterByCriteria({...T,edge:G}).groupBy(["technology"]);e(te).filterByCriteria({...T,edge:G}).groupBy(["technology"]).forEach(I).forEach(o=>{const b=se.find(Q=>Q.index.technology===o.index.technology),M=b?b.data[L]:0;S(J,"technology",K,"carrier",M)(o)}),e(te).filterByCriteria({...T,edge:$t(e(f).detail.edges,e(p),!1)}).groupBy(["technology"]).forEach(I).forEach(S(K,"carrier",_,"technology")),y(re,[...K,...r,...i,...c,...h,...$,...B,...Y,...z,...J,..._],!0),y(Ie,H,!0),y(W,ie,!0)}Gt(a,{parentTitle:"The Energy System",pageTitle:"Sankey",filters:pe=>{var F=Wr(),ie=ue(F);dt(ie,{title:"Solution Selection",children:(i,c)=>{{let h=ge(()=>e(s)||e(d));qt(i,{solutionSelected:Le,get disabled(){return e(h)},get years(){return e(t)},set years(v){y(t,v,!0)},get selected_solution(){return e(f)},set selected_solution(v){y(f,v,!0)},get carriers(){return e(q)},set carriers(v){y(q,v,!0)},get nodes(){return e(he)},set nodes(v){y(he,v,!0)},get loading(){return e(d)},set loading(v){y(d,v,!0)}})}}});var K=k(ie,2);dt(K,{title:"Carrier Selection",children:(i,c)=>{Tt(i,{get options(){return e(q)},label:"Carriers",get value(){return e(m)},set value(h){y(m,h,!0)}})}});var r=k(K,2);dt(r,{title:"Data Selection",children:(i,c)=>{var h=Ur(),v=ue(h);{let B=ge(()=>Kt(e(t).map(z=>z.toString()))),Y=ge(()=>e(s)||e(d));Zt(v,{get options(){return e(B)},label:"Year",get disabled(){return e(Y)},get value(){return e(x)},set value(z){y(x,z,!0)}})}var $=k(v,2);Tt($,{get options(){return e(he)},label:"Nodes",get value(){return e(p)},set value(B){y(p,B,!0)}}),O(i,h)}}),O(pe,F)},buttons:pe=>{var F=Vr(),ie=D(F);{let r=ge(()=>e(Z)?.resetZoom);Et(ie,{get onclick(){return e(r)},children:(i,c)=>{var h=zr();Ut(2),O(i,h)},$$slots:{default:!0}})}var K=k(ie,2);{let r=ge(()=>e(Z)?.toggleShowStructureOnly);Et(K,{get onclick(){return e(r)},children:(i,c)=>{var h=Gr(),v=k(ue(h),2),$=D(v);C(v),we(B=>xe($,`Show only structure: ${B??""}`),[()=>e(Z)?.getShowStructureOnly()?"On":"Off"]),O(i,h)},$$slots:{default:!0}})}C(F),O(pe,F)},mainContent:pe=>{var F=He(),ie=ue(F);{var K=i=>{var c=qr();O(i,c)},r=i=>{var c=He(),h=ue(c);{var v=B=>{var Y=Zr();O(B,Y)},$=B=>{var Y=He(),z=ue(Y);{var J=T=>{var L=Kr();O(T,L)},_=T=>{var L=He(),H=ue(L);{var S=R=>{var G=Jr();O(R,G)},I=R=>{var G=He(),se=ue(G);{var o=M=>{var Q=Qr();O(M,Q)},b=M=>{Ft(Xr(M,{get nodes(){return e(re)},get links(){return e(Ie)},get legendItems(){return e(W)}}),Q=>y(Z,Q,!0),()=>e(Z))};ve(se,M=>{e(re).length===0?M(o):M(b,!1)},!0)}O(R,G)};ve(H,R=>{e(p).length===0?R(S):R(I,!1)},!0)}O(T,L)};ve(z,T=>{e(m).length===0?T(J):T(_,!1)},!0)}O(B,Y)};ve(h,B=>{e(f)?B($,!1):B(v)},!0)}O(i,c)};ve(ie,i=>{e(d)||e(s)?i(K):i(r,!1)})}O(pe,F)}}),At()}export{va as component};
