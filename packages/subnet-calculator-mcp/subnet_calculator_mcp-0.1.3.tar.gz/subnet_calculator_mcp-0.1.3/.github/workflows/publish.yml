name: Publish to PyPI

on:
  push:
    branches: ["main", "feature/**"]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  test-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v2

      - name: Sync project dependencies (including dev tools)
        run: uv sync --group dev

      - name: Run unit tests
        run: uv run pytest

      - name: Type check with mypy
        run: uv run mypy src

      - name: Lint with ruff
        run: uv run ruff check src tests

      - name: Ensure formatting with black
        run: uv run black --check src tests

      - name: Check published version
        id: check_version
        run: |
          python <<'PY'
          import os
          import tomllib
          import urllib.error
          import urllib.request

          with open("pyproject.toml", "rb") as handle:
              project = tomllib.load(handle)["project"]

          package = project["name"]
          version = project["version"]
          url = f"https://pypi.org/pypi/{package}/{version}/json"

          exists = "false"
          try:
              urllib.request.urlopen(url)
          except urllib.error.HTTPError as exc:
              if exc.code != 404:
                  raise
          else:
              exists = "true"

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
              fh.write(f"exists={exists}\n")
              fh.write(f"version={version}\n")
          PY

      - name: Build distributions
        if: steps.check_version.outputs.exists == 'false'
        run: |
          rm -rf dist
          uv build

      - name: Publish to PyPI
        if: steps.check_version.outputs.exists == 'false'
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: uv publish dist/subnet_calculator_mcp-*.tar.gz dist/subnet_calculator_mcp-*-py3-none-any.whl
