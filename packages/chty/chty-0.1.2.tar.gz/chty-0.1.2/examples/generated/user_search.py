# Auto-generated by chty v0.1.2


from datetime import datetime
from typing import Any, Dict, TypedDict

from clickhouse_connect.driver.client import Client


class UserSearchParams(Dict[str, Any]):
    def __init__(
        self,
        *,
        search_pattern: str,
        min_age: int,
        start_date: datetime,
        max_results: int,
    ):
        super().__init__(
            search_pattern=search_pattern,
            min_age=min_age,
            start_date=start_date,
            max_results=max_results,
        )


class UserSearchResult(TypedDict):
    user_id: int
    username: str
    email: str
    created_at: datetime


QUERY = """SELECT 
    user_id,
    username,
    email,
    created_at
FROM users
WHERE 
    username LIKE {search_pattern:String}
    AND age >= {min_age:Int32}
    AND created_at >= {start_date:DateTime}
ORDER BY created_at DESC
LIMIT {max_results:Int32}"""


class UserSearchQuery:
    def __init__(self, client: Client, *, validate: bool = False):
        self.client = client
        self.query = QUERY
        self.validate = validate
        self._expected_fields = {
            "user_id": "int",
            "username": "str",
            "email": "str",
            "created_at": "datetime",
        }

    def _validate_result(self, row: dict) -> None:
        if not self.validate:
            return
        missing = set(self._expected_fields.keys()) - set(row.keys())
        if missing:
            raise ValueError(f"Result missing expected fields: {missing}")
        extra = set(row.keys()) - set(self._expected_fields.keys())
        if extra:
            raise ValueError(f"Result has unexpected fields: {extra}")

    def execute(self, parameters: UserSearchParams, **kwargs) -> list[UserSearchResult]:
        result = self.client.query(self.query, parameters=parameters, **kwargs)
        rows = [dict(zip(result.column_names, row)) for row in result.result_rows]
        if rows:
            self._validate_result(rows[0])
        return rows  # type: ignore[return-value]

    def execute_df(
        self, parameters: UserSearchParams, **kwargs
    ) -> list[UserSearchResult]:
        df = self.client.query_df(self.query, parameters=parameters, **kwargs)
        rows = df.to_dict("records")
        if rows:
            self._validate_result(rows[0])
        return rows  # type: ignore[return-value]
