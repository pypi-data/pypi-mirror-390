# Auto-generated by chty v0.1.2


from typing import Any, Dict, TypedDict

from clickhouse_connect.driver.client import Client


class SimpleParams(Dict[str, Any]):
    def __init__(
        self,
        *,
        multiplier: int,
        limit: int,
    ):
        super().__init__(
            multiplier=multiplier,
            limit=limit,
        )


class SimpleResult(TypedDict):
    number: int
    result: int


QUERY = """SELECT number, number * {multiplier:Int32} AS result 
FROM system.numbers 
WHERE number < {limit:Int32}"""


class SimpleQuery:
    def __init__(self, client: Client, *, validate: bool = False):
        self.client = client
        self.query = QUERY
        self.validate = validate
        self._expected_fields = {
            "number": "int",
            "result": "int",
        }

    def _validate_result(self, row: dict) -> None:
        if not self.validate:
            return
        missing = set(self._expected_fields.keys()) - set(row.keys())
        if missing:
            raise ValueError(f"Result missing expected fields: {missing}")
        extra = set(row.keys()) - set(self._expected_fields.keys())
        if extra:
            raise ValueError(f"Result has unexpected fields: {extra}")

    def execute(self, parameters: SimpleParams, **kwargs) -> list[SimpleResult]:
        result = self.client.query(self.query, parameters=parameters, **kwargs)
        rows = [dict(zip(result.column_names, row)) for row in result.result_rows]
        if rows:
            self._validate_result(rows[0])
        return rows  # type: ignore[return-value]

    def execute_df(self, parameters: SimpleParams, **kwargs) -> list[SimpleResult]:
        df = self.client.query_df(self.query, parameters=parameters, **kwargs)
        rows = df.to_dict("records")
        if rows:
            self._validate_result(rows[0])
        return rows  # type: ignore[return-value]
