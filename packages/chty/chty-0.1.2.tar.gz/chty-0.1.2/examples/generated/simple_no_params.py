# Auto-generated by chty v0.1.2


from typing import TypedDict

from clickhouse_connect.driver.client import Client


class SimpleNoParamsResult(TypedDict):
    number: int
    doubled: int


QUERY = """SELECT number, number * 2 AS doubled
FROM system.numbers
LIMIT 10"""


class SimpleNoParamsQuery:
    def __init__(self, client: Client, *, validate: bool = False):
        self.client = client
        self.query = QUERY
        self.validate = validate
        self._expected_fields = {
            "number": "int",
            "doubled": "int",
        }

    def _validate_result(self, row: dict) -> None:
        if not self.validate:
            return
        missing = set(self._expected_fields.keys()) - set(row.keys())
        if missing:
            raise ValueError(f"Result missing expected fields: {missing}")
        extra = set(row.keys()) - set(self._expected_fields.keys())
        if extra:
            raise ValueError(f"Result has unexpected fields: {extra}")

    def execute(self, **kwargs) -> list[SimpleNoParamsResult]:
        result = self.client.query(self.query, **kwargs)
        rows = [dict(zip(result.column_names, row)) for row in result.result_rows]
        if rows:
            self._validate_result(rows[0])
        return rows  # type: ignore[return-value]

    def execute_df(self, **kwargs) -> list[SimpleNoParamsResult]:
        df = self.client.query_df(self.query, **kwargs)
        rows = df.to_dict("records")
        if rows:
            self._validate_result(rows[0])
        return rows  # type: ignore[return-value]
