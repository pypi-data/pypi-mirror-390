# Auto-generated by chty v0.1.2


from typing import Any, Dict, TypedDict

from clickhouse_connect.driver.client import Client


class ComplexTypesParams(Dict[str, Any]):
    def __init__(
        self,
        *,
        user_id: int,
        tag_list: list[str],
        is_active: bool,
        min_score: float | None,
    ):
        super().__init__(
            user_id=user_id,
            tag_list=tag_list,
            is_active=is_active,
            min_score=min_score,
        )


class ComplexTypesResult(TypedDict):
    user_id: int
    tags: list[str]
    metadata: str


QUERY = """SELECT 
    user_id,
    tags,
    metadata
FROM users
WHERE 
    user_id = {user_id:Int64}
    AND tags IN {tag_list:Array(String)}
    AND is_active = {is_active:Bool}
    AND score >= {min_score:Nullable(Float64)}"""


class ComplexTypesQuery:
    def __init__(self, client: Client, *, validate: bool = False):
        self.client = client
        self.query = QUERY
        self.validate = validate
        self._expected_fields = {
            "user_id": "int",
            "tags": "list[str]",
            "metadata": "str",
        }

    def _validate_result(self, row: dict) -> None:
        if not self.validate:
            return
        missing = set(self._expected_fields.keys()) - set(row.keys())
        if missing:
            raise ValueError(f"Result missing expected fields: {missing}")
        extra = set(row.keys()) - set(self._expected_fields.keys())
        if extra:
            raise ValueError(f"Result has unexpected fields: {extra}")

    def execute(
        self, parameters: ComplexTypesParams, **kwargs
    ) -> list[ComplexTypesResult]:
        result = self.client.query(self.query, parameters=parameters, **kwargs)
        rows = [dict(zip(result.column_names, row)) for row in result.result_rows]
        if rows:
            self._validate_result(rows[0])
        return rows  # type: ignore[return-value]

    def execute_df(
        self, parameters: ComplexTypesParams, **kwargs
    ) -> list[ComplexTypesResult]:
        df = self.client.query_df(self.query, parameters=parameters, **kwargs)
        rows = df.to_dict("records")
        if rows:
            self._validate_result(rows[0])
        return rows  # type: ignore[return-value]
