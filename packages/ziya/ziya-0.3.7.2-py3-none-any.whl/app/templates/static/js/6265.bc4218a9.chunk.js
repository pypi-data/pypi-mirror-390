"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[6265],{46265:(e,n,s)=>{s.r(n),s.d(n,{default:()=>N});var t=s(89379),o=s(65043),a=s(85271),l=s(6381),i=s(32442),r=s(42214),c=s(10491),d=s(6051),m=s(94828),g=s(15492),h=s(57721),u=s(15615),x=s(88143),p=s(31219),y=s(33359),v=s(70579);const f=e=>{let{index:n,isInline:s=!1}=e;const{currentMessages:a,currentConversationId:f,addMessageToConversation:j,setIsStreaming:C,setConversations:w,streamingConversations:A,addStreamingConversation:b,streamedContentMap:M,setStreamedContentMap:k,removeStreamingConversation:S,editingMessageIndex:I,setEditingMessageIndex:R}=(0,l.v)(),[z,N]=(0,o.useState)(a[n].content),{checkedKeys:K}=(0,r.X)(),E=(0,o.useRef)(null),{TextArea:T}=c.A,_=I===n;(0,o.useEffect)(()=>{_&&E.current&&setTimeout(()=>{E.current&&E.current.focus()},100)},[_]);return(0,v.jsxs)("div",{children:[s&&_&&null,_&&!s&&(0,v.jsxs)("div",{style:{width:"100%"},children:[(0,v.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"8px",width:"100%"},children:[(0,v.jsx)("div",{className:"message-sender",children:"You:"}),(0,v.jsxs)(d.A,{children:[(0,v.jsx)(m.A,{title:"Cancel editing",children:(0,v.jsx)(g.Ay,{icon:(0,v.jsx)(u.A,{}),onClick:()=>{R(null),N(a[n].content)},size:"small",children:"Cancel"})}),(0,v.jsx)(m.A,{title:"Save changes to context",children:(0,v.jsx)(g.Ay,{icon:(0,v.jsx)(x.A,{}),onClick:()=>{w(e=>e.map(e=>{if(e.id===f){const s=e.messages.map((e,s)=>s===n?(0,t.A)((0,t.A)({},e),{},{content:z,_timestamp:Date.now()}):e);return(0,t.A)((0,t.A)({},e),{},{messages:s,_version:Date.now()})}return e})),R(null)},size:"small",children:"Save"})}),(0,v.jsx)(m.A,{title:"Send to model, remove newer responses",children:(0,v.jsx)(g.Ay,{icon:(0,v.jsx)(p.A,{}),onClick:async()=>{R(null),k(new Map);const e=a.slice(0,n+1);e[n]=(0,t.A)((0,t.A)({},e[n]),{},{content:z,_timestamp:Date.now(),_edited:!0,_truncatedAfter:!0}),w(n=>n.map(n=>n.id===f?(0,t.A)((0,t.A)({},n),{},{messages:e,_version:Date.now(),_editInProgress:!0}):n)),b(f);try{const n=await(0,i.f)(e,z,(0,h.F)(K),f,M,k,C,S,j,A.has(f));if(n){j({content:n,role:"assistant"},f),w(e=>e.map(e=>e.id===f?(0,t.A)((0,t.A)({},e),{},{_editInProgress:!1}):e))}}catch(s){console.error("Error sending message:",s),S(f)}finally{C(!1)}},size:"small",type:"primary",children:"Submit"})})]})]}),(0,v.jsx)(T,{ref:E,autoFocus:!0,style:{width:"100%",minHeight:"100px",resize:"vertical"},value:z,onChange:e=>N(e.target.value),autoSize:{minRows:3,maxRows:20},placeholder:"Edit your message..."})]}),!_&&(s||!_)&&(0,v.jsx)(m.A,{title:"Edit",children:(0,v.jsx)(g.Ay,{icon:(0,v.jsx)(y.A,{}),onClick:()=>{R(n)}})})]})};var j=s(91686),C=s(42144),w=s(22643),A=s(9356),b=s(8347);const M=(0,o.memo)(e=>{let{previousModel:n,newModel:s,changeKey:t}=e;const{isDarkMode:o}=(0,b.D)(),a={container:{padding:"12px 16px",borderRadius:"8px",backgroundColor:o?"rgba(25, 118, 210, 0.15)":"rgba(25, 118, 210, 0.08)",border:"1px solid ".concat(o?"#2c6cb0":"#90caf9"),marginBottom:"12px",marginTop:"4px",display:"flex",alignItems:"center",boxShadow:o?"0 2px 8px rgba(0, 0, 0, 0.15)":"0 1px 3px rgba(0, 0, 0, 0.1)"},icon:{fontSize:"20px",marginRight:"12px",color:o?"#90caf9":"#1976d2"},text:{color:o?"#e3f2fd":"#0d47a1",fontWeight:500,fontSize:"14px"},modelName:{fontWeight:600,color:o?"#bbdefb":"#1565c0"}};return(0,v.jsxs)("div",{style:a.container,children:[(0,v.jsx)("span",{style:a.icon,children:"\ud83d\udd04"}),(0,v.jsxs)("span",{style:a.text,children:["Model changed from ",(0,v.jsx)("span",{style:a.modelName,children:n})," to ",(0,v.jsx)("span",{style:a.modelName,children:s})]})]})},(e,n)=>(!e.changeKey||!n.changeKey||e.changeKey===n.changeKey)&&(e.previousModel===n.previousModel&&e.newModel===n.newModel&&e.changeKey===n.changeKey));M.displayName="ModelChangeNotification";const k=M;var S=s(8627),I=s(89277),R=s(35589);const z=(0,o.memo)(e=>{let{enableCodeApply:n}=e;const{currentMessages:s,editingMessageIndex:c,isTopToBottom:d,isLoadingConversation:u,addStreamingConversation:x,streamingConversations:p,currentConversationId:y,setIsStreaming:b,setStreamedContentMap:M,isStreaming:z,addMessageToConversation:N,removeStreamingConversation:K,streamedContentMap:E,userHasScrolled:T,updateProcessingState:_,setConversations:F,toggleMessageMute:D,recordManualScroll:H}=(0,l.v)(),{checkedKeys:L}=(0,r.X)(),{setQuestion:Y}=(0,S.J)(),B=(0,o.useRef)(!0),W=(0,o.useMemo)(()=>({isCurrentlyStreaming:p.has(y),hasStreamedContent:E.has(y)&&""!==E.get(y),streamedContent:E.get(y)||""}),[p,E,y]),P=(0,o.useRef)(!1),{isCurrentlyStreaming:q,hasStreamedContent:O}=W,Q=s.length>100,U=(0,o.useCallback)(e=>{const n=s[e],t=e===s.length-1,o=e+1,a=o<s.length,l=a?s[o]:null;return"human"===(null===n||void 0===n?void 0:n.role)&&!q&&!O&&(t||a&&"assistant"!==(null===l||void 0===l?void 0:l.role))},[s,q,O]),X=(0,o.useCallback)(e=>U(e)?(0,v.jsx)(m.A,{title:"The AI response may have failed. Click to retry.",children:(0,v.jsx)(g.Ay,{icon:(0,v.jsx)(C.A,{}),type:"primary",size:"small",onClick:async()=>{const n=s[e],t=document.querySelector(".chat-container");if(t){(d?t.scrollHeight-t.scrollTop-t.clientHeight<50:t.scrollTop<50)||(H(),console.log("\ud83d\udcdc Retry while scrolled away - position locked"))}x(y);try{const e=s.filter(e=>!e.muted);await(0,i.f)(e,n.content,(0,h.F)(L||[]),y,E,M,b,K,N,p.has(y),e=>_(y,e))}catch(o){b(!1),K(y),console.error("Error retrying message:",o)}},children:"Retry AI Response"})}):null,[U,s,d,H,x,y,L,E,M,b,K,N,p,_]),J=(0,o.useCallback)(e=>{if(c===e)return null;const n=s[e];return U(e)?null:n&&"system"!==n.role?(0,v.jsx)(m.A,{title:n.muted?"Unmute (include in context)":"Mute (exclude from context)",children:(0,v.jsx)(g.Ay,{icon:n.muted?(0,v.jsx)(w.A,{}):(0,v.jsx)(A.A,{}),type:"default",size:"small",style:{padding:"0 8px",minWidth:"32px",height:"32px"},onClick:()=>{D(y,e)}})}):null},[c,s,U,D,y]),V=(0,o.useCallback)(e=>{if(c===e)return null;const n=s[e];return U(e)?null:n&&"human"===n.role?q?null:(0,v.jsx)(m.A,{title:"Resubmit this question",children:(0,v.jsx)(g.Ay,{icon:(0,v.jsx)(C.A,{}),type:"default",size:"small",style:{padding:"0 8px",minWidth:"32px",height:"32px"},onClick:()=>{M(new Map);const o=s.slice(0,e+1),a=o.filter(e=>!e.muted);F(e=>e.map(e=>e.id===y?(0,t.A)((0,t.A)({},e),{},{messages:o,_version:Date.now()}):e)),x(y),(async()=>{try{await(0,i.f)(a,n.content,(0,h.F)(L||[]),y,E,M,b,K,N,p.has(y),e=>_(y,e))}catch(e){b(!1),K(y),console.error("Error resubmitting message:",e)}})(),Y("")}})}):null},[c,s,U,q,M,F,y,x,L,E,M,b,K,N,p,_,Y]),G=(0,o.useCallback)(e=>{let{index:t,style:o}=e;const a=d?t:s.length-1-t,l=s[a],i=a+1,r=i<s.length,m=r?s[i]:null;if(!l)return(0,v.jsx)("div",{style:o});const g="human"===l.role&&!q&&!O&&(a===s.length-1||r&&"assistant"!==(null===m||void 0===m?void 0:m.role));"system"===l.role&&l.modelChange?"".concat(l.modelChange.from,"->").concat(l.modelChange.to):l.content;return(0,v.jsx)("div",{style:o,className:"message ".concat(l.role||"").concat(l.muted?" muted":"").concat(g?" needs-response":""),children:"system"===l.role&&l.modelChange?(0,v.jsx)(k,{previousModel:l.modelChange.from,changeKey:l.modelChange.changeKey,newModel:l.modelChange.to}):l.content?(0,v.jsxs)(v.Fragment,{children:["human"===l.role&&(0,v.jsxs)("div",{style:{display:c===a?"none":"flex",justifyContent:"space-between"},children:[(0,v.jsx)("div",{className:"message-sender",children:"You:"}),(0,v.jsxs)("div",{style:{display:"flex",gap:"8px",alignItems:"center",marginRight:"8px"},children:[J(a),V(a),g&&X(a),(0,v.jsx)(f,{index:a,isInline:!0})]})]}),"human"===l.role&&c===a?(0,v.jsx)(f,{index:a,isInline:!1}):"human"===l.role&&l.content?(0,v.jsx)("div",{className:"message-content",children:(0,v.jsx)(R.MarkdownRenderer,{markdown:l.content,enableCodeApply:n,isStreaming:z||p.has(y)})}):"assistant"===l.role&&l.content?(0,v.jsxs)(v.Fragment,{children:[(0,v.jsxs)("div",{style:{display:"flex",justifyContent:"space-between"},children:[(0,v.jsx)("div",{className:"message-sender",children:"AI:"}),(0,v.jsx)("div",{style:{display:"flex",gap:"8px",alignItems:"center",marginRight:"8px"},children:J(a)}),X(a)]}),(0,v.jsx)("div",{className:"message-content",children:(0,v.jsx)(R.MarkdownRenderer,{markdown:l.content,enableCodeApply:n,isStreaming:z||p.has(y)})})]}):null]}):null},"message-".concat(l.id||a))},[s,d,q,O,c,J,V,X,n,z,p,y]),Z=Q?null:d?s:[...s].reverse(),$=(0,o.useRef)(0),ee=(0,o.useRef)(new Set),ne=(0,o.useRef)(new Set);(0,o.useCallback)(e=>E.has(e)&&""!==E.get(e),[E]);(0,o.useEffect)(()=>{Math.abs(s.length-$.current)>2&&((0,I.QU)()&&(0,I.cY)("Conversation messages updated:",{messageCount:s.length,previousCount:$.current,isVisible:B.current,displayOrder:d?"top-down":"bottom-up"}),$.current=s.length);const e=new IntersectionObserver(e=>{e.forEach(e=>{B.current=e.isIntersecting})},{threshold:.1});return()=>e.disconnect()},[d,s.length]),(0,o.useEffect)(()=>{const e=P.current?new Set([y]):new Set,n=(new Set(Array.from(p)),P.current),s=q;P.current=s;(p.size<e.size||n&&!s)&&(n&&!s?console.log("\u2705 Current conversation finished streaming"):p.size<e.size&&(console.log("\ud83d\udccc Background conversation finished - locking scroll position"),H()))},[q,p,y,H]),(0,o.useEffect)(()=>{const e=e=>{const{previousModel:n,newModel:s}=e.detail,t="".concat(n,"->").concat(s);ne.current.has(t)||(ne.current.add(t),n&&s&&N({role:"system",content:"Model changed from ".concat(n," to ").concat(s),modelChange:{from:n,to:s,changeKey:t}},y))};return window.addEventListener("modelChanged",e),()=>{ne.current.clear(),ee.current.clear(),window.removeEventListener("modelChanged",e)}},[y,N]);const se=u?s.length>0?"Loading messages (".concat(s.length," loaded)..."):"Loading conversation...":"",te=u&&s.length>0,oe=u&&0===s.length;return(0,v.jsxs)("div",{style:{position:"relative"},children:[oe&&(0,v.jsx)("div",{style:{position:"fixed",top:"var(--header-height)",left:"var(--folder-panel-width)",right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",display:"flex",justifyContent:"center",alignItems:"center",zIndex:1e3},children:(0,v.jsx)(j.A,{size:"large",tip:se})}),(0,v.jsxs)("div",{style:{opacity:u?.5:1,minHeight:"50px"},className:"conversation-messages-container",children:[te&&(0,v.jsxs)("div",{style:{position:"sticky",top:0,backgroundColor:"rgba(0, 0, 0, 0.7)",color:"#fff",padding:"8px 16px",borderRadius:"4px",margin:"8px 0",display:"flex",alignItems:"center",gap:"8px",zIndex:1e3},children:[(0,v.jsx)(j.A,{size:"small"}),(0,v.jsx)("span",{children:se})]}),(null===Z||void 0===Z?void 0:Z.map((e,t)=>{const o=d?t:s.length-1-t,a=o+1,l=a<s.length,i=l?s[a]:null,r="human"===e.role&&!q&&!O&&(o===s.length-1||l&&"assistant"!==(null===i||void 0===i?void 0:i.role));"system"===e.role&&e.modelChange?"".concat(e.modelChange.from,"->").concat(e.modelChange.to):e.content;return(0,v.jsx)("div",{className:"message ".concat(e.role||"").concat(e.muted?" muted":"").concat(r?" needs-response":""),children:"system"===e.role&&e.modelChange?(0,v.jsx)(k,{previousModel:e.modelChange.from,changeKey:e.modelChange.changeKey,newModel:e.modelChange.to}):e.content?(0,v.jsxs)(v.Fragment,{children:["human"===e.role&&(0,v.jsxs)("div",{style:{display:c===o?"none":"flex",justifyContent:"space-between"},children:[(0,v.jsx)("div",{className:"message-sender",children:"You:"}),(0,v.jsxs)("div",{style:{display:"flex",gap:"8px",alignItems:"center",marginRight:"8px"},children:[J(o),V(o),r&&X(o),(0,v.jsx)(f,{index:o,isInline:!0})]})]}),"human"===e.role&&c===o?(0,v.jsx)(f,{index:o,isInline:!1}):"human"===e.role&&e.content?(0,v.jsx)("div",{className:"message-content",children:(0,v.jsx)(R.MarkdownRenderer,{markdown:e.content,enableCodeApply:n,isStreaming:z||p.has(y)})}):"assistant"===e.role&&e.content?(0,v.jsxs)(v.Fragment,{children:[(0,v.jsxs)("div",{style:{display:"flex",justifyContent:"space-between"},children:[(0,v.jsx)("div",{className:"message-sender",children:"AI:"}),(0,v.jsx)("div",{style:{display:"flex",gap:"8px",alignItems:"center",marginRight:"8px"},children:J(o)}),X(o)]}),(0,v.jsx)("div",{className:"message-content",children:(0,v.jsx)(R.MarkdownRenderer,{markdown:e.content,enableCodeApply:n,isStreaming:z||p.has(y)})})]}):null]}):null},"message-".concat(e.id||t))}))||(Q?(0,v.jsx)("div",{style:{height:"400px",width:"100%"},children:(0,v.jsx)(a.Y1,{height:window.innerHeight-200,itemCount:s.length,itemSize:150,width:"100%",children:G})}):null),(!Z||0===Z.length)&&!Q&&(0,v.jsx)("div",{style:{textAlign:"center",padding:"2rem",color:"#999"},children:"No messages in this conversation yet."})]})]})},(e,n)=>e.enableCodeApply===n.enableCodeApply);z.displayName="Conversation";const N=z}}]);
//# sourceMappingURL=6265.bc4218a9.chunk.js.map