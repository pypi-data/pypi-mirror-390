"use strict";(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[6265],{46265:(e,n,t)=>{t.r(n),t.d(n,{default:()=>R});var s=t(65043),o=t(85271),r=t(6381),i=t(32442),l=t(42214),a=t(10491),d=t(6051),c=t(94828),m=t(15492),g=t(57721),h=t(15615),u=t(88143),p=t(31219),x=t(33359),y=t(70579);const v=e=>{let{index:n,isInline:t=!1}=e;const{currentMessages:o,currentConversationId:v,addMessageToConversation:f,setIsStreaming:C,setConversations:j,streamingConversations:w,addStreamingConversation:A,streamedContentMap:b,setStreamedContentMap:M,removeStreamingConversation:S,editingMessageIndex:k,setEditingMessageIndex:I}=(0,r.v)(),[z,R]=(0,s.useState)(o[n].content),{checkedKeys:N}=(0,l.X)(),E=(0,s.useRef)(null),{TextArea:K}=a.A,$=k===n;(0,s.useEffect)(()=>{$&&E.current&&setTimeout(()=>{E.current&&E.current.focus()},100)},[$]);return(0,y.jsxs)("div",{children:[t&&$&&null,$&&!t&&(0,y.jsxs)("div",{style:{width:"100%"},children:[(0,y.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"8px",width:"100%"},children:[(0,y.jsx)("div",{className:"message-sender",children:"You:"}),(0,y.jsxs)(d.A,{children:[(0,y.jsx)(c.A,{title:"Cancel editing",children:(0,y.jsx)(m.Ay,{icon:(0,y.jsx)(h.A,{}),onClick:()=>{I(null),R(o[n].content)},size:"small",children:"Cancel"})}),(0,y.jsx)(c.A,{title:"Save changes to context",children:(0,y.jsx)(m.Ay,{icon:(0,y.jsx)(u.A,{}),onClick:()=>{j(e=>e.map(e=>{if(e.id===v){const t=e.messages.map((e,t)=>t===n?{...e,content:z,_timestamp:Date.now()}:e);return{...e,messages:t,_version:Date.now()}}return e})),I(null)},size:"small",children:"Save"})}),(0,y.jsx)(c.A,{title:"Send to model, remove newer responses",children:(0,y.jsx)(m.Ay,{icon:(0,y.jsx)(p.A,{}),onClick:async()=>{I(null),M(new Map);const e=o.slice(0,n+1);e[n]={...e[n],content:z,_timestamp:Date.now(),_edited:!0,_truncatedAfter:!0},j(n=>n.map(n=>n.id===v?{...n,messages:e,_version:Date.now(),_editInProgress:!0}:n)),A(v);try{const n=await(0,i.f)(e,z,(0,g.F)(N),v,b,M,C,S,f,w.has(v));if(n){f({content:n,role:"assistant"},v),j(e=>e.map(e=>e.id===v?{...e,_editInProgress:!1}:e))}}catch(t){console.error("Error sending message:",t),S(v)}finally{C(!1)}},size:"small",type:"primary",children:"Submit"})})]})]}),(0,y.jsx)(K,{ref:E,autoFocus:!0,style:{width:"100%",minHeight:"100px",resize:"vertical"},value:z,onChange:e=>R(e.target.value),autoSize:{minRows:3,maxRows:20},placeholder:"Edit your message..."})]}),!$&&(t||!$)&&(0,y.jsx)(c.A,{title:"Edit",children:(0,y.jsx)(m.Ay,{icon:(0,y.jsx)(x.A,{}),onClick:()=>{I(n)}})})]})};var f=t(91686),C=t(42144),j=t(22643),w=t(9356),A=t(8347);const b=(0,s.memo)(e=>{let{previousModel:n,newModel:t,changeKey:s}=e;const{isDarkMode:o}=(0,A.D)(),r={container:{padding:"12px 16px",borderRadius:"8px",backgroundColor:o?"rgba(25, 118, 210, 0.15)":"rgba(25, 118, 210, 0.08)",border:"1px solid "+(o?"#2c6cb0":"#90caf9"),marginBottom:"12px",marginTop:"4px",display:"flex",alignItems:"center",boxShadow:o?"0 2px 8px rgba(0, 0, 0, 0.15)":"0 1px 3px rgba(0, 0, 0, 0.1)"},icon:{fontSize:"20px",marginRight:"12px",color:o?"#90caf9":"#1976d2"},text:{color:o?"#e3f2fd":"#0d47a1",fontWeight:500,fontSize:"14px"},modelName:{fontWeight:600,color:o?"#bbdefb":"#1565c0"}};return(0,y.jsxs)("div",{style:r.container,children:[(0,y.jsx)("span",{style:r.icon,children:"\ud83d\udd04"}),(0,y.jsxs)("span",{style:r.text,children:["Model changed from ",(0,y.jsx)("span",{style:r.modelName,children:n})," to ",(0,y.jsx)("span",{style:r.modelName,children:t})]})]})},(e,n)=>(!e.changeKey||!n.changeKey||e.changeKey===n.changeKey)&&(e.previousModel===n.previousModel&&e.newModel===n.newModel&&e.changeKey===n.changeKey));b.displayName="ModelChangeNotification";const M=b;var S=t(8627),k=t(89277),I=t(35589);const z=(0,s.memo)(e=>{let{enableCodeApply:n}=e;const{currentMessages:t,editingMessageIndex:a,isTopToBottom:d,isLoadingConversation:h,addStreamingConversation:u,streamingConversations:p,currentConversationId:x,setIsStreaming:A,setStreamedContentMap:b,isStreaming:z,addMessageToConversation:R,removeStreamingConversation:N,streamedContentMap:E,userHasScrolled:K,updateProcessingState:$,setConversations:T,toggleMessageMute:_,recordManualScroll:D}=(0,r.v)(),{checkedKeys:F}=(0,l.X)(),{setQuestion:H}=(0,S.J)(),L=(0,s.useRef)(!0),B=(0,s.useMemo)(()=>({isCurrentlyStreaming:p.has(x),hasStreamedContent:E.has(x)&&""!==E.get(x),streamedContent:E.get(x)||""}),[p,E,x]),W=(0,s.useRef)(!1),{isCurrentlyStreaming:Y,hasStreamedContent:P}=B,q=t.length>50,O=(0,s.useCallback)(e=>{let{index:n,style:s}=e;const o=d?n:t.length-1-n,r=t[o];return r?(0,y.jsx)("div",{style:s,className:`message ${r.role||""}${r.muted?" muted":""}`}):(0,y.jsx)("div",{style:s})},[t,d]),Q=q?null:d?t:[...t].reverse(),U=(0,s.useRef)(0),X=(0,s.useRef)(new Set),J=(0,s.useRef)(new Set);(0,s.useCallback)(e=>E.has(e)&&""!==E.get(e),[E]);(0,s.useEffect)(()=>{Math.abs(t.length-U.current)>2&&((0,k.QU)()&&(0,k.cY)("Conversation messages updated:",{messageCount:t.length,previousCount:U.current,isVisible:L.current,displayOrder:d?"top-down":"bottom-up"}),U.current=t.length);const e=new IntersectionObserver(e=>{e.forEach(e=>{L.current=e.isIntersecting})},{threshold:.1});return()=>e.disconnect()},[d,t.length]),(0,s.useEffect)(()=>{const e=W.current?new Set([x]):new Set,n=(new Set(Array.from(p)),W.current),t=Y;W.current=t;(p.size<e.size||n&&!t)&&(n&&!t?console.log("\u2705 Current conversation finished streaming"):p.size<e.size&&(console.log("\ud83d\udccc Background conversation finished - locking scroll position"),D()))},[Y,p,x,D]),(0,s.useEffect)(()=>{const e=e=>{const{previousModel:n,newModel:t}=e.detail,s=`${n}->${t}`;J.current.has(s)||(J.current.add(s),n&&t&&R({role:"system",content:`Model changed from ${n} to ${t}`,modelChange:{from:n,to:t,changeKey:s}},x))};return window.addEventListener("modelChanged",e),()=>{J.current.clear(),X.current.clear(),window.removeEventListener("modelChanged",e)}},[x,R]);const V=h?t.length>0?`Loading messages (${t.length} loaded)...`:"Loading conversation...":"",G=h&&t.length>0,Z=h&&0===t.length,ee=e=>{const n=t[e],s=e===t.length-1,o=e+1,r=o<t.length,i=r?t[o]:null;return"human"===(null===n||void 0===n?void 0:n.role)&&!Y&&!P&&(s||r&&"assistant"!==(null===i||void 0===i?void 0:i.role))},ne=e=>ee(e)?(0,y.jsx)(c.A,{title:"The AI response may have failed. Click to retry.",children:(0,y.jsx)(m.Ay,{icon:(0,y.jsx)(C.A,{}),type:"primary",size:"small",onClick:async()=>{const n=t[e],s=document.querySelector(".chat-container");if(s){(d?s.scrollHeight-s.scrollTop-s.clientHeight<50:s.scrollTop<50)||(D(),console.log("\ud83d\udcdc Retry while scrolled away - position locked"))}u(x);try{const e=t.filter(e=>!e.muted);await(0,i.f)(e,n.content,(0,g.F)(F||[]),x,E,b,A,N,R,p.has(x),e=>$(x,e))}catch(o){A(!1),N(x),console.error("Error retrying message:",o)}},children:"Retry AI Response"})}):null,te=e=>{if(a===e)return null;const n=t[e];return ee(e)?null:n&&"system"!==n.role?(0,y.jsx)(c.A,{title:n.muted?"Unmute (include in context)":"Mute (exclude from context)",children:(0,y.jsx)(m.Ay,{icon:n.muted?(0,y.jsx)(j.A,{}):(0,y.jsx)(w.A,{}),type:"default",size:"small",style:{padding:"0 8px",minWidth:"32px",height:"32px"},onClick:()=>{_(x,e)}})}):null},se=e=>{if(a===e)return null;const n=t[e];return ee(e)?null:n&&"human"===n.role?Y?null:(0,y.jsx)(c.A,{title:"Resubmit this question",children:(0,y.jsx)(m.Ay,{icon:(0,y.jsx)(C.A,{}),type:"default",size:"small",style:{padding:"0 8px",minWidth:"32px",height:"32px"},onClick:()=>{b(new Map);const s=t.slice(0,e+1),o=s.filter(e=>!e.muted);T(e=>e.map(e=>e.id===x?{...e,messages:s,_version:Date.now()}:e)),u(x),(async()=>{try{await(0,i.f)(o,n.content,(0,g.F)(F||[]),x,E,b,A,N,R,p.has(x),e=>$(x,e))}catch(e){A(!1),N(x),console.error("Error resubmitting message:",e)}})(),H("")}})}):null};return(0,y.jsxs)("div",{style:{position:"relative"},children:[Z&&(0,y.jsx)("div",{style:{position:"fixed",top:"var(--header-height)",left:"var(--folder-panel-width)",right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.5)",display:"flex",justifyContent:"center",alignItems:"center",zIndex:1e3},children:(0,y.jsx)(f.A,{size:"large",tip:V})}),(0,y.jsxs)("div",{style:{opacity:h?.5:1,minHeight:"50px"},className:"conversation-messages-container",children:[G&&(0,y.jsxs)("div",{style:{position:"sticky",top:0,backgroundColor:"rgba(0, 0, 0, 0.7)",color:"#fff",padding:"8px 16px",borderRadius:"4px",margin:"8px 0",display:"flex",alignItems:"center",gap:"8px",zIndex:1e3},children:[(0,y.jsx)(f.A,{size:"small"}),(0,y.jsx)("span",{children:V})]}),(null===Q||void 0===Q?void 0:Q.map((e,s)=>{const o=d?s:t.length-1-s,r=o+1,i=r<t.length,l=i?t[r]:null,c="human"===e.role&&!Y&&!P&&(o===t.length-1||i&&"assistant"!==(null===l||void 0===l?void 0:l.role));"system"===e.role&&e.modelChange?(e.modelChange.from,e.modelChange.to):e.content;return(0,y.jsx)("div",{className:`message ${e.role||""}${e.muted?" muted":""}${c?" needs-response":""}`,children:"system"===e.role&&e.modelChange?(0,y.jsx)(M,{previousModel:e.modelChange.from,changeKey:e.modelChange.changeKey,newModel:e.modelChange.to}):e.content?(0,y.jsxs)(y.Fragment,{children:["human"===e.role&&(0,y.jsxs)("div",{style:{display:a===o?"none":"flex",justifyContent:"space-between"},children:[(0,y.jsx)("div",{className:"message-sender",children:"You:"}),(0,y.jsxs)("div",{style:{display:"flex",gap:"8px",alignItems:"center",marginRight:"8px"},children:[te(o),se(o),c&&ne(o),(0,y.jsx)(v,{index:o,isInline:!0})]})]}),"human"===e.role&&a===o?(0,y.jsx)(v,{index:o,isInline:!1}):"human"===e.role&&e.content?(0,y.jsx)("div",{className:"message-content",children:(0,y.jsx)(I.MarkdownRenderer,{markdown:e.content,enableCodeApply:n,isStreaming:z||p.has(x)})}):"assistant"===e.role&&e.content?(0,y.jsxs)(y.Fragment,{children:[(0,y.jsxs)("div",{style:{display:"flex",justifyContent:"space-between"},children:[(0,y.jsx)("div",{className:"message-sender",children:"AI:"}),(0,y.jsx)("div",{style:{display:"flex",gap:"8px",alignItems:"center",marginRight:"8px"},children:te(o)}),ne(o)]}),(0,y.jsx)("div",{className:"message-content",children:(0,y.jsx)(I.MarkdownRenderer,{markdown:e.content,enableCodeApply:n,isStreaming:z||p.has(x)})})]}):null]}):null},`message-${e.id||s}`)}))||(q?(0,y.jsx)("div",{style:{height:"400px",width:"100%"},children:(0,y.jsx)(o.Y1,{height:400,itemCount:t.length,itemSize:100,width:"100%",children:O})}):null),(!Q||0===Q.length)&&!q&&(0,y.jsx)("div",{style:{textAlign:"center",padding:"2rem",color:"#999"},children:"No messages in this conversation yet."})]})]})},(e,n)=>e.enableCodeApply===n.enableCodeApply);z.displayName="Conversation";const R=z}}]);
//# sourceMappingURL=6265.9e5eed6f.chunk.js.map