import{r as o,E as B,_ as A,w as Bt,bu as w,bv as ct,s as g,e as z,j as a,P as ut,b as pt,B as gt,am as F,T as At,F as $,u as G,al as Lt,ag as ft,bs as Vt,h as Mt,a4 as Ht,at as $t,bw as Wt,k as K,bj as lt,bk as Nt}from"./index.Cfp6iZXn.js";import{g as Pt,C as Ot,I as Kt,F as j,E as ht,b as Xt,s as _t,u as jt,a as Gt}from"./FileHelper.DWMFNFR1.js";import{u as Yt}from"./useWaveformController.BpTkIoCM.js";import{I as qt}from"./InputInstructions.C740tCk8.js";import{u as Jt,T as Qt}from"./useTextInputAutoExpand.C1IUONpj.js";import{i as Zt}from"./inputUtils.CptNuJwn.js";import{E as te}from"./ErrorOutline.esm.BkLijQGi.js";import{U as mt}from"./UploadFileInfo.C-jY39rj.js";import"./base-input.DKexhoai.js";var yt=o.forwardRef(function(t,e){var n={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return o.createElement(B,A({iconAttrs:n,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},t,{ref:e}),o.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),o.createElement("path",{d:"M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 015 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 005 0V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"}))});yt.displayName="AttachFile";var Ct=o.forwardRef(function(t,e){var n={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return o.createElement(B,A({iconAttrs:n,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},t,{ref:e}),o.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),o.createElement("path",{d:"M18 6.7l-8.48 8.48-3.54-3.54a.996.996 0 10-1.41 1.41l4.24 4.24c.39.39 1.02.39 1.41 0l9.18-9.18a.999.999 0 00-.01-1.42c-.37-.38-1-.38-1.39.01z"}))});Ct.displayName="Check";var wt=o.forwardRef(function(t,e){var n={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return o.createElement(B,A({iconAttrs:n,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},t,{ref:e}),o.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),o.createElement("path",{d:"M18.3 5.71a.996.996 0 00-1.41 0L12 10.59 7.11 5.7A.996.996 0 105.7 7.11L10.59 12 5.7 16.89a.996.996 0 101.41 1.41L12 13.41l4.89 4.89a.996.996 0 101.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4z"}))});wt.displayName="Close";var vt=o.forwardRef(function(t,e){var n={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return o.createElement(B,A({iconAttrs:n,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},t,{ref:e}),o.createElement("rect",{width:24,height:24,fill:"none"}),o.createElement("path",{d:"M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"}),o.createElement("path",{d:"M17.91 11c-.49 0-.9.36-.98.85C16.52 14.21 14.47 16 12 16s-4.52-1.79-4.93-4.15a.998.998 0 00-.98-.85c-.61 0-1.09.54-1 1.14.49 3 2.89 5.34 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.44 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"}))});vt.displayName="Mic";var bt=o.forwardRef(function(t,e){var n={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return o.createElement(B,A({iconAttrs:n,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},t,{ref:e}),o.createElement("rect",{width:24,height:24,fill:"none"}),o.createElement("path",{d:"M3 5.51v3.71c0 .46.31.86.76.97L11 12l-7.24 1.81c-.45.11-.76.51-.76.97v3.71c0 .72.73 1.2 1.39.92l15.42-6.49c.82-.34.82-1.5 0-1.84L4.39 4.58C3.73 4.31 3 4.79 3 5.51z"}))});bt.displayName="Send";const dt=Bt.getLogger("ChatInput"),xt=(t,e)=>e===w.Directory?{...t,webkitdirectory:"",multiple:!0}:t,ee=(t,e)=>{if(!e||e.length===0)return!0;const n=t.name.toLowerCase(),l=n.lastIndexOf(".");if(l===-1||l===n.length-1)return e.some(C=>C===""||C===".");const u=n.substring(l),d=n.substring(l+1);return e.some(C=>{const v=C.toLowerCase();return v.startsWith(".")?u===v:d===v})},oe=(t,e)=>ee(t,e)?{isValid:!0}:{isValid:!1,errorMessage:`${t.type||"This type of"} files are not allowed.`},It=t=>{switch(t){case w.None:return"a file";case w.Single:return"a file";case w.Multiple:return"files";case w.Directory:return"a directory";default:return ct(t),"a file"}},re=g("div",{target:"e15560op0"})(({theme:t,height:e})=>({backgroundColor:t.colors.transparent,position:"absolute",left:0,bottom:0,minHeight:`max(${t.sizes.emptyDropdownHeight}, ${e})`,width:"100%",zIndex:t.zIndices.priority})),ne=g("div",{target:"e15560op1"})(({theme:t,height:e})=>({border:`${t.sizes.borderWidth} solid`,borderColor:t.colors.primary,borderRadius:t.radii.chatInput,backgroundColor:t.colors.secondaryBg,color:t.colors.primary,display:"flex",alignItems:"center",justifyContent:"center",height:e,width:"100%",fontWeight:t.fontWeights.bold})),ae=g("div",{target:"e15560op2"})(({theme:t,disabled:e})=>({display:"flex",alignItems:"top",height:"100%",marginTop:`-${t.sizes.borderWidth}`,cursor:e?"not-allowed":"auto"})),ie=g("div",{target:"e15560op3"})(({disabled:t})=>({pointerEvents:t?"none":"auto"})),se=g("div",{target:"e15560op4"})(({theme:t})=>({marginTop:"0.625em",marginLeft:t.spacing.sm,height:t.spacing.xl,width:t.sizes.borderWidth,backgroundColor:t.colors.fadedText20})),le=g("div",{target:"e15560op5"})(({theme:t})=>({left:0,right:0,lineHeight:t.lineHeights.tight,paddingLeft:t.spacing.sm,paddingRight:t.spacing.sm,overflowX:"auto"})),de=g("div",{target:"e15560op6"})({display:"flex"}),ce=g("div",{target:"e15560op7"})({flex:"0 0 auto"}),ue=g("div",{target:"e15560op8"})(({theme:t})=>({display:"flex",alignItems:"center",padding:t.spacing.sm,gap:t.spacing.twoXS})),pe=g("div",{target:"e15560op9"})(({theme:t})=>({color:t.colors.fadedText60})),ge=g("div",{target:"e15560op10"})(({theme:t,fileStatus:e})=>({overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",color:e.type==="uploaded"?t.colors.bodyText:t.colors.fadedText60})),fe=g("div",{target:"e15560op11"})(({theme:t})=>({marginRight:t.spacing.md,color:t.colors.fadedText60})),he=g("small",{target:"e15560op12"})(({theme:t})=>({display:"flex",alignItems:"center",maxHeight:t.sizes.smallElementHeight,color:t.colors.fadedText60,"& :hover":{color:t.colors.bodyText}})),me=({getRootProps:t,getInputProps:e,acceptFile:n,disabled:l,theme:u})=>{const d=xt(e(),n);return z(ae,{disabled:l,children:[z(ie,{"data-testid":"stChatInputFileUploadButton",disabled:l,...t(),children:[a("input",{...d}),a(At,{content:`Upload or drag and drop ${It(n)}`,placement:ut.TOP,onMouseEnterDelay:500,children:a(pt,{kind:gt.MINIMAL,disabled:l,children:a(F,{content:yt,size:"lg",color:l?u.colors.fadedText40:u.colors.fadedText60})})})]}),a(se,{})]})},ye=o.memo(me),Ce=({getRootProps:t,getInputProps:e,acceptFile:n,inputHeight:l})=>{const u=xt(e(),n);return z($,{children:[a(re,{height:l,...t(),children:a("input",{...u})}),a(ne,{height:l,children:`Drag and drop ${It(n)} here`})]})},we=o.memo(Ce);function ve({children:t,content:e}){const n=G();return a(Lt,{content:e,placement:ut.TOP,overrides:{Body:{style:{top:`-${n.sizes.minElementHeight}`}}},children:t})}const be=({fileInfo:t})=>{const e=G(),{type:n}=t.status;switch(n){case"uploading":return a(ft,{"data-testid":"stChatInputFileIconSpinner",size:"lg",margin:"0",padding:"0"});case"error":return a(ve,{content:t.status.errorMessage,children:a(F,{color:e.colors.redTextColor,content:te,size:"lg"})});case"uploaded":return a(F,{content:Kt,size:"lg"});default:return ct(n),null}},xe=({fileInfo:t,onDelete:e})=>z(ue,{className:"stChatInputFile","data-testid":"stChatInputFile",children:[a(pe,{children:a(be,{fileInfo:t})}),a(ge,{className:"stChatInputFileName","data-testid":"stChatInputFileName",title:t.name,fileStatus:t.status,children:t.name}),a(fe,{children:Pt(t.size,j.Byte)}),a(he,{"data-testid":"stChatInputDeleteBtn",children:a(pt,{onClick:()=>e(t.id),kind:gt.MINIMAL,children:a(F,{content:Ot,size:"lg"})})})]}),Ie=o.memo(xe),Se=({items:t,onDelete:e})=>a(le,{"data-testid":"stChatUploadedFiles",children:a(de,{children:t.map(n=>a(ce,{children:a(Ie,{fileInfo:n,onDelete:e})},n.id))})}),Ee=o.memo(Se),ze=(t,e)=>{const n=[],l=[];return t.forEach(u=>{const d=oe(u,e.fileType);d.isValid?n.push(u):l.push({file:u,errors:[{code:ht.FileInvalidType,message:d.errorMessage||"File type not allowed."}]})}),{accepted:n,rejected:l}},Fe=({acceptMultipleFiles:t,acceptDirectoryFiles:e,maxFileSize:n,uploadClient:l,uploadFile:u,addFiles:d,getNextLocalFileId:C,deleteExistingFiles:v,onUploadComplete:E,element:y})=>(h,f)=>{if(e&&h.length>0){const{accepted:p,rejected:b}=ze(h,y);h=p,f=[...f,...b]}if(!t&&h.length===0&&f.length>1){const p=f.findIndex(b=>b.errors?.[0].code===ht.TooManyFiles);p>=0&&(h.push(f[p].file),f.splice(p,1))}if(!t&&h.length>0&&v(),l.fetchFileURLs(h).then(p=>{Vt(p,h).forEach(([b,W])=>{u(b,W)})}).catch(p=>{d(h.map(b=>new mt(b.name,b.size,C(),{type:"error",errorMessage:p})))}),f.length>0){const p=f.map(b=>Xt(b,C(),n));d(p)}E()},Ue=({getNextLocalFileId:t,addFiles:e,updateFile:n,uploadClient:l,element:u,onUploadProgress:d,onUploadComplete:C})=>(v,E)=>{const y=E.webkitRelativePath||E.name,h=new AbortController,f=new mt(y,E.size,t(),{type:"uploading",abortController:h,progress:1});e([f]),l.uploadFile({formId:"",...u},v.uploadUrl,E,p=>d(p,f.id),h.signal).then(()=>C(f.id,v)).catch(p=>{p instanceof DOMException&&p.name==="AbortError"||n(f.id,f.setStatus({type:"error",errorMessage:p?p.toString():"Unknown error"}))})},De=g("div",{target:"e1k7dgr10"})("border:none;position:relative;display:flex;"),Re=g("div",{target:"e1k7dgr11"})(({theme:t,extended:e})=>({border:`${t.sizes.borderWidth} solid`,borderColor:t.colors.widgetBorderColor??t.colors.transparent,borderRadius:t.radii.chatInput,backgroundColor:t.colors.secondaryBg,position:"relative",flexGrow:1,display:"flex",flexDirection:"row",flexWrap:"nowrap",alignItems:"center",paddingLeft:t.spacing.lg,maxHeight:e?"none":t.sizes.minElementHeight,gap:t.spacing.sm,overflow:"hidden",":focus-within":{borderColor:t.colors.primary}})),H=g("button",{target:"e1k7dgr12"})(({theme:t,disabled:e,extended:n})=>{const l=Mt(t),[u,d]=l?[t.colors.gray60,t.colors.gray80]:[t.colors.gray80,t.colors.gray40];return{border:"none",backgroundColor:t.colors.transparent,borderTopRightRadius:n?"0":t.radii.chatInput,borderTopLeftRadius:n?t.radii.default:"0",borderBottomRightRadius:t.radii.chatInput,display:"inline-flex",alignItems:"center",justifyContent:"center",lineHeight:t.lineHeights.none,margin:t.spacing.none,padding:t.spacing.sm,color:e?u:d,pointerEvents:"auto","&:focus":{outline:"none"},":focus":{outline:"none"},"&:focus-visible":{backgroundColor:l?t.colors.gray10:t.colors.gray90},"&:hover":{color:t.colors.primary},"&:disabled, &:disabled:hover, &:disabled:active":{backgroundColor:t.colors.transparent,borderColor:t.colors.transparent,color:t.colors.gray60,cursor:"not-allowed"}}}),ke=g("div",{target:"e1k7dgr13"})(({theme:t,isRecording:e})=>({display:"flex",alignItems:e?"center":"flex-end",height:"100%",position:e?"static":"absolute",right:e?void 0:0,bottom:e?void 0:0,marginBottom:e?0:`-${t.sizes.borderWidth}`,pointerEvents:"none",gap:0,paddingRight:e?t.spacing.sm:0})),Te=g("div",{target:"e1k7dgr14"})(({theme:t,acceptAudio:e})=>({position:"absolute",bottom:"0px",right:e?`calc(2 * (${t.iconSizes.xl} + 2 * ${t.spacing.sm}) + 2 * ${t.spacing.sm})`:`calc(${t.iconSizes.xl} + 2 * ${t.spacing.sm} + ${t.spacing.sm})`})),Be=g("div",{target:"e1k7dgr15"})(({isRecording:t})=>({display:t?"flex":"none",flex:t?1:void 0,alignItems:"center",minWidth:0})),Ae=g("div",{target:"e1k7dgr16"})(({theme:t})=>({position:"relative",width:"100%",minHeight:t.sizes.minElementHeight,borderRadius:t.radii.default,overflow:"hidden","& > div":{position:"absolute",inset:0}})),X=(t,e,n)=>n.map(l=>l.id===t?e:l),_=(t,e)=>e.find(n=>n.id===t);function Le({disabled:t,element:e,widgetMgr:n,fragmentId:l,uploadClient:u}){const d=G(),{placeholder:C,maxChars:v}=e,E=o.useRef(0),y=o.useRef(null),h=o.useRef(!1),f=o.useRef(null),p=o.useRef(null),{width:b,elementRef:W}=Ht(),{innerWidth:Y,innerHeight:q}=$t(),[D,N]=o.useState(e.default),[U,R]=o.useState([]),[k,P]=o.useState(!1),[L,J]=o.useState(!1),T=e.acceptAudio??!1;o.useEffect(()=>()=>{p.current&&p.current.abort()},[]);const x=Jt({textareaRef:y,dependencies:[C]}),V=o.useMemo(()=>U.some(r=>r.status.type==="uploading")?!1:D!==""||U.length>0,[U,D]),I=Wt(e.acceptFile),Q=_t(e.maxUploadSizeMb,j.Megabyte,j.Byte),Z=o.useCallback(r=>R(s=>[...s,...r]),[]),tt=o.useCallback(r=>{r.status.type==="uploading"&&r.status.abortController.abort(),r.status.type==="uploaded"&&r.status.fileUrls.deleteUrl&&u.deleteFile(r.status.fileUrls.deleteUrl).catch(s=>{dt.error("Failed to delete file from server",s)})},[u]),et=o.useCallback(r=>{R(s=>{const c=_(r,s);return K(c)?s:(tt(c),s.filter(i=>i.id!==r))})},[tt]),ot=o.useCallback(()=>{const r=U.filter(s=>s.status.type==="uploaded").map(s=>{const{name:c,size:i,status:S}=s,{fileId:O,fileUrls:Tt}=S;return new lt({fileId:O,fileUrls:Tt,name:c,size:i})});return new Nt({uploadedFileInfo:r})},[U]),rt=()=>E.current++,St=Fe({acceptMultipleFiles:I===w.Multiple||I===w.Directory,acceptDirectoryFiles:I===w.Directory,maxFileSize:Q,uploadClient:u,uploadFile:Ue({getNextLocalFileId:rt,addFiles:Z,updateFile:(r,s)=>{R(c=>X(r,s,c))},uploadClient:u,element:e,onUploadProgress:(r,s)=>{R(c=>{const i=_(s,c);if(K(i)||i.status.type!=="uploading")return c;const S=Math.round(r.loaded*100/r.total);return i.status.progress===S?c:X(s,i.setStatus({type:"uploading",abortController:i.status.abortController,progress:S}),c)})},onUploadComplete:(r,s)=>{R(c=>{const i=_(r,c);return K(i)||i.status.type!=="uploading"?c:X(i.id,i.setStatus({type:"uploaded",fileId:s.fileId,fileUrls:s}),c)})}}),addFiles:Z,getNextLocalFileId:rt,deleteExistingFiles:()=>U.forEach(r=>et(r.id)),onUploadComplete:()=>{y.current&&y.current.focus()},element:e}),{getRootProps:nt,getInputProps:at}=jt({onDrop:St,multiple:I===w.Multiple||I===w.Directory,accept:Gt(e.fileType),maxSize:Q}),M=o.useCallback(r=>{if(y.current&&y.current.focus(),!V&&!r||t)return;const s=ot(),c={data:D,fileUploaderState:s,audioFileInfo:r};n.setChatInputValue(e,c,{fromUi:!0},l),R([]),N(""),x.clearScrollHeight()},[V,t,D,ot,n,e,l,x]),it=o.useCallback(async r=>{const s=new Date().toISOString().replace(/[:.]/g,"-"),c=new File([r],`audio-${s}.wav`,{type:"audio/wav"});try{J(!0);const i=await u.fetchFileURLs([c]);if(i.length===0)throw new Error("Failed to get upload URL for audio file");const S=i[0];p.current=new AbortController,await u.uploadFile({formId:"",...e},S.uploadUrl,c,()=>{},p.current.signal);const O=new lt({fileId:S.fileId,fileUrls:S,name:c.name,size:c.size});M(O)}catch(i){dt.error("Audio upload failed:",i),y.current&&y.current.focus()}finally{J(!1)}},[u,e,M]),Et=o.useMemo(()=>({onApprove:it}),[it]),m=Yt({containerRef:f,events:Et}),st=o.useCallback(()=>{M()},[M]),zt=r=>{const{metaKey:s,ctrlKey:c,shiftKey:i}=r;Zt(r)&&!i&&!c&&!s&&(r.preventDefault(),st())},Ft=r=>{const{value:s}=r.target;v!==0&&s.length>v||(N(s),x.updateScrollHeight())},Ut=o.useCallback(async r=>{r.preventDefault(),r.stopPropagation(),!(!T||t||m.state==="recording")&&await m.start()},[T,t,m]),Dt=o.useCallback(()=>{m.cancel(),y.current&&y.current.focus()},[m]),Rt=o.useCallback(async()=>{const{blob:r}=await m.stop();await m.approve(r)},[m]);o.useEffect(()=>{if(e.setValue&&!h.current){h.current=!0;const r=e.value||"";N(r)}},[e.setValue,e.value]),o.useEffect(()=>{h.current=!1},[e]),o.useEffect(()=>{const r=i=>{i.preventDefault(),i.stopPropagation(),!k&&i.dataTransfer?.types.includes("Files")&&P(!0)},s=i=>{i.preventDefault(),i.stopPropagation(),k&&(i.clientX<=0&&i.clientY<=0||i.clientX>=Y&&i.clientY>=q)&&P(!1)},c=i=>{i.preventDefault(),i.stopPropagation(),k&&P(!1)};return window.addEventListener("dragover",r),window.addEventListener("drop",c),window.addEventListener("dragleave",s),()=>{window.removeEventListener("dragover",r),window.removeEventListener("drop",c),window.removeEventListener("dragleave",s)}},[k,Y,q]);const kt=I!==w.None&&k;return z($,{children:[I===w.None?null:a(Ee,{items:[...U],onDelete:et}),a(De,{className:"stChatInput","data-testid":"stChatInput",ref:W,children:kt?a(we,{getRootProps:nt,getInputProps:at,acceptFile:I,inputHeight:x.height}):z(Re,{extended:x.isExtended||m.state==="recording",children:[a(Be,{isRecording:m.state==="recording",children:a(Ae,{ref:f})}),I===w.None||m.state==="recording"?null:a(ye,{getRootProps:nt,getInputProps:at,acceptFile:I,disabled:t,theme:d}),m.state!=="recording"&&a(Qt,{inputRef:y,value:D,placeholder:C,onChange:Ft,onKeyDown:zt,"aria-label":C,disabled:t,rows:1,overrides:{Root:{style:{minHeight:d.sizes.minElementHeight,outline:"none",borderLeftWidth:"0",borderRightWidth:"0",borderTopWidth:"0",borderBottomWidth:"0",borderTopLeftRadius:"0",borderTopRightRadius:"0",borderBottomRightRadius:"0",borderBottomLeftRadius:"0"}},Input:{props:{"data-testid":"stChatInputTextArea"},style:{fontWeight:d.fontWeights.normal,lineHeight:d.lineHeights.inputWidget,"::placeholder":{color:d.colors.fadedText60},height:x.height,maxHeight:x.maxHeight,paddingLeft:d.spacing.none,paddingBottom:d.spacing.sm,paddingTop:d.spacing.sm,paddingRight:T?`calc(2 * (${d.iconSizes.xl} + 2 * ${d.spacing.sm}))`:`calc(${d.iconSizes.xl} + 2 * ${d.spacing.sm} + ${d.spacing.sm})`}}}}),m.state!=="recording"&&b>d.breakpoints.hideWidgetDetails&&a(Te,{acceptAudio:T,children:a(qt,{dirty:V,value:D,maxLength:v,type:"chat",inForm:!1})}),a(ke,{isRecording:m.state==="recording",children:m.state==="recording"?z($,{children:[a(H,{onClick:Dt,disabled:t,extended:x.isExtended,"data-testid":"stChatInputCancelButton",children:a(F,{content:wt,size:"lg",color:"inherit"})}),a(H,{onClick:()=>{Rt().catch(r=>{})},disabled:t||L,extended:x.isExtended,"data-testid":"stChatInputApproveButton",children:L?a(ft,{size:"lg",margin:"0",padding:"0"}):a(F,{content:Ct,size:"lg",color:"inherit"})})]}):z($,{children:[T&&a(H,{onClick:r=>{Ut(r).catch(s=>{})},disabled:t||L,extended:x.isExtended,"data-testid":"stChatInputMicButton",children:a(F,{content:vt,size:"xl",color:"inherit"})}),a(H,{onClick:st,disabled:!V||t||L,extended:x.isExtended,"data-testid":"stChatInputSubmitButton",children:a(F,{content:bt,size:"xl",color:"inherit"})})]})})]})})]})}const Xe=o.memo(Le);export{Xe as default};
