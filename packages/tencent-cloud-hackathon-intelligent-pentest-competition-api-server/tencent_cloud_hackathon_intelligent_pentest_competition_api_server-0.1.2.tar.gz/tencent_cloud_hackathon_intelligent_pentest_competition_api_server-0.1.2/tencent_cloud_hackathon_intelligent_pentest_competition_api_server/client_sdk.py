import os
from abc import ABC

import dotenv
import requests
import requests_ratelimiter

from tencent_cloud_hackathon_intelligent_pentest_competition_api_server.base import GetChallengeHintResponse
from tencent_cloud_hackathon_intelligent_pentest_competition_api_server.base import GetChallengesResponse
from tencent_cloud_hackathon_intelligent_pentest_competition_api_server.base import SubmitAnswerResponse

dotenv.load_dotenv()


class BaseClient(ABC):
    def __init__(self, base_url: str = 'http://localhost:8000', api_token: str = '00000000-0000-0000-0000-000000000000'):
        self.base_url = base_url
        self.session = requests_ratelimiter.LimiterSession(
            per_second=1,
            session=requests.Session(),
        )
        self.session.headers.update({'Authorization': f'Bearer {api_token}'})

    def get_challenges(self) -> GetChallengesResponse:
        raise NotImplementedError

    def get_challenge_hint(self, challenge_code: str) -> GetChallengeHintResponse:
        raise NotImplementedError

    def submit_answer(self, challenge_code: str, answer: str) -> SubmitAnswerResponse:
        raise NotImplementedError


class APIClient(BaseClient):
    def get_challenges(self) -> GetChallengesResponse:
        response = self.session.get(
            self.base_url + '/api/v1/challenges',
        )
        response.raise_for_status()
        return GetChallengesResponse.model_validate_json(response.text)

    def get_challenge_hint(self, challenge_code: str) -> GetChallengeHintResponse:
        response = self.session.get(
            self.base_url + f'/api/v1/hint/{challenge_code}',
        )
        response.raise_for_status()
        return GetChallengeHintResponse.model_validate_json(response.text)

    def submit_answer(self, challenge_code: str, answer: str) -> SubmitAnswerResponse:
        response = self.session.post(
            self.base_url + '/api/v1/answer',
            json={'challenge_code': challenge_code, 'answer': answer},
        )
        response.raise_for_status()
        return SubmitAnswerResponse.model_validate_json(response.text)

    @staticmethod
    def get_client():
        base_url = os.getenv('COMPETITION_BASE_URL') or 'http://localhost:8000'
        api_token = os.getenv(
            'COMPETITION_API_TOKEN',
        ) or '00000000-0000-0000-0000-000000000000'
        return APIClient(base_url=base_url, api_token=api_token)
