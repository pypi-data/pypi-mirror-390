metadata:
  name: kubernetes-security
  version: 1.0.0
  description: Kubernetes Security Best Practices Rule Pack for EKS, AKS, and GKE
  author: Riveter Team
  created: 2024-10-27
  updated: 2024-10-27
  dependencies: []
  tags: [security, kubernetes, containers, eks, aks, gke]
  min_riveter_version: 0.1.0

rules:
  # Pod Security Rules (8-10 rules)
  - id: k8s_no_privileged_containers
    resource_type: kubernetes_pod|kubernetes_deployment|kubernetes_daemonset|kubernetes_stateful_set
    description: Containers should not run in privileged mode
    severity: error
    assert:
      spec.containers.security_context.privileged: false
    metadata:
      tags: [kubernetes, pod-security, containers, privilege-escalation]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/concepts/security/pod-security-standards/

  - id: k8s_no_root_user
    resource_type: kubernetes_pod|kubernetes_deployment|kubernetes_daemonset|kubernetes_stateful_set
    description: Containers should not run as root user
    severity: error
    assert:
      spec.containers.security_context.run_as_user:
        ne: 0
      spec.containers.security_context.run_as_non_root: true
    metadata:
      tags: [kubernetes, pod-security, containers, user-permissions]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/tasks/configure-pod-container/security-context/

  - id: k8s_readonly_root_filesystem
    resource_type: kubernetes_pod|kubernetes_deployment|kubernetes_daemonset|kubernetes_stateful_set
    description: Containers should use read-only root filesystem
    severity: warning
    assert:
      spec.containers.security_context.read_only_root_filesystem: true
    metadata:
      tags: [kubernetes, pod-security, containers, filesystem]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/tasks/configure-pod-container/security-context/

  - id: k8s_no_privilege_escalation
    resource_type: kubernetes_pod|kubernetes_deployment|kubernetes_daemonset|kubernetes_stateful_set
    description: Containers should not allow privilege escalation
    severity: error
    assert:
      spec.containers.security_context.allow_privilege_escalation: false
    metadata:
      tags: [kubernetes, pod-security, containers, privilege-escalation]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/concepts/security/pod-security-standards/

  - id: k8s_drop_capabilities
    resource_type: kubernetes_pod|kubernetes_deployment|kubernetes_daemonset|kubernetes_stateful_set
    description: Containers should drop all capabilities and only add required ones
    severity: warning
    assert:
      spec.containers.security_context.capabilities.drop:
        contains: ALL
    metadata:
      tags: [kubernetes, pod-security, containers, capabilities]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/tasks/configure-pod-container/security-context/

  - id: k8s_resource_limits
    resource_type: kubernetes_pod|kubernetes_deployment|kubernetes_daemonset|kubernetes_stateful_set
    description: Containers should have resource limits defined
    severity: warning
    assert:
      spec.containers.resources.limits.memory: present
      spec.containers.resources.limits.cpu: present
    metadata:
      tags: [kubernetes, pod-security, containers, resource-management]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/

  - id: k8s_resource_requests
    resource_type: kubernetes_pod|kubernetes_deployment|kubernetes_daemonset|kubernetes_stateful_set
    description: Containers should have resource requests defined
    severity: warning
    assert:
      spec.containers.resources.requests.memory: present
      spec.containers.resources.requests.cpu: present
    metadata:
      tags: [kubernetes, pod-security, containers, resource-management]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/

  - id: k8s_no_host_network
    resource_type: kubernetes_pod|kubernetes_deployment|kubernetes_daemonset|kubernetes_stateful_set
    description: Pods should not use host network
    severity: error
    assert:
      spec.host_network: false
    metadata:
      tags: [kubernetes, pod-security, network-isolation]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/concepts/security/pod-security-standards/

  - id: k8s_no_host_pid
    resource_type: kubernetes_pod|kubernetes_deployment|kubernetes_daemonset|kubernetes_stateful_set
    description: Pods should not use host PID namespace
    severity: error
    assert:
      spec.host_pid: false
    metadata:
      tags: [kubernetes, pod-security, process-isolation]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/concepts/security/pod-security-standards/

  - id: k8s_no_host_ipc
    resource_type: kubernetes_pod|kubernetes_deployment|kubernetes_daemonset|kubernetes_stateful_set
    description: Pods should not use host IPC namespace
    severity: error
    assert:
      spec.host_ipc: false
    metadata:
      tags: [kubernetes, pod-security, ipc-isolation]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/concepts/security/pod-security-standards/

  # RBAC Rules (6-8 rules)
  - id: k8s_rbac_no_wildcard_verbs
    resource_type: kubernetes_role|kubernetes_cluster_role
    description: RBAC roles should not use wildcard verbs
    severity: error
    assert:
      rule.verbs:
        not_contains: "*"
    metadata:
      tags: [kubernetes, rbac, access-control, least-privilege]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/reference/access-authn-authz/rbac/

  - id: k8s_rbac_no_wildcard_resources
    resource_type: kubernetes_role|kubernetes_cluster_role
    description: RBAC roles should not use wildcard resources
    severity: error
    assert:
      rule.resources:
        not_contains: "*"
    metadata:
      tags: [kubernetes, rbac, access-control, least-privilege]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/reference/access-authn-authz/rbac/

  - id: k8s_rbac_no_cluster_admin
    resource_type: kubernetes_cluster_role_binding
    description: Avoid binding to cluster-admin role except for break-glass scenarios
    severity: warning
    assert:
      role_ref.name:
        ne: cluster-admin
    metadata:
      tags: [kubernetes, rbac, access-control, privilege-escalation]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/reference/access-authn-authz/rbac/

  - id: k8s_service_account_automount_token
    resource_type: kubernetes_service_account
    description: Service accounts should explicitly configure token automounting
    severity: warning
    assert:
      automount_service_account_token: present
    metadata:
      tags: [kubernetes, rbac, service-accounts, token-security]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/

  - id: k8s_rbac_binding_subjects_defined
    resource_type: kubernetes_role_binding|kubernetes_cluster_role_binding
    description: RBAC bindings should have subjects explicitly defined
    severity: error
    assert:
      subject:
        length:
          gte: 1
    metadata:
      tags: [kubernetes, rbac, access-control]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/reference/access-authn-authz/rbac/

  - id: k8s_rbac_no_system_masters
    resource_type: kubernetes_cluster_role_binding
    description: Avoid binding users to system:masters group
    severity: error
    assert:
      subject.name:
        ne: system:masters
    metadata:
      tags: [kubernetes, rbac, access-control, system-accounts]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/reference/access-authn-authz/rbac/

  - id: k8s_rbac_namespace_scoped_preferred
    resource_type: kubernetes_role_binding
    description: Use namespace-scoped roles when possible instead of cluster roles
    severity: info
    assert:
      role_ref.kind: Role
    metadata:
      tags: [kubernetes, rbac, access-control, namespace-isolation]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/reference/access-authn-authz/rbac/

  - id: k8s_rbac_service_account_namespace
    resource_type: kubernetes_service_account
    description: Service accounts should be created in appropriate namespaces
    severity: warning
    assert:
      metadata.namespace:
        ne: default
    metadata:
      tags: [kubernetes, rbac, service-accounts, namespace-isolation]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/

  # Network Policy Rules (6-8 rules)
  - id: k8s_network_policy_default_deny_ingress
    resource_type: kubernetes_network_policy
    description: Namespaces should have default deny ingress network policies
    severity: warning
    assert:
      spec.policy_types:
        contains: Ingress
      spec.ingress:
        length:
          eq: 0
    metadata:
      tags: [kubernetes, network-policy, segmentation, default-deny]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/concepts/services-networking/network-policies/

  - id: k8s_network_policy_default_deny_egress
    resource_type: kubernetes_network_policy
    description: Namespaces should have default deny egress network policies
    severity: warning
    assert:
      spec.policy_types:
        contains: Egress
      spec.egress:
        length:
          eq: 0
    metadata:
      tags: [kubernetes, network-policy, segmentation, default-deny]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/concepts/services-networking/network-policies/

  - id: k8s_network_policy_pod_selector
    resource_type: kubernetes_network_policy
    description: Network policies should have specific pod selectors
    severity: warning
    assert:
      spec.pod_selector: present
    metadata:
      tags: [kubernetes, network-policy, segmentation, pod-selection]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/concepts/services-networking/network-policies/

  - id: k8s_network_policy_ingress_rules
    resource_type: kubernetes_network_policy
    description: Network policies with ingress should define specific rules
    severity: info
    filter:
      spec.policy_types:
        contains: Ingress
    assert:
      spec.ingress.from: present
    metadata:
      tags: [kubernetes, network-policy, ingress-control]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/concepts/services-networking/network-policies/

  - id: k8s_network_policy_egress_rules
    resource_type: kubernetes_network_policy
    description: Network policies with egress should define specific rules
    severity: info
    filter:
      spec.policy_types:
        contains: Egress
    assert:
      spec.egress.to: present
    metadata:
      tags: [kubernetes, network-policy, egress-control]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/concepts/services-networking/network-policies/

  - id: k8s_network_policy_namespace_isolation
    resource_type: kubernetes_network_policy
    description: Network policies should implement namespace isolation
    severity: info
    assert:
      spec.ingress.from.namespace_selector: present
    metadata:
      tags: [kubernetes, network-policy, namespace-isolation]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/concepts/services-networking/network-policies/

  - id: k8s_service_no_node_port
    resource_type: kubernetes_service
    description: Services should not use NodePort type in production
    severity: warning
    filter:
      metadata.labels.environment: production
    assert:
      spec.type:
        ne: NodePort
    metadata:
      tags: [kubernetes, network-policy, service-exposure]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/concepts/services-networking/service/

  - id: k8s_ingress_tls_required
    resource_type: kubernetes_ingress
    description: Ingress resources should use TLS
    severity: error
    assert:
      spec.tls: present
    metadata:
      tags: [kubernetes, network-policy, ingress, tls]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/concepts/services-networking/ingress/

  # Secrets Management Rules (5-7 rules)
  - id: k8s_secret_not_in_env_vars
    resource_type: kubernetes_pod|kubernetes_deployment|kubernetes_daemonset|kubernetes_stateful_set
    description: Secrets should not be exposed as environment variables
    severity: warning
    assert:
      spec.containers.env.value_from.secret_key_ref: absent
    metadata:
      tags: [kubernetes, secrets-management, environment-variables]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/concepts/configuration/secret/

  - id: k8s_secret_volume_mount_preferred
    resource_type: kubernetes_pod|kubernetes_deployment|kubernetes_daemonset|kubernetes_stateful_set
    description: Secrets should be mounted as volumes instead of environment variables
    severity: info
    filter:
      spec.volumes.secret: present
    assert:
      spec.containers.volume_mounts: present
    metadata:
      tags: [kubernetes, secrets-management, volume-mounts]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/concepts/configuration/secret/

  - id: k8s_secret_encryption_at_rest
    resource_type: kubernetes_secret
    description: Secrets should be encrypted at rest (cluster-level configuration)
    severity: info
    assert:
      metadata.annotations."encryption.alpha.kubernetes.io/encrypted": "true"
    metadata:
      tags: [kubernetes, secrets-management, encryption-at-rest]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/

  - id: k8s_no_hardcoded_secrets
    resource_type: kubernetes_pod|kubernetes_deployment|kubernetes_daemonset|kubernetes_stateful_set
    description: Containers should not have hardcoded secrets in environment variables
    severity: error
    assert:
      spec.containers.env.value:
        regex: "^(?!.*(?:password|secret|key|token|credential)=.+).*$"
    metadata:
      tags: [kubernetes, secrets-management, hardcoded-secrets]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/concepts/configuration/secret/

  - id: k8s_secret_immutable
    resource_type: kubernetes_secret
    description: Secrets should be marked as immutable when possible
    severity: info
    assert:
      immutable: true
    metadata:
      tags: [kubernetes, secrets-management, immutability]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/concepts/configuration/secret/

  - id: k8s_external_secrets_preferred
    resource_type: kubernetes_secret
    description: Consider using external secret management systems
    severity: info
    assert:
      metadata.annotations."external-secrets.io/managed-by": present
    metadata:
      tags: [kubernetes, secrets-management, external-secrets]
      providers: [eks, aks, gke]
      references:
        - https://external-secrets.io/

  - id: k8s_secret_rotation_annotation
    resource_type: kubernetes_secret
    description: Secrets should have rotation metadata
    severity: info
    assert:
      metadata.annotations."secret.kubernetes.io/rotation-time": present
    metadata:
      tags: [kubernetes, secrets-management, rotation]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/concepts/configuration/secret/

  # Image Security Rules (5-7 rules)
  - id: k8s_image_pull_policy_always
    resource_type: kubernetes_pod|kubernetes_deployment|kubernetes_daemonset|kubernetes_stateful_set
    description: Containers should use 'Always' image pull policy for latest tags
    severity: warning
    filter:
      spec.containers.image:
        regex: ".*:latest$"
    assert:
      spec.containers.image_pull_policy: Always
    metadata:
      tags: [kubernetes, image-security, pull-policy]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/concepts/containers/images/

  - id: k8s_no_latest_image_tag
    resource_type: kubernetes_pod|kubernetes_deployment|kubernetes_daemonset|kubernetes_stateful_set
    description: Containers should not use 'latest' image tag in production
    severity: error
    filter:
      metadata.labels.environment: production
    assert:
      spec.containers.image:
        regex: "^(?!.*:latest$).*$"
    metadata:
      tags: [kubernetes, image-security, image-tags]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/concepts/containers/images/

  - id: k8s_trusted_registry_only
    resource_type: kubernetes_pod|kubernetes_deployment|kubernetes_daemonset|kubernetes_stateful_set
    description: Containers should use images from trusted registries only
    severity: error
    assert:
      spec.containers.image:
        regex: "^(gcr\\.io|[a-zA-Z0-9-]+\\.azurecr\\.io|[0-9]+\\.dkr\\.ecr\\.[a-z0-9-]+\\.amazonaws\\.com|quay\\.io|registry\\.k8s\\.io)/"
    metadata:
      tags: [kubernetes, image-security, trusted-registries]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/concepts/containers/images/

  - id: k8s_image_vulnerability_scanning
    resource_type: kubernetes_pod|kubernetes_deployment|kubernetes_daemonset|kubernetes_stateful_set
    description: Container images should be scanned for vulnerabilities
    severity: warning
    assert:
      metadata.annotations."security.alpha.kubernetes.io/vulnerability-scan": "passed"
    metadata:
      tags: [kubernetes, image-security, vulnerability-scanning]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/concepts/security/

  - id: k8s_image_signature_verification
    resource_type: kubernetes_pod|kubernetes_deployment|kubernetes_daemonset|kubernetes_stateful_set
    description: Container images should be signed and verified
    severity: info
    assert:
      metadata.annotations."cosign.sigstore.dev/signature": present
    metadata:
      tags: [kubernetes, image-security, image-signing]
      providers: [eks, aks, gke]
      references:
        - https://docs.sigstore.dev/cosign/overview/

  - id: k8s_admission_controller_image_policy
    resource_type: kubernetes_validating_admission_webhook|kubernetes_mutating_admission_webhook
    description: Admission controllers should enforce image policies
    severity: info
    assert:
      webhook.admission_review_versions:
        contains: v1
    metadata:
      tags: [kubernetes, image-security, admission-control]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/

  - id: k8s_runtime_security_monitoring
    resource_type: kubernetes_pod|kubernetes_deployment|kubernetes_daemonset|kubernetes_stateful_set
    description: Containers should have runtime security monitoring enabled
    severity: info
    assert:
      metadata.annotations."security.kubernetes.io/runtime-monitoring": "enabled"
    metadata:
      tags: [kubernetes, image-security, runtime-security]
      providers: [eks, aks, gke]
      references:
        - https://kubernetes.io/docs/concepts/security/
