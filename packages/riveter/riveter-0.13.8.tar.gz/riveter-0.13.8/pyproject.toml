[build-system]
requires = [
    "hatchling",
]
build-backend = "hatchling.build"

[project]
name = "riveter"
version = "0.13.8"
authors = [
    { name = "Riveter Team" },
]
description = "Infrastructure Drift Detection as Code - Define custom drift detection rules"
readme = "README.md"
requires-python = ">=3.12"
classifiers = [
    "Development Status :: 4 - Beta",
    "Environment :: Console",
    "Intended Audience :: Developers",
    "Intended Audience :: System Administrators",
    "Topic :: System :: Systems Administration",
    "Topic :: Software Development :: Testing",
]
dependencies = [
    "pyyaml>=6.0",
    "click>=8.0",
    "rich>=13.0",
    "python-hcl2>=4.0",
    "cryptography>=41.0",
    "requests>=2.25.0",
]

[project.optional-dependencies]
dev = [
    "black>=24.0",
    "isort>=5.13",
    "ruff>=0.8.0",
    "mypy>=1.13",
    "types-PyYAML>=6.0",
    "types-requests>=2.25.0",
    "bandit>=1.7.10",
    "safety>=3.0.0",
    "pre-commit>=3.0.0",
    "tox>=4.0.0",
    "coverage[toml]>=7.0",
    "build>=1.0.0",
    "twine>=4.0.0",
    "pyinstaller>=6.0.0",
    "tomli-w>=1.0.0",
    "importlib_metadata>=6.0",
    "sphinx>=7.0.0",
    "sphinx-rtd-theme>=2.0.0",
]
lint = [
    "black>=24.0",
    "isort>=5.13",
    "ruff>=0.8.0",
    "mypy>=1.13",
    "bandit>=1.7.10",
    "pre-commit>=3.0.0",
]
docs = [
    "sphinx>=7.0.0",
    "sphinx-rtd-theme>=2.0.0",
]

[project.scripts]
riveter = "riveter.cli_fast:main"

[tool.black]
line-length = 100
target-version = [
    "py312",
]
include = "\\.pyi?$"
extend-exclude = "/(\n  # directories\n  \\.eggs\n  | \\.git\n  | \\.hg\n  | \\.mypy_cache\n  | \\.tox\n  | \\.venv\n  | _build\n  | buck-out\n  | build\n  | dist\n  | venv\n)/\n"

[tool.isort]
profile = "black"
line_length = 100
multi_line_output = 3
include_trailing_comma = true
force_grid_wrap = 0
use_parentheses = true
ensure_newline_before_comments = true
src_paths = [
    "src",
    "tests",
]
known_first_party = [
    "riveter",
]
sections = [
    "FUTURE",
    "STDLIB",
    "THIRDPARTY",
    "FIRSTPARTY",
    "LOCALFOLDER",
]

[tool.mypy]
strict = true
python_version = "3.12"
warn_return_any = true
warn_unused_configs = true
warn_redundant_casts = true
warn_unused_ignores = true
warn_no_return = true
warn_unreachable = true
strict_optional = true
strict_equality = true
no_implicit_reexport = true
disallow_untyped_defs = true
disallow_incomplete_defs = true
disallow_untyped_decorators = true
disallow_any_generics = true
disallow_subclassing_any = true
check_untyped_defs = true
ignore_missing_imports = false
show_error_codes = true
show_column_numbers = true
pretty = true

[[tool.mypy.overrides]]
module = "importlib_metadata"
ignore_missing_imports = true

[[tool.mypy.overrides]]
module = "hcl2"
ignore_missing_imports = true

[[tool.mypy.overrides]]
module = "tomli_w"
ignore_missing_imports = true

[[tool.mypy.overrides]]
module = "cryptography.*"
ignore_missing_imports = true

[[tool.mypy.overrides]]
module = "yaml"
ignore_missing_imports = true

[[tool.mypy.overrides]]
module = "riveter.toml_handler"
disable_error_code = [
    "assignment",
]

[[tool.mypy.overrides]]
module = "riveter.cli"
disable_error_code = [
    "misc",
]

[tool.ruff]
line-length = 100
target-version = "py312"
src = [
    "src",
    "tests",
]
extend-exclude = [
    ".bzr",
    ".direnv",
    ".eggs",
    ".git",
    ".git-rewrite",
    ".hg",
    ".mypy_cache",
    ".nox",
    ".pants.d",
    ".pytype",
    ".ruff_cache",
    ".svn",
    ".tox",
    ".venv",
    "__pypackages__",
    "_build",
    "buck-out",
    "build",
    "dist",
    "node_modules",
    "venv",
]

[tool.ruff.lint]
select = [
    "E",
    "W",
    "F",
    "B",
    "C4",
    "I",
    "N",
    "UP",
    "YTT",
    "ANN",
    "S",
    "BLE",
    "FBT",
    "A",
    "COM",
    "C90",
    "DTZ",
    "T10",
    "DJ",
    "EM",
    "EXE",
    "FA",
    "ISC",
    "ICN",
    "G",
    "INP",
    "PIE",
    "T20",
    "PYI",
    "PT",
    "Q",
    "RSE",
    "RET",
    "SLF",
    "SLOT",
    "SIM",
    "TID",
    "TCH",
    "INT",
    "ARG",
    "PTH",
    "ERA",
    "PD",
    "PGH",
    "PL",
    "TRY",
    "FLY",
    "NPY",
    "PERF",
    "FURB",
    "LOG",
    "RUF",
]
ignore = [
    "ANN101",
    "ANN102",
    "ANN401",
    "S101",
    "S603",
    "S607",
    "COM812",
    "ISC001",
    "FBT001",
    "FBT002",
    "PLR0913",
    "PLR2004",
    "TRY003",
    "EM101",
    "EM102",
]
fixable = [
    "ALL",
]
unfixable = []
dummy-variable-rgx = "^(_+|(_+[a-zA-Z0-9_]*[a-zA-Z0-9]+?))$"

[tool.ruff.lint.per-file-ignores]
"tests/**/*.py" = [
    "S101",
    "PLR2004",
    "ANN",
    "ARG",
    "FBT",
]
"**/cli*.py" = [
    "PLR0913",
    "C901",
]
"**/legacy_*.py" = [
    "ANN",
    "UP",
]

[tool.ruff.lint.mccabe]
max-complexity = 10

[tool.ruff.lint.pylint]
max-args = 8
max-branches = 12
max-returns = 6
max-statements = 50

[tool.ruff.lint.flake8-annotations]
allow-star-arg-any = true
ignore-fully-untyped = true

[tool.ruff.lint.flake8-bandit]
check-typed-exception = true

[tool.ruff.lint.flake8-bugbear]
extend-immutable-calls = [
    "fastapi.Depends",
    "fastapi.Query",
]

[tool.ruff.lint.flake8-type-checking]
strict = true

[tool.bandit]
exclude_dirs = [
    "tests",
    "venv",
    ".venv",
    "build",
    "dist",
]
skips = [
    "B101",
    "B601",
]

[tool.bandit.assert_used]
skips = [
    "*_test.py",
    "test_*.py",
]

[tool.tox]
legacy_tox_ini = "[tox]\nenvlist = py312, lint, type, security\nisolated_build = true\n\n[testenv]\ndeps = \n    pytest>=7.0\n    pytest-cov>=4.0\n    pytest-xdist>=3.0\ncommands = pytest {posargs}\n\n[testenv:lint]\ndeps = \n    black>=24.0\n    isort>=5.13\n    ruff>=0.8.0\ncommands = \n    black --check --diff src tests\n    isort --check-only --diff src tests\n    ruff check src tests\n\n[testenv:type]\ndeps = \n    mypy>=1.13\n    types-PyYAML>=6.0\n    types-requests>=2.25.0\ncommands = mypy src\n\n[testenv:security]\ndeps = bandit>=1.7.10\ncommands = bandit -r src/\n"

[tool.build]
exclude = [
    "tests/",
    "docs/",
    "*.pyc",
    "*.pyo",
    "*~",
    "__pycache__/",
    ".git/",
    ".pytest_cache/",
    ".mypy_cache/",
    ".ruff_cache/",
    "htmlcov/",
]
