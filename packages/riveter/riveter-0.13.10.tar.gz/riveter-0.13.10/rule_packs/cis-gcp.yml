metadata:
  name: cis-gcp
  version: 1.0.0
  description: CIS Google Cloud Platform Foundation Benchmark v1.3.0 Rule Pack
  author: Riveter Team
  created: 2024-10-27
  updated: 2024-10-27
  dependencies: []
  tags: [compliance, cis, gcp, benchmark]
  min_riveter_version: 0.1.0

rules:
  # ============================================================================
  # Section 1: Identity and Access Management
  # ============================================================================

  - id: cis_gcp_1_1_service_account_admin_privileges
    resource_type: google_project_iam_binding
    description: "CIS 1.1 - Ensure that corporate login credentials are used"
    severity: error
    assert:
      role:
        regex: "^(?!roles/owner|roles/editor).*$"
    metadata:
      tags: [cis, iam, admin-privileges]
      cis_control: "1.1"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_1_2_service_account_user_managed_keys
    resource_type: google_service_account_key
    description: "CIS 1.2 - Ensure that multi-factor authentication is enabled for all non-service accounts"
    severity: error
    assert:
      key_algorithm: present
    metadata:
      tags: [cis, iam, service-accounts]
      cis_control: "1.2"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_1_3_service_account_keys_rotated
    resource_type: google_service_account_key
    description: "CIS 1.3 - Ensure that Service Account has no Admin privileges"
    severity: error
    assert:
      valid_after: present
    metadata:
      tags: [cis, iam, key-rotation]
      cis_control: "1.3"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_1_4_separation_of_duties
    resource_type: google_project_iam_binding
    description: "CIS 1.4 - Ensure that there are only GCP-managed service account keys for each service account"
    severity: error
    assert:
      role:
        regex: "^(?!roles/iam\\.serviceAccountAdmin|roles/iam\\.serviceAccountKeyAdmin).*$"
    metadata:
      tags: [cis, iam, separation-of-duties]
      cis_control: "1.4"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_1_5_service_account_no_user_managed_keys
    resource_type: google_service_account_key
    description: "CIS 1.5 - Ensure that Service Account has no user-managed keys"
    severity: error
    assert:
      key_algorithm:
        regex: "^KEY_ALG_RSA_"
    metadata:
      tags: [cis, iam, service-account-keys]
      cis_control: "1.5"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_1_6_api_keys_not_created
    resource_type: google_apikeys_key
    description: "CIS 1.6 - Ensure API keys are not created for a project"
    severity: warning
    assert:
      name:
        regex: "^$"
    metadata:
      tags: [cis, iam, api-keys]
      cis_control: "1.6"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_1_7_api_keys_restricted
    resource_type: google_apikeys_key
    description: "CIS 1.7 - Ensure API keys are restricted to use by only specified Hosts and Apps"
    severity: error
    assert:
      restrictions: present
    metadata:
      tags: [cis, iam, api-keys]
      cis_control: "1.7"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_1_8_api_keys_restricted_apis
    resource_type: google_apikeys_key
    description: "CIS 1.8 - Ensure API keys are restricted to only APIs that application needs access"
    severity: error
    assert:
      restrictions.api_targets: present
    metadata:
      tags: [cis, iam, api-keys]
      cis_control: "1.8"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_1_9_api_keys_rotated
    resource_type: google_apikeys_key
    description: "CIS 1.9 - Ensure API keys are rotated every 90 days"
    severity: warning
    assert:
      create_time: present
    metadata:
      tags: [cis, iam, api-keys, rotation]
      cis_control: "1.9"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_1_10_kms_separation_of_duties
    resource_type: google_project_iam_binding
    description: "CIS 1.10 - Ensure KMS encryption keys are rotated within a period of 90 days"
    severity: error
    filter:
      role: roles/cloudkms.admin
    assert:
      members:
        length:
          lte: 3
    metadata:
      tags: [cis, iam, kms, separation-of-duties]
      cis_control: "1.10"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_1_11_kms_no_public_access
    resource_type: google_kms_crypto_key_iam_binding
    description: "CIS 1.11 - Ensure that Separation of duties is enforced while assigning KMS related roles to users"
    severity: error
    assert:
      members:
        regex: "^(?!.*allUsers|.*allAuthenticatedUsers).*$"
    metadata:
      tags: [cis, iam, kms, public-access]
      cis_control: "1.11"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_1_12_no_primitive_roles_org
    resource_type: google_organization_iam_binding
    description: "CIS 1.12 - Ensure that Cloud KMS cryptokeys are not anonymously or publicly accessible"
    severity: error
    assert:
      role:
        regex: "^(?!roles/owner|roles/editor|roles/viewer).*$"
    metadata:
      tags: [cis, iam, primitive-roles]
      cis_control: "1.12"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  # ============================================================================
  # Section 2: Logging and Monitoring
  # ============================================================================

  - id: cis_gcp_2_1_log_metric_audit_config_changes
    resource_type: google_logging_metric
    description: "CIS 2.1 - Ensure that Cloud Audit Logging is configured properly across all services and all users from a project"
    severity: error
    filter:
      name: audit-config-changes
    assert:
      filter: present
    metadata:
      tags: [cis, logging, audit-config]
      cis_control: "2.1"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_2_2_log_metric_custom_role_changes
    resource_type: google_logging_metric
    description: "CIS 2.2 - Ensure that sinks are configured for all log entries"
    severity: error
    filter:
      name: custom-role-changes
    assert:
      filter: present
    metadata:
      tags: [cis, logging, custom-roles]
      cis_control: "2.2"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_2_3_log_bucket_retention
    resource_type: google_logging_project_bucket_config
    description: "CIS 2.3 - Ensure that retention policies on log buckets are configured using Bucket Lock"
    severity: error
    assert:
      retention_days:
        gte: 90
      locked: true
    metadata:
      tags: [cis, logging, retention]
      cis_control: "2.3"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_2_4_log_sink_configured
    resource_type: google_logging_project_sink
    description: "CIS 2.4 - Ensure log metric filter and alerts exist for project ownership assignments/changes"
    severity: error
    assert:
      destination: present
      filter: present
    metadata:
      tags: [cis, logging, log-sink]
      cis_control: "2.4"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_2_5_log_metric_network_changes
    resource_type: google_logging_metric
    description: "CIS 2.5 - Ensure that the log metric filter and alerts exist for Audit Configuration changes"
    severity: error
    filter:
      name: network-changes
    assert:
      filter: present
    metadata:
      tags: [cis, logging, network-changes]
      cis_control: "2.5"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_2_6_log_metric_storage_iam_changes
    resource_type: google_logging_metric
    description: "CIS 2.6 - Ensure that the log metric filter and alerts exist for Custom Role changes"
    severity: error
    filter:
      name: storage-iam-changes
    assert:
      filter: present
    metadata:
      tags: [cis, logging, storage-iam]
      cis_control: "2.6"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_2_7_log_metric_sql_instance_changes
    resource_type: google_logging_metric
    description: "CIS 2.7 - Ensure that the log metric filter and alerts exist for VPC Network Firewall rule changes"
    severity: error
    filter:
      name: sql-instance-changes
    assert:
      filter: present
    metadata:
      tags: [cis, logging, sql-changes]
      cis_control: "2.7"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_2_8_log_metric_vpc_route_changes
    resource_type: google_logging_metric
    description: "CIS 2.8 - Ensure that the log metric filter and alerts exist for VPC network route changes"
    severity: error
    filter:
      name: vpc-route-changes
    assert:
      filter: present
    metadata:
      tags: [cis, logging, vpc-routes]
      cis_control: "2.8"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_2_9_log_metric_vpc_network_changes
    resource_type: google_logging_metric
    description: "CIS 2.9 - Ensure that the log metric filter and alerts exist for VPC network changes"
    severity: error
    filter:
      name: vpc-network-changes
    assert:
      filter: present
    metadata:
      tags: [cis, logging, vpc-network]
      cis_control: "2.9"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_2_10_log_metric_storage_bucket_iam
    resource_type: google_logging_metric
    description: "CIS 2.10 - Ensure that the log metric filter and alerts exist for Cloud Storage IAM permission changes"
    severity: error
    filter:
      name: storage-bucket-iam-changes
    assert:
      filter: present
    metadata:
      tags: [cis, logging, storage-iam]
      cis_control: "2.10"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  # ============================================================================
  # Section 3: Networking
  # ============================================================================

  - id: cis_gcp_3_1_default_network_deleted
    resource_type: google_compute_network
    description: "CIS 3.1 - Ensure that the default network does not exist in a project"
    severity: error
    assert:
      name:
        ne: default
    metadata:
      tags: [cis, networking, default-network]
      cis_control: "3.1"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_3_2_legacy_networks_not_used
    resource_type: google_compute_network
    description: "CIS 3.2 - Ensure legacy networks do not exist for a project"
    severity: error
    assert:
      auto_create_subnetworks: false
    metadata:
      tags: [cis, networking, legacy-networks]
      cis_control: "3.2"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_3_3_dnssec_enabled
    resource_type: google_dns_managed_zone
    description: "CIS 3.3 - Ensure that DNSSEC is enabled for Cloud DNS"
    severity: error
    assert:
      dnssec_config.state: on
    metadata:
      tags: [cis, networking, dnssec]
      cis_control: "3.3"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_3_4_dnssec_rsasha1_not_used
    resource_type: google_dns_managed_zone
    description: "CIS 3.4 - Ensure that RSASHA1 is not used for the key-signing key in Cloud DNS DNSSEC"
    severity: error
    assert:
      dnssec_config.default_key_specs:
        subset:
          - algorithm:
              ne: rsasha1
            key_type: keySigning
    metadata:
      tags: [cis, networking, dnssec, rsasha1]
      cis_control: "3.4"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_3_5_dnssec_rsasha1_zone_signing
    resource_type: google_dns_managed_zone
    description: "CIS 3.5 - Ensure that RSASHA1 is not used for the zone-signing key in Cloud DNS DNSSEC"
    severity: error
    assert:
      dnssec_config.default_key_specs:
        subset:
          - algorithm:
              ne: rsasha1
            key_type: zoneSigning
    metadata:
      tags: [cis, networking, dnssec, rsasha1]
      cis_control: "3.5"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_3_6_ssh_not_open_to_world
    resource_type: google_compute_firewall
    description: "CIS 3.6 - Ensure that SSH access is restricted from the internet"
    severity: error
    filter:
      direction: INGRESS
    assert:
      allow:
        subset:
          - ports:
              regex: "^(?!22).*$"
            source_ranges:
              contains: "0.0.0.0/0"
    metadata:
      tags: [cis, networking, ssh, firewall]
      cis_control: "3.6"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_3_7_rdp_not_open_to_world
    resource_type: google_compute_firewall
    description: "CIS 3.7 - Ensure that RDP access is restricted from the internet"
    severity: error
    filter:
      direction: INGRESS
    assert:
      allow:
        subset:
          - ports:
              regex: "^(?!3389).*$"
            source_ranges:
              contains: "0.0.0.0/0"
    metadata:
      tags: [cis, networking, rdp, firewall]
      cis_control: "3.7"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_3_8_vpc_flow_logs_enabled
    resource_type: google_compute_subnetwork
    description: "CIS 3.8 - Ensure that VPC Flow Logs is enabled for every subnet in a VPC Network"
    severity: error
    assert:
      log_config.enable: true
    metadata:
      tags: [cis, networking, vpc-flow-logs]
      cis_control: "3.8"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  # ============================================================================
  # Section 4: Virtual Machines
  # ============================================================================

  - id: cis_gcp_4_1_oslogin_enabled
    resource_type: google_compute_project_metadata
    description: "CIS 4.1 - Ensure that instances are not configured to use the default service account"
    severity: error
    assert:
      metadata.enable-oslogin: "TRUE"
    metadata:
      tags: [cis, compute, oslogin]
      cis_control: "4.1"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_4_2_oslogin_2fa
    resource_type: google_compute_project_metadata
    description: "CIS 4.2 - Ensure that instances are not configured to use the default service account with full access to all Cloud APIs"
    severity: error
    assert:
      metadata.enable-oslogin-2fa: "TRUE"
    metadata:
      tags: [cis, compute, oslogin, 2fa]
      cis_control: "4.2"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_4_3_block_project_ssh_keys
    resource_type: google_compute_instance
    description: "CIS 4.3 - Ensure 'Block Project-wide SSH keys' is enabled for VM instances"
    severity: error
    assert:
      metadata.block-project-ssh-keys: "true"
    metadata:
      tags: [cis, compute, ssh-keys]
      cis_control: "4.3"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_4_4_no_default_service_account
    resource_type: google_compute_instance
    description: "CIS 4.4 - Ensure that instances are not configured to use the default service account"
    severity: error
    assert:
      service_account.email:
        regex: "^(?!.*-compute@developer\\.gserviceaccount\\.com).*$"
    metadata:
      tags: [cis, compute, service-account]
      cis_control: "4.4"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_4_5_no_full_cloud_api_access
    resource_type: google_compute_instance
    description: "CIS 4.5 - Ensure that instances are not configured to use the default service account with full access to all Cloud APIs"
    severity: error
    assert:
      service_account.scopes:
        regex: "^(?!.*cloud-platform).*$"
    metadata:
      tags: [cis, compute, service-account, api-access]
      cis_control: "4.5"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  # ============================================================================
  # Section 5: Storage
  # ============================================================================

  - id: cis_gcp_5_1_storage_uniform_bucket_access
    resource_type: google_storage_bucket
    description: "CIS 5.1 - Ensure that Cloud Storage bucket is not anonymously or publicly accessible"
    severity: error
    assert:
      uniform_bucket_level_access.enabled: true
    metadata:
      tags: [cis, storage, uniform-access]
      cis_control: "5.1"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_5_2_storage_not_publicly_accessible
    resource_type: google_storage_bucket_iam_binding
    description: "CIS 5.2 - Ensure that Cloud Storage buckets have uniform bucket-level access enabled"
    severity: error
    assert:
      members:
        regex: "^(?!.*allUsers|.*allAuthenticatedUsers).*$"
    metadata:
      tags: [cis, storage, public-access]
      cis_control: "5.2"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_5_3_storage_cmek_encryption
    resource_type: google_storage_bucket
    description: "CIS 5.3 - Ensure that Cloud Storage buckets have encryption enabled using Customer-Managed Encryption Keys (CMEK)"
    severity: warning
    assert:
      encryption.default_kms_key_name: present
    metadata:
      tags: [cis, storage, encryption, cmek]
      cis_control: "5.3"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_5_4_storage_public_access_prevention
    resource_type: google_storage_bucket
    description: "CIS 5.4 - Ensure that Cloud Storage buckets have Public Access Prevention enforced"
    severity: error
    assert:
      public_access_prevention: enforced
    metadata:
      tags: [cis, storage, public-access-prevention]
      cis_control: "5.4"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  # ============================================================================
  # Section 6: Cloud SQL Database Services
  # ============================================================================

  - id: cis_gcp_6_1_sql_require_ssl
    resource_type: google_sql_database_instance
    description: "CIS 6.1 - Ensure that Cloud SQL database instances require all incoming connections to use SSL"
    severity: error
    assert:
      settings.ip_configuration.require_ssl: true
    metadata:
      tags: [cis, sql, ssl]
      cis_control: "6.1"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_6_2_sql_automated_backups
    resource_type: google_sql_database_instance
    description: "CIS 6.2 - Ensure that Cloud SQL database instances have automated backups enabled"
    severity: error
    assert:
      settings.backup_configuration.enabled: true
    metadata:
      tags: [cis, sql, backups]
      cis_control: "6.2"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_6_3_sql_no_public_ip
    resource_type: google_sql_database_instance
    description: "CIS 6.3 - Ensure that Cloud SQL database instances do not have public IPs"
    severity: error
    assert:
      settings.ip_configuration.ipv4_enabled: false
    metadata:
      tags: [cis, sql, public-ip]
      cis_control: "6.3"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform

  - id: cis_gcp_6_4_sql_cmek_encryption
    resource_type: google_sql_database_instance
    description: "CIS 6.4 - Ensure that Cloud SQL database instances are encrypted using Customer-Managed Encryption Keys (CMEK)"
    severity: warning
    assert:
      encryption_key_name: present
    metadata:
      tags: [cis, sql, encryption, cmek]
      cis_control: "6.4"
      references:
        - https://www.cisecurity.org/benchmark/google_cloud_computing_platform
